#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass ctex-article
\begin_preamble
% 如果没有这一句命令，XeTeX会出错，原因参见
% http://bbs.ctex.org/viewthread.php?tid=60547
\DeclareRobustCommand\nobreakspace{\leavevmode\nobreak\ }

%\XeTeXlinebreaklocale "zh"
%\XeTeXlinebreakskip = 0pt plus 1pt
%\usepackage{setspace}
%\onehalfspacing
%\XeTeXinterchartokenstate=1

%\usepackage[utf8]{inputenc}

%\usepackage{polyglossia}
%\setdefaultlanguage[variant=american]{english}
%\setotherlanguage{french}
\end_preamble
\options UTF8,fontset=founder
\use_default_options true
\begin_modules
subequations
\end_modules
\maintain_unincluded_children false
\language chinese-simplified
\language_package default
\inputencoding utf8-plain
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts true
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures false
\graphics default
\default_output_format pdf4
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref true
\pdf_title "PX4 的 ECL EKF2 方程推导"
\pdf_author "Shuyong Chen"
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks true
\pdf_pdfborder false
\pdf_colorlinks false
\pdf_backref false
\pdf_pdfusetitle true
\papersize a4paper
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 25.4mm
\topmargin 30mm
\rightmargin 25.4mm
\bottommargin 30mm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
PX4 的 ECL EKF2 方程推导
\end_layout

\begin_layout Author
Shuyong Chen
\end_layout

\begin_layout Section
简介
\end_layout

\begin_layout Standard
PX4 的 ECL (Estimation and Control Library，估计与控制库) 使用EKF对机体状态进行估计，是一个很成熟很优秀的状态估计模
块。因此在很多项目里面得到了广泛应用。但是，对于 ECL EKF 里面的算法，却很少有文档进行系统的总结，而是散落在各个角落。而总结 ECL EKF
 的算法，也相当困难。如果直接看 C++ 代码，则会被里面复杂庞大的计算式吓到。因为它的算法，以前采用 matlab 描述，后来采用 python
 描述，C++ 代码则是由符号推导系统优化后的展开式。但是，matlab / python 描述的只是算法的主要部分，有很多细节的处理，还需要回头看
 C++ 代码的部分。
\end_layout

\begin_layout Standard
本文试图对 ECL EKF 其中的主要算法做一个梳理。经验和学识不足，难免有错漏。欢迎读者讨论和指正。
\end_layout

\begin_layout Section
EKF简单回顾
\end_layout

\begin_layout Subsection
标准KF系统
\end_layout

\begin_layout Standard
对于一个在状态空间描述的线性或者准线性系统，状态
\begin_inset Formula $k$
\end_inset

从
\begin_inset Formula $k-1$
\end_inset

的状态演变而来，根据
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}_{k}=\boldsymbol{F}_{k}\boldsymbol{x}_{k-1}+\boldsymbol{G}_{k}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}
\]

\end_inset

在这里，
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

是状态转换矩阵。对于简单的问题，这个矩阵可以是一个常数，但是对于大多数实际应用程序，转换矩阵依赖于状态向量的值并每次迭代改变。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

是应用于控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

的控制输入模型。这可用于为系统的已知控制输入建模，例如应用于机器人电机的电流、汽车方向盘的位置等。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{w}_{k}$
\end_inset

是过程噪声，假定从零均值多元正态分布
\begin_inset Formula $\mathcal{N}$
\end_inset

中提取，利用协方差矩阵
\begin_inset Formula $\boldsymbol{Q}_{k}:\boldsymbol{w}_{k}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{Q}_{k}\right)$
\end_inset

。为这个矩阵确定一个合适的值是很棘手的，并且在卡尔曼滤波器的文献中经常被忽视。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在时间“
\begin_inset Formula $k$
\end_inset

”时刻，一个真实状态的观测(或测量) 
\begin_inset Formula $\boldsymbol{z}_{k}$
\end_inset

根据
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{z}_{k}=\boldsymbol{H}_{k}\boldsymbol{x}_{k}+\boldsymbol{v}_{k}
\]

\end_inset

其中
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

是将状态空间映射到观测空间的观测模型。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{v}_{k}$
\end_inset

是假设为零均值高斯协方差的观测噪声
\begin_inset Formula $\boldsymbol{R}_{k}:\boldsymbol{v}_{k}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{R}_{k}\right)$
\end_inset


\end_layout

\begin_layout Standard
注意，
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

将状态向量映射到观测值，而不是相反。这是因为
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

通常是不可逆的，也就是说，它不提供对状态的直接可见性。
\end_layout

\begin_layout Standard
滤波器的状态由两个变量表示：
\end_layout

\begin_layout Itemize
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k}$
\end_inset

，时间
\begin_inset Formula $k$
\end_inset

的后验状态估计，给出时间
\begin_inset Formula $k$
\end_inset

之前(包括该时间)的观测值；
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{P}_{k\mid k}$
\end_inset

，后验误差协方差矩阵(状态估计精度的度量)。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
滤波器分两步工作：
\end_layout

\begin_layout Itemize
一个时间更新(预测)步骤，其中状态和协方差矩阵根据我们对系统动力学和误差特征的了解进行更新，这些特征由
\begin_inset Formula $\boldsymbol{F}$
\end_inset

和
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

矩阵建模。预测步骤不包括观察结果的影响。
\end_layout

\begin_layout Itemize
一个测量更新(校正)步骤，其中包括观测的影响，以完善状态估计和协方差矩阵。这一步需要确定测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}$
\end_inset

矩阵。
\end_layout

\begin_layout Standard
\begin_inset Phantom VPhantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
预测和校正步骤的相应方程式如下：其中符号
\begin_inset Formula $\hat{\mathbf{x}}_{n\mid m}$
\end_inset

表示在给定
\begin_inset Formula $n$
\end_inset

时刻观测直至并包括
\begin_inset Formula $m\leq n$
\end_inset

时刻的
\begin_inset Formula $\mathbf{x}$
\end_inset

的估计值。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
预测
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测(先验)状态估计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k-1}=\boldsymbol{F}_{k}\hat{\boldsymbol{x}}_{k-1\mid k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测(先验)估计协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{Q}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
校正
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
新息或测量残差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-\boldsymbol{H}_{k}\hat{\boldsymbol{x}}_{k\mid k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
新息(或残差)协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最佳卡尔曼增益
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
更新(后验)的状态估计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k}=\hat{\boldsymbol{x}}_{k\mid k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
更新(后验)的协方差
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
卡尔曼滤波实现的主要任务是利用系统动力学模型和测量模型，提出状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

和系统噪声特性，设计过程和测量噪声协方差矩阵。
\end_layout

\begin_layout Subsection
EKF系统
\end_layout

\begin_layout Standard
在扩展卡尔曼滤波中，状态转移和观测模型不需要是状态的线性函数，而可以是可微函数。我们考虑非加性噪声的更一般形式的构想及方程
\begin_inset Formula 
\begin{align*}
\boldsymbol{x}_{k} & =f(\boldsymbol{x}_{k-1},\boldsymbol{u}_{k-1},\boldsymbol{w}_{k-1})\\
\boldsymbol{z}_{k} & {\displaystyle =h(\boldsymbol{x}_{k},\boldsymbol{v}_{k})}
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{w}_{k}$
\end_inset

和
\begin_inset Formula $\boldsymbol{v}_{k}$
\end_inset

是过程噪声和观测噪声，它们分别被假定为协方差为
\begin_inset Formula $\boldsymbol{Q}_{k}$
\end_inset

和
\begin_inset Formula $\boldsymbol{R}_{k}$
\end_inset

的零均值多元高斯噪声。
\begin_inset Formula $\boldsymbol{u}_{k}$
\end_inset

是控制向量。
\end_layout

\begin_layout Standard
函数
\begin_inset Formula $f()$
\end_inset

可用于根据先前估计计算预测状态，类似地，函数
\begin_inset Formula $h()$
\end_inset

可用于根据预测状态计算预测测量。然而，
\begin_inset Formula $f()$
\end_inset

和
\begin_inset Formula $h()$
\end_inset

不能直接应用于协方差，而是用其计算偏导数矩阵(
\begin_inset CommandInset href
LatexCommand href
name "雅可比矩阵"
target "https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant"
literal "false"

\end_inset

)。
\end_layout

\begin_layout Standard
在每个时间步骤，用当前预测状态来评估雅可比矩阵。这些雅可比矩阵可用于卡尔曼滤波方程。该过程基本上是将非线性函数在当前估计值周围使其线性化。
\end_layout

\begin_layout Standard
相比于标准KF系统，EKF的方程则增加了本地线性化的处理，变化后的预测和校正步骤的相应方程式如下：
\end_layout

\begin_layout Itemize

\series bold
预测
\end_layout

\begin_deeper
\begin_layout Itemize
预测(先验)状态估计
\begin_inset Formula 
\begin{equation}
\hat{\boldsymbol{x}}_{k\mid k-1}=f\left(\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k},\boldsymbol{w}_{k}\right)\label{eq:1}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
预测(先验)估计协方差
\begin_inset Formula 
\begin{equation}
\boldsymbol{P}_{k\mid k-1}=\boldsymbol{F}_{k}\boldsymbol{P}_{k-1\mid k-1}\boldsymbol{F}_{k}^{\mathrm{T}}+\boldsymbol{G}_{k}\boldsymbol{Q}_{k}\boldsymbol{G}_{k}^{\mathrm{T}}\label{eq:2}
\end{equation}

\end_inset

其中，状态转移矩阵
\begin_inset Formula $\boldsymbol{F}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{F}_{k}=\left.\dfrac{\partial f}{\partial\boldsymbol{x}}\right|_{\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k}}
\]

\end_inset

控制输入矩阵
\begin_inset Formula $\boldsymbol{G}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{G}_{k}=\left.\dfrac{\partial f}{\partial\boldsymbol{w}}\right|_{\hat{\boldsymbol{x}}_{k-1\mid k-1},\boldsymbol{u}_{k}}
\]

\end_inset


\end_layout

\end_deeper
\begin_layout Itemize

\series bold
校正
\end_layout

\begin_deeper
\begin_layout Itemize
新息或测量残差
\begin_inset Formula 
\[
\tilde{\boldsymbol{y}}_{k}=\boldsymbol{z}_{k}-h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)
\]

\end_inset


\end_layout

\begin_layout Itemize
新息(或残差)协方差
\begin_inset Formula 
\[
\boldsymbol{S}_{k}=\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}
\]

\end_inset

其中，观测矩阵
\begin_inset Formula $\boldsymbol{H}_{k}$
\end_inset

为Jacobian矩阵
\begin_inset Formula 
\[
\boldsymbol{H}_{k}=\left.\dfrac{\partial h}{\partial\boldsymbol{x}}\right|_{\hat{\boldsymbol{x}}_{k\mid k-1}}
\]

\end_inset


\end_layout

\begin_layout Itemize
最佳卡尔曼增益
\begin_inset Formula 
\begin{equation}
\boldsymbol{K}_{k}=\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}\boldsymbol{S}_{k}^{-1}\label{eq:3}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的状态估计
\begin_inset Formula 
\begin{equation}
\hat{\boldsymbol{x}}_{k\mid k}=\hat{\boldsymbol{x}}_{k\mid k-1}+\boldsymbol{K}_{k}\tilde{\mathbf{y}}_{k}\label{eq:4}
\end{equation}

\end_inset


\end_layout

\begin_layout Itemize
更新(后验)的协方差
\begin_inset Formula 
\begin{equation}
\boldsymbol{P}_{k|k}=\left(\boldsymbol{I}-\boldsymbol{K}_{k}\boldsymbol{H}_{k}\right)\boldsymbol{P}_{k|k-1}\label{eq:5}
\end{equation}

\end_inset


\end_layout

\end_deeper
\begin_layout Standard
对于EKF，新增的任务就是计算状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、控制输入矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

和测量矩阵
\begin_inset Formula $\boldsymbol{H}$
\end_inset

的Jacobian矩阵。
\end_layout

\begin_layout Section
ECL EKF 所使用的传感器测量值
\end_layout

\begin_layout Standard
ECL EKF 具有不同的操作模式，以允许不同的传感器测量组合。 滤波器在启动时会检查传感器的最小可行组合，并且在完成初始倾斜，偏航和高度对准之后，进入提供旋转
，垂直速度，垂直位置，IMU 角度偏差和 IMU 速度偏差估计的模式。 
\end_layout

\begin_layout Standard
此模式需要 IMU 数据，偏航数据源(磁力计或外部视觉)和高度数据源。 该数据集是所有EKF运行模式的最低需求数据。 在此基础上可以使用其它传感器数据来估计额外
的状态变量。 
\end_layout

\begin_layout Subsection
IMU 
\end_layout

\begin_layout Standard
与机体固连的三轴惯性测量单元(IMU)，以最小100Hz的频率获取增量角度和增量速度数据 。EKF仅将IMU数据用于状态预测。 在EKF推导中，IMU数据不作为
观测值使用。
\end_layout

\begin_layout Subsection
磁力计 
\end_layout

\begin_layout Standard
需要以最小 5Hz 的速度的三轴机体固连磁力计数据(或外部视觉系统姿势数据)。 磁力计数据可以用于两种方式： 
\end_layout

\begin_layout Itemize
使用倾角估计和磁偏角将磁力计测量值转换为偏航角。 然后将该偏航角用作 EKF 的观察值。 该方法精度较低并且不允许学习机体坐标系场偏移，但是它对于磁场异常和大的
初置陀螺偏差更有鲁棒性。 它是启动期间和在地面时的默认方法。 
\end_layout

\begin_layout Itemize
\begin_inset Formula $XYZ$
\end_inset

磁力计读数用作单独的观察值。 该方法更精确并且允许学习机体坐标系场偏移，但是它假设地球磁场环境只会缓慢变化，并且当存在显着的外部磁场异常时表现较差。
 
\end_layout

\begin_layout Subsection
高度 
\end_layout

\begin_layout Standard
高度数据源
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

来自 GPS，气压计，测距仪或外部视觉设备，需要最小频率为 5Hz。 
\end_layout

\begin_layout Standard
如果不存在这些测量值，EKF 将无法启动。 当检测到这些测量值时，EKF 将初始化状态并完成倾角和偏航对准。 当倾角和偏航对准完成后，EKF 可以转换到其它操作
模式，从而可以使用其它传感器数据。 
\end_layout

\begin_layout Subsection
GPS 
\end_layout

\begin_layout Subsubsection
位置和速度测量 
\end_layout

\begin_layout Standard
GPS 提供位置和速度测量。
\end_layout

\begin_layout Subsubsection
偏航角测量 
\end_layout

\begin_layout Standard
有一些全球定位系统接收器可用来提供一个偏航角测量，以取代磁力计数据的使用。 在存在大型磁场异常的环境中工作时，或在高纬度地区，地球磁场具有很大的倾斜角时，这可能
是一个重要的优势。 
\end_layout

\begin_layout Subsubsection
从 GPS 速度数据获取偏航角 
\end_layout

\begin_layout Standard
EKF在内部运行一个附加的多假设滤波器，它使用多个
\begin_inset Formula $3$
\end_inset

参数状态
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北/东向(N/E)的速度和偏航角
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

的扩展卡尔曼滤波器(EKF)。 然后使用高斯加和滤波器(GSF)合并这些偏航角的估计值。 单个
\begin_inset Formula $3$
\end_inset

参数状态的EKF使用了IMU和GPS水平速度数据(加上可选的空速数据)，而不依赖于事先对偏航角或磁力计测量有任何了解。 这里提供了一个对于主滤波器的偏航角备份，
当起飞后导航丢失，表明磁力计的偏航估计值不好时，它被用于重置主 EKF 滤波器的
\begin_inset Formula $24$
\end_inset

参数状态的中的偏航数据。
\end_layout

\begin_layout Standard
这也使得 ECL 能够在没有任何磁力计、或没有双天线 GPS 接收器的情况下运行，并提供偏航数据，只要起飞后能够进行某种水平的移动，偏航数据就变得可观测。
 一旦机体完成了足够的水平移动，使偏航角可观测， 
\begin_inset Formula $24$
\end_inset

参数的主EKF将使其偏航角与GSF的估计值对准，并开始使用 GPS。 
\end_layout

\begin_layout Subsubsection
双 GPS 接收器 
\end_layout

\begin_layout Standard
GPS接收器提供的数据可以用基于所报告数据的精确度的加权算法混合(如果两者都以相同的速度输出数据并使用相同的精确度，这样做效果最好)。 如果来自接收器的数据丢失
，该机制还提供了自动故障转移，(例如，它允许使用标准 GPS 作为更精确的 RTK 接收器的备份)。
\end_layout

\begin_layout Subsection
测距仪 
\end_layout

\begin_layout Standard
测距仪的对地距离被用于一个单状态滤波器以估计地形相对于高度基准的垂直位置。 
\end_layout

\begin_layout Standard
如果在可用作零高度基准面的平面上操作，则 EKF 也可以直接使用测距仪数据估算高度。
\end_layout

\begin_layout Subsection
空速 
\end_layout

\begin_layout Standard
当存在空速传感器并且飞机类型不是旋翼时，将使用空速数据。 
\end_layout

\begin_layout Subsection
合成侧滑 
\end_layout

\begin_layout Standard
固定翼平台可以利用假定的侧滑观测值为零来改进风速估计，也可以在没有空速传感器的情况下进行风速估计。 
\end_layout

\begin_layout Subsection
基于阻力比力的多旋翼风场估计
\end_layout

\begin_layout Standard
多旋翼平台可以利用沿 X 和 Y 机体轴的空速和阻力之间的关系来估计风速的北/东分量。 
\end_layout

\begin_layout Subsection
光流 
\end_layout

\begin_layout Standard
光流传感器依赖测距仪，提供
\begin_inset Formula $xy$
\end_inset

水平面的速度测量值。 
\end_layout

\begin_layout Subsection
外部视觉系统 
\end_layout

\begin_layout Standard
外部视觉系统提供位置、速度和姿态测量。
\end_layout

\begin_layout Subsection
测量值用途汇总
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="13" columns="6">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测量值
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
符号
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
单位
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
传感器
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最小频率
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
用途
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
角速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
加速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{a}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s^{2}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
地球磁场
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{gauss}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
磁力计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
海拔高度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $H_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/气压计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
距地高度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $H_{meas}^{agl}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测距仪/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
速度测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{V}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/(光流+测距仪)/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
位置测量
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
偏航角
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\psi_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2-GPS/磁力计/外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
磁偏角
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS/用户设置
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
等效空速
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $V_{meas}^{TAS}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
空速传感器
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
合成侧滑
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{beta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{rad}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
虚拟
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
阻力比力
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{drag}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
虚拟
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
根据前面的描述可知：
\end_layout

\begin_layout Itemize
ECL EKF2 最小传感器集合为：IMU，偏航数据源和高度数据源。
\end_layout

\begin_layout Itemize
机体的姿态变化由角速度驱动，速度变化由加速度驱动，这两者由IMU提供。
\end_layout

\begin_layout Itemize
偏航测量值校正了在
\begin_inset Formula $xy$
\end_inset

水平面上姿态，高度测量值校正了
\begin_inset Formula $z$
\end_inset

轴上的位置。有了这两者才能执行最基本的自动导航功能。
\end_layout

\begin_layout Itemize
磁力计是最适合校正姿态的传感器，也是最容易受到外界影响的传感器。气压计是最常见的测量高度的设备，因为成本低廉。
\end_layout

\begin_layout Itemize
GPS是多面手，可以提供很多测量数据。所以如果不是成本受限，GPS应该是无人机的标配设备。注意，GPS的采样速率比较慢，在ECL系统中假设其最小频率为2Hz。
\end_layout

\begin_layout Itemize
光流设备和外部视觉设备是最时髦的设备。但是应用效果还有待观察。
\end_layout

\begin_layout Itemize
ECL EKF2 做了很多数据质量检测判断。因此外接传感器的种类越多，则容错率就越高。
\end_layout

\begin_layout Section
ECL EKF 状态向量
\end_layout

\begin_layout Subsection
状态向量
\end_layout

\begin_layout Standard
估计和控制库(ECL)使用扩展卡尔曼滤波算法(EKF)来处理传感器的测量信息，并提供如下状态向量的估计值： 
\end_layout

\begin_layout Itemize
四元数定义从北，东，地(NED)局部地球坐标系到
\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

机体坐标系的旋转 
\end_layout

\begin_layout Itemize
IMU 的速度
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北，东，地(NED) 
\begin_inset Formula $(m/s)$
\end_inset


\end_layout

\begin_layout Itemize
IMU 的位置
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北，东，地(NED) 
\begin_inset Formula $(m)$
\end_inset


\end_layout

\begin_layout Itemize
IMU 增量角度偏差估计
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset


\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

 
\begin_inset Formula $(\mathrm{rad})$
\end_inset


\end_layout

\begin_layout Itemize
IMU 加速度偏差估计
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset


\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

 
\begin_inset Formula $(m/s^{2})$
\end_inset


\end_layout

\begin_layout Itemize
地球磁场分量
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北，东，地(NED) 
\begin_inset Formula $(\mathrm{gauss})$
\end_inset


\end_layout

\begin_layout Itemize
飞行器机体坐标系磁场偏差
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset


\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

 
\begin_inset Formula $(\mathrm{gauss})$
\end_inset


\end_layout

\begin_layout Itemize
风速
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

北, 东(NE) 
\begin_inset Formula $(m/s)$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
24个状态的向量定义为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}=\left[\begin{array}{cccccccc}
q^{\mathrm{T}} & \boldsymbol{V}_{NED}^{\mathrm{T}} & \boldsymbol{P}_{NED}^{\mathrm{T}} & \boldsymbol{\Delta\theta}_{b}^{\mathrm{T}} & \boldsymbol{\Delta a}_{b}^{\mathrm{T}} & \boldsymbol{M}_{I}^{\mathrm{T}} & \boldsymbol{M}_{B}^{\mathrm{T}} & \boldsymbol{V}_{wind}^{\mathrm{T}}\end{array}\right]^{\mathrm{T}}
\]

\end_inset

其中，姿态四元数
\begin_inset Formula $q$
\end_inset

，对外比较时称为
\begin_inset Formula $q_{ekf}$
\end_inset

，用于定义
\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

机体坐标系相对于 NED 导航
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
坐标系
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
的角度位置，我们用
\begin_inset Formula $\boldsymbol{q}$
\end_inset

表示其向量部分，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q=\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]=\left[\begin{array}{c}
q_{0}\\
\boldsymbol{q}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

表示机体在 NED 坐标系中的速度，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{V}_{NED}=\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

表示机体在 NED 坐标系中的位置，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{P}_{NED}=\left[\begin{array}{c}
P_{N}\\
P_{E}\\
P_{D}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{\Delta\theta}_{b}$
\end_inset

表示在
\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

机体坐标系的角速度偏差(bias)，乘以
\begin_inset Formula $\Delta t$
\end_inset

后即为一个周期中的增量角度偏差，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{\Delta\theta}_{b}=\left[\begin{array}{c}
\Delta\theta_{b_{X}}\\
\Delta\theta_{b_{Y}}\\
\Delta\theta_{b_{Z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{\Delta a}_{b}$
\end_inset

表示在
\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

机体坐标系的加速度偏差(bias)，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{\Delta a}_{b}=\left[\begin{array}{c}
\Delta a_{b_{X}}\\
\Delta a_{b_{Y}}\\
\Delta a_{b_{Z}}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

表示在 NED 坐标系的地球磁场向量，简称地磁，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{M}_{I}=\left[\begin{array}{c}
M_{N}\\
M_{E}\\
M_{D}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{M}_{B}$
\end_inset

表示在
\begin_inset Formula $X$
\end_inset

，
\begin_inset Formula $Y$
\end_inset

，
\begin_inset Formula $Z$
\end_inset

机体坐标系的磁场偏差(bias)，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{M}_{B}=\left[\begin{array}{c}
M_{X}\\
M_{Y}\\
M_{Z}
\end{array}\right]
\]

\end_inset


\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

表示在 NED 坐标系的在北东 (NE) 方向上的风速，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{V}_{wind}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
估计算法对外常用的数据输出有：
\end_layout

\begin_layout Itemize
姿态输出。 
\end_layout

\begin_layout Itemize
速度输出。 
\end_layout

\begin_layout Itemize
位置输出。 
\end_layout

\begin_layout Itemize
风速输出。 
\end_layout

\begin_layout Standard
注意：输出的数据项与EKF状态向量中的数据不完全相同，而是经过输出互补滤波器校正后的数据，具体参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:输出互补滤波器"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的讨论。
\end_layout

\begin_layout Subsection
旋转矩阵
\end_layout

\begin_layout Standard
从机体坐标系到导航坐标系的旋转矩阵根据姿态四元数
\begin_inset Formula $q$
\end_inset

由以下方程给出：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\left[T\right]_{B}^{N} & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\\
 & =\left[\begin{array}{ccc}
1-2q_{2}^{2}-2q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & 1-2q_{1}^{2}-2q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & 1-2q_{1}^{2}-2q_{2}^{2}
\end{array}\right]
\end{align*}

\end_inset

上面上下两个方程在数学上完全相等，但是因为第二个方程在对角线元素上少两个变量，因此在符号推导系统中产生更简单且更数值稳定的计算式，因此 ECL
 EKF2 选择了第二个方程。
\end_layout

\begin_layout Standard
如果需要从导航坐标系到机体坐标系的旋转，将使用转置，并用
\begin_inset Formula $\left[T\right]_{N}^{B}$
\end_inset

表示：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left[T\right]_{N}^{B}=\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}=\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Section
ECL EKF 时间更新方程
\begin_inset CommandInset label
LatexCommand label
name "sec:ECL-EKF-时间更新方程"

\end_inset


\end_layout

\begin_layout Standard
IMU传感器定时采样，采样间隔时间为
\begin_inset Formula $\Delta t$
\end_inset

，获得
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
角速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

和
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
加速度
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula $\boldsymbol{a}$
\end_inset

数据。所以我们得到增量角度的测量值为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta\theta}_{meas}=\boldsymbol{\omega}\cdot\Delta t\label{eq:6}
\end{equation}

\end_inset

还有增量速度的测量值为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta V}_{meas}=\boldsymbol{a}\cdot\Delta t\label{eq:7}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
已知陀螺仪的测量方差为
\begin_inset Formula $\boldsymbol{\sigma}_{gyro}^{2}$
\end_inset

，加速计的测量方差为
\begin_inset Formula $\boldsymbol{\sigma}_{accel}^{2}$
\end_inset

。所以我们有增量角度的测量方差为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}=\boldsymbol{\sigma}_{gyro}^{2}\cdot\Delta t^{2}\label{eq:8}
\end{equation}

\end_inset

还有加速度的测量方差为
\begin_inset Formula 
\begin{equation}
\boldsymbol{\sigma}_{\boldsymbol{a}}^{2}=\boldsymbol{\sigma}_{accel}^{2}\cdot\Delta t^{2}\label{eq:9}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测量值
\begin_inset Formula $\boldsymbol{\Delta\theta}_{meas}$
\end_inset

和增量角度偏差
\begin_inset Formula $\boldsymbol{\Delta\theta}_{b}$
\end_inset

计算出真增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{truth}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta\theta}_{truth}=\boldsymbol{\Delta\theta}_{meas}-\boldsymbol{\Delta\theta}_{b}\label{eq:10}
\end{equation}

\end_inset

增量四元数
\begin_inset Formula $\Delta q$
\end_inset

定义了从第
\begin_inset Formula $k$
\end_inset

时刻到第
\begin_inset Formula $k+1$
\end_inset

时刻四元数的旋转，使用小角度近似从真增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{truth}$
\end_inset

计算(惯性导航采用其它精确方法计算)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\Delta q=\left[\begin{array}{c}
1\\
\dfrac{\boldsymbol{\Delta\theta}_{truth}}{2}
\end{array}\right]\label{eq:11}
\end{equation}

\end_inset

从
\begin_inset Formula $k$
\end_inset

时刻到
\begin_inset Formula $k+1$
\end_inset

时刻，四元数乘积规则用于将姿态四元数的状态向前旋转增量四元数
\begin_inset Formula $\Delta q$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
q_{k+1} & =q_{k}\cdot\Delta q\\
\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]_{k+1} & =\left[\begin{array}{c}
q_{0}\Delta q_{0}-q_{1}\Delta q_{1}-q_{2}\Delta q_{2}-q_{3}\Delta q_{3}\\
q_{1}\Delta q_{0}+q_{0}\Delta q_{1}-q_{3}\Delta q_{2}+q_{2}\Delta q_{3}\\
q_{2}\Delta q_{0}+q_{3}\Delta q_{1}+q_{0}\Delta q_{2}-q_{1}\Delta q_{3}\\
q_{3}\Delta q_{0}-q_{2}\Delta q_{1}+q_{1}\Delta q_{2}+q_{0}\Delta q_{3}
\end{array}\right]
\end{array}\label{eq:12}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
根据IMU测量值
\begin_inset Formula $\boldsymbol{\Delta V}_{meas}$
\end_inset

和加速度偏差
\begin_inset Formula $\boldsymbol{\Delta a}_{b}$
\end_inset

计算出真增量速度
\begin_inset Formula $\boldsymbol{\Delta V}_{truth}$
\end_inset

：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\boldsymbol{\Delta V}_{truth}=\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta a}_{b}\cdot\Delta t\label{eq:13}
\end{equation}

\end_inset

从
\begin_inset Formula $k$
\end_inset

时刻到
\begin_inset Formula $k+1$
\end_inset

时刻，将真增量速度向量
\begin_inset Formula $\boldsymbol{\Delta V}_{truth}$
\end_inset

从机体坐标系旋转到地球坐标系，并减去重力，计算速度状态变化
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\left(\boldsymbol{V}_{NED}\right)_{k+1} & =\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\\
\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k+1} & =\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\left[\begin{array}{c}
0\\
0\\
g
\end{array}\right]\cdot\Delta t
\end{array}\label{eq:14}
\end{equation}

\end_inset

使用更精确的梯形积分方法更新位置状态
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\begin{array}{rl}
\left(\boldsymbol{P}_{NED}\right)_{k+1} & =\left(\boldsymbol{P}_{NED}\right)_{k}+\dfrac{1}{2}\left(\left(\boldsymbol{V}_{NED}\right)_{k+1}+\left(\boldsymbol{V}_{NED}\right)_{k}\right)\cdot\Delta t\\
\left[\begin{array}{c}
P_{N}\\
P_{E}\\
P_{D}
\end{array}\right]_{k+1} & =\left[\begin{array}{c}
P_{N}\\
P_{E}\\
P_{D}
\end{array}\right]_{k}+\dfrac{1}{2}\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k+1}+\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]_{k}\right)\cdot\Delta t
\end{array}\label{eq:15}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
IMU传感器的偏差、磁场和风速状态均采用静态过程模型：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\begin{array}{c}
\boldsymbol{\Delta\theta}_{b}\\
\boldsymbol{\Delta a}_{b}\\
\boldsymbol{M}_{I}\\
\boldsymbol{M}_{B}\\
\boldsymbol{V}_{wind}
\end{array}\right]_{k+1}=\left[\begin{array}{c}
\boldsymbol{\Delta\theta}_{b}\\
\boldsymbol{\Delta a}_{b}\\
\boldsymbol{M}_{I}\\
\boldsymbol{M}_{B}\\
\boldsymbol{V}_{wind}
\end{array}\right]_{k}\label{eq:16}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
自此，已经完成预测(先验)状态估计的计算。接下来要进行预测(先验)估计协方差的计算。方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:1"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可表示为：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{x}_{k+1}=\boldsymbol{F}\boldsymbol{x}_{k}+\boldsymbol{G}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}
\]

\end_inset

其中，控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

，也称干扰(disturbance)向量，为
\begin_inset Formula 
\[
\boldsymbol{u}=\left[\begin{array}{c}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{a}}^{2}
\end{array}\right]
\]

\end_inset

它是由惯性测量单元(IMU)的增量角度和加速度的测量方差，
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}$
\end_inset

和
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{a}}^{2}$
\end_inset

所定义。在状态变量中消除偏差影响后，假设惯性解中的误差增长是由增量角度和加速度中的“噪声”驱动的。这种方案是可行的，因为在状态方程中考虑了传感器偏差，将其消除后
即为零偏差，并且因为该位姿估计系统是基于运动方程进行设计，所以惯性解中的误差增长，即状态方程中的控制项，则由IMU的“噪声”驱动。方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

)中的矩阵
\begin_inset Formula $\boldsymbol{Q}$
\end_inset

为测量方差元素构成的对角线矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{Q}_{6\times6} & =\mathrm{diag}\left(\left[\begin{array}{c}
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{a}}^{2}
\end{array}\right]\right)
\end{align*}

\end_inset

并且
\begin_inset Formula $\boldsymbol{G}\boldsymbol{Q}\boldsymbol{G}^{\mathrm{T}}$
\end_inset

又被称为状态误差矩阵。
\end_layout

\begin_layout Standard
根据前面推导的第 
\begin_inset Formula $k+1$
\end_inset

 时刻的状态向量方程 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:15"
plural "false"
caps "false"
noprefix "false"

\end_inset

) 和 (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:16"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，分别对第 
\begin_inset Formula $k$
\end_inset

 时刻的状态 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\boldsymbol{x}_{k}$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\xout default
\uuline default
\uwave default
\noun default
\color inherit
 求 Jacobian 可得状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

、控制(干扰)影响矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

。
\end_layout

\begin_layout Standard
状态转换矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

是一个
\begin_inset Formula $24\times24$
\end_inset

的稀疏矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{F} & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\boldsymbol{x}_{k}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{F}_{q_{k}}^{q_{k+1}} & 0_{4\times3} & 0_{4\times3} & \boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}} & 0_{4\times3} & 0_{4\times3} & 0_{4\times3} & 0_{4\times2}\\
\boldsymbol{F}_{q_{k}}^{V_{k+1}} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{F}_{\Delta a_{b}^{k}}^{V_{k+1}} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & \boldsymbol{F}_{V_{k}}^{P_{k+1}} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{3\times4} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{I}_{3\times3} & 0_{3\times2}\\
0_{2\times4} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & \boldsymbol{I}_{2\times2}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{q_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{V_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{V_{k}}^{P_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}}$
\end_inset

、
\begin_inset Formula $\boldsymbol{F}_{\Delta a_{b}^{k}}^{V_{k+1}}$
\end_inset

这5个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{q_{k+1}}$
\end_inset

为关于四元数的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的旋转相对于
\begin_inset Formula $k$
\end_inset

时刻的 Jacobian ，大小为
\begin_inset Formula $4\times4$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{q_{k}}^{q_{k+1}} & =\dfrac{\partial q_{k+1}}{\partial q_{k}}\\
 & =\dfrac{\partial\left(q_{k}\cdot\Delta q\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(q_{k}+q_{k}\cdot\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{truth}}{2}
\end{array}\right]\right)}{\partial q_{k}}\\
 & =\boldsymbol{I}_{4\times4}+M\left(\dfrac{\boldsymbol{\Delta\theta}_{truth}}{2}\right)
\end{align*}

\end_inset

其中，
\begin_inset Formula $M\left(\boldsymbol{\theta}\right)$
\end_inset

为
\begin_inset Formula $4\times4$
\end_inset

斜对称矩阵
\begin_inset Formula 
\[
M\left(\boldsymbol{\theta}\right)=\left[\begin{array}{cccc}
0 & -\theta_{x} & -\theta_{y} & -\theta_{z}\\
\theta_{x} & 0 & \theta_{z} & -\theta_{y}\\
\theta_{y} & -\theta_{z} & 0 & \theta_{x}\\
\theta_{z} & \theta_{y} & -\theta_{x} & 0
\end{array}\right]
\]

\end_inset

该矩阵在四元数教材里又被称为
\begin_inset Formula $\boldsymbol{\Omega}$
\end_inset

矩阵，出现在向量和四元数的乘积中
\begin_inset Formula 
\[
\boldsymbol{\Omega}\left(\boldsymbol{\theta}\right)=\left[\begin{array}{cc}
0 & -\boldsymbol{\theta}^{\mathrm{T}}\\
\boldsymbol{\theta} & -\left[\boldsymbol{\theta}\times\right]
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{q_{k}}^{V_{k+1}}$
\end_inset

为速度关于四元数的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的速度相对于
\begin_inset Formula $k$
\end_inset

时刻的旋转的 Jacobian ，大小为
\begin_inset Formula $3\times4$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{q_{k}}^{V_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right) & 2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right) & 2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
\Delta V_{X}\\
\Delta V_{Y}\\
\Delta V_{Z}
\end{array}\right]\right)}{\partial q_{k}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\Delta V_{X}+2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right)\Delta V_{Y}+2\left(q_{1}\cdot q_{3}+q_{0}\cdot q_{2}\right)\Delta V_{Z}\\
2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right)\Delta V_{X}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\Delta V_{Y}+2\left(q_{2}\cdot q_{3}-q_{0}\cdot q_{1}\right)\Delta V_{Z}\\
2\left(q_{1}\cdot q_{3}-q_{0}\cdot q_{2}\right)\Delta V_{X}+2\left(q_{2}\cdot q_{3}+q_{0}\cdot q_{1}\right)\Delta V_{Y}+\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)\Delta V_{Z}
\end{array}\right]\right)}{\partial q_{k}}\\
 & \tiny=2\left[\begin{array}{cccc}
q_{0}\Delta V_{X}-q_{3}\Delta V_{Y}+q_{2}\Delta V_{Z} & q_{1}\Delta V_{X}+q_{2}\Delta V_{Y}+q_{3}\Delta V_{Z} & -q_{2}\Delta V_{X}+q_{1}\Delta V_{Y}+q_{0}\Delta V_{Z} & -q_{3}\Delta V_{X}-q_{0}\Delta V_{Y}+q_{1}\Delta V_{Z}\\
q_{3}\Delta V_{X}+q_{0}\Delta V_{Y}-q_{1}\Delta V_{Z} & q_{2}\Delta V_{X}-q_{1}\Delta V_{Y}-q_{0}\Delta V_{Z} & q_{1}\Delta V_{X}+q_{2}\Delta V_{Y}+q_{3}\Delta V_{Z} & q_{0}\Delta V_{X}-q_{3}\Delta V_{Y}+q_{2}\Delta V_{Z}\\
-q_{2}\Delta V_{X}+q_{1}\Delta V_{Y}+q_{0}\Delta V_{Z} & q_{3}\Delta V_{X}+q_{0}\Delta V_{Y}-q_{1}\Delta V_{Z} & -q_{0}\Delta V_{X}+q_{3}\Delta V_{Y}-q_{2}\Delta V_{Z} & q_{1}\Delta V_{X}+q_{2}\Delta V_{Y}+q_{3}\Delta V_{Z}
\end{array}\right]\\
 & =2\left[\begin{array}{c}
\left(\Phi_{1}\cdot\boldsymbol{\Delta V}_{truth}\right)^{\mathrm{T}}\\
\left(\Phi_{2}\cdot\boldsymbol{\Delta V}_{truth}\right)^{\mathrm{T}}\\
\left(\Phi_{3}\cdot\boldsymbol{\Delta V}_{truth}\right)^{\mathrm{T}}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula 
\[
\Phi_{1}=\left[\begin{array}{ccc}
q_{0} & -q_{3} & q_{2}\\
q_{1} & q_{2} & q_{3}\\
-q_{2} & q_{1} & q_{0}\\
-q_{3} & -q_{0} & q_{1}
\end{array}\right],\quad\Phi_{2}=\left[\begin{array}{ccc}
q_{3} & q_{0} & -q_{1}\\
q_{2} & -q_{1} & -q_{0}\\
q_{1} & q_{2} & q_{3}\\
q_{0} & -q_{3} & q_{2}
\end{array}\right],\quad\Phi_{3}=\left[\begin{array}{ccc}
-q_{2} & q_{1} & q_{0}\\
q_{3} & q_{0} & -q_{1}\\
-q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{V_{k}}^{P_{k+1}}$
\end_inset

为位置关于速度的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的位置相对于
\begin_inset Formula $k$
\end_inset

时刻的速度的 Jacobian，大小为
\begin_inset Formula $3\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:15"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{V_{k}}^{P_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{P}_{NED}\right)_{k}+\left(\boldsymbol{V}_{NED}\right)_{k}\cdot\Delta t\right)}{\partial\left(\boldsymbol{V}_{NED}\right)_{k}}\\
 & =\boldsymbol{I}_{3\times3}\cdot\Delta t
\end{align*}

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}}$
\end_inset

为四元数关于增量角度偏差的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的旋转相对于陀螺仪
\begin_inset Formula $k$
\end_inset

时刻增量角度偏差的 Jacobian ，大小为
\begin_inset Formula $4\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:10"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\Delta\theta_{b}^{k}}^{q_{k+1}} & =\dfrac{\partial\left(q_{k}\cdot\Delta q\right)}{\partial\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}\\
 & =\dfrac{\partial\left(q_{k}+q_{k}\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{meas}}{2}
\end{array}\right]+q_{k}\left[\begin{array}{c}
0\\
\dfrac{-\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}{2}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}\\
 & =\dfrac{\partial\left(-\dfrac{1}{2}\left[\begin{array}{c}
-q_{1}\Delta\theta_{b_{X}}-q_{2}\Delta\theta_{b_{Y}}-q_{3}\Delta\theta_{b_{Z}}\\
+q_{0}\Delta\theta_{b_{X}}-q_{3}\Delta\theta_{b_{Y}}+q_{2}\Delta\theta_{b_{Z}}\\
+q_{3}\Delta\theta_{b_{X}}+q_{0}\Delta\theta_{b_{Y}}-q_{1}\Delta\theta_{b_{Z}}\\
-q_{2}\Delta\theta_{b_{X}}+q_{1}\Delta\theta_{b_{Y}}+q_{0}\Delta\theta_{b_{Z}}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}\\
 & =-\dfrac{1}{2}\left[\begin{array}{ccc}
-q_{1} & -q_{2} & -q_{3}\\
+q_{0} & -q_{3} & +q_{2}\\
+q_{3} & +q_{0} & -q_{1}\\
-q_{2} & +q_{1} & +q_{0}
\end{array}\right]\\
 & =-\dfrac{1}{2}\boldsymbol{\Xi}\left(q\right)
\end{align*}

\end_inset

矩阵
\begin_inset Formula $\boldsymbol{\Xi}\left(q\right)$
\end_inset

出现在四元数与向量的乘法中
\begin_inset Formula 
\[
\boldsymbol{\Xi}\left(q\right)=\left[\begin{array}{c}
-\boldsymbol{q}^{\mathrm{T}}\\
q_{0}\boldsymbol{I}_{3\times3}+\left[\boldsymbol{q}\times\right]
\end{array}\right]
\]

\end_inset

矩阵
\begin_inset Formula $\boldsymbol{\Xi}$
\end_inset

和
\begin_inset Formula $\boldsymbol{\Omega}$
\end_inset

之间的关系为
\begin_inset Formula 
\[
\boldsymbol{\Omega}\left(\boldsymbol{\theta}\right)q=\boldsymbol{\Xi}\left(q\right)\boldsymbol{\theta}
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{F}_{\Delta a_{b}^{k}}^{V_{k+1}}$
\end_inset

为速度关于加速度偏差的状态转移矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的速度相对于加速度计
\begin_inset Formula $k$
\end_inset

时刻加速度偏差的 Jacobian ，大小为
\begin_inset Formula $3\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:13"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{F}_{\Delta a_{b}^{k}}^{V_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta a}_{b}\right)_{k}}\\
 & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\left(\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta a}_{b}\cdot\Delta t\right)+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta a}_{b}\right)_{k}}\\
 & =-\left[T\right]_{B}^{N}\cdot\Delta t
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
控制(干扰)影响矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

需要对增量角度和增量速度的测量值求偏导，因为测量值中包含有增量角度噪声和加速度噪声。它是一个
\begin_inset Formula $24\times6$
\end_inset

的稀疏矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{G} & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\boldsymbol{w}_{k}}\\
 & =\dfrac{\partial\boldsymbol{x}_{k+1}}{\partial\left(\boldsymbol{\Delta\theta}_{meas},\boldsymbol{\Delta V}_{meas}\right)_{k}}\\
 & =\left[\begin{array}{cc}
\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}} & 0_{4\times3}\\
0_{3\times3} & \boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{3\times3} & 0_{3\times3}\\
0_{2\times3} & 0_{2\times3}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}}$
\end_inset

和
\begin_inset Formula $\boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}}$
\end_inset

这2个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}}$
\end_inset

为姿态四元数关于增量角度噪声的控制输入矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的旋转相对于陀螺仪
\begin_inset Formula $k$
\end_inset

时刻增量角度噪声的协方差矩阵，大小为
\begin_inset Formula $4\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:10"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{G}_{\Delta\theta_{meas}^{k}}^{q_{k+1}} & =\dfrac{\partial\left(q_{k}\cdot\Delta q\right)}{\partial\left(\boldsymbol{\Delta\theta}_{meas}\right)_{k}}\\
 & =\dfrac{\partial\left(q_{k}+q_{k}\left[\begin{array}{c}
0\\
\dfrac{\boldsymbol{\Delta\theta}_{meas}}{2}
\end{array}\right]+q_{k}\left[\begin{array}{c}
0\\
\dfrac{-\left(\boldsymbol{\Delta\theta}_{b}\right)_{k}}{2}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{meas}\right)_{k}}\\
 & =\dfrac{\partial\left(\dfrac{1}{2}\left[\begin{array}{c}
-q_{1}\Delta\theta_{meas_{X}}-q_{2}\Delta\theta_{meas_{Y}}-q_{3}\Delta\theta_{meas_{Z}}\\
+q_{0}\Delta\theta_{meas_{X}}-q_{3}\Delta\theta_{meas_{Y}}+q_{2}\Delta\theta_{meas_{Z}}\\
+q_{3}\Delta\theta_{meas_{X}}+q_{0}\Delta\theta_{meas_{Y}}-q_{1}\Delta\theta_{meas_{Z}}\\
-q_{2}\Delta\theta_{meas_{X}}+q_{1}\Delta\theta_{meas_{Y}}+q_{0}\Delta\theta_{meas_{Z}}
\end{array}\right]\right)}{\partial\left(\boldsymbol{\Delta\theta}_{meas}\right)_{k}}\\
 & =\dfrac{1}{2}\left[\begin{array}{ccc}
-q_{1} & -q_{2} & -q_{3}\\
+q_{0} & -q_{3} & +q_{2}\\
+q_{3} & +q_{0} & -q_{1}\\
-q_{2} & +q_{1} & +q_{0}
\end{array}\right]\\
 & =\dfrac{1}{2}\boldsymbol{\Xi}\left(q\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}}$
\end_inset

为速度关于加速度噪声的控制输入矩阵，即
\begin_inset Formula $k+1$
\end_inset

时刻的速度相对于加速度计
\begin_inset Formula $k$
\end_inset

时刻加速度噪声的协方差矩阵，大小为
\begin_inset Formula $3\times3$
\end_inset

，根据方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:13"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:14"
plural "false"
caps "false"
noprefix "false"

\end_inset

)可得：
\begin_inset Formula 
\begin{align*}
\boldsymbol{G}_{\Delta V_{meas}^{k}}^{V_{k+1}} & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\boldsymbol{\Delta V}_{truth}+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta V}_{meas}\right)_{k}}\\
 & =\dfrac{\partial\left(\left(\boldsymbol{V}_{NED}\right)_{k}+\left[T\right]_{B}^{N}\cdot\left(\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta a}_{b}\cdot\Delta t\right)+\boldsymbol{g}_{D}\cdot\Delta t\right)}{\partial\left(\boldsymbol{\Delta V}_{meas}\right)_{k}}\\
 & =\left[T\right]_{B}^{N}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
最后，为方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

)中的协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

增加过程噪声
\begin_inset Formula $\boldsymbol{w}$
\end_inset

。那些运动学的状态(姿态
\begin_inset Formula $q$
\end_inset

、速度
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

和位置
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

)，它们的误差增长分别由IMU噪声方差控制，已经在前面的方程中加入。对于其它静态过程模型的状态，则用静态过程模型构造这些状态的过程噪声方差对角线，
\begin_inset Formula $24\times24$
\end_inset

的过程噪声矩阵为
\begin_inset Formula 
\[
\boldsymbol{w}=\mathrm{diag}\left(\left[\begin{array}{c}
0_{4\times1}\\
0_{3\times1}\\
0_{3\times1}\\
\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{a}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{M}_{I}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{M}_{B}}^{2}\\
\boldsymbol{\sigma}_{\boldsymbol{V}_{wind}}^{2}
\end{array}\right]\right)
\]

\end_inset

其中，增量角度偏差和加速度偏差的过程噪声方差，同样采用增量角度的测量方差
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta\theta}}^{2}$
\end_inset

和加速度的测量方差
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{a}}^{2}$
\end_inset

。地球磁场
\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

，机体磁场偏差
\begin_inset Formula $\boldsymbol{M}_{B}$
\end_inset

和风速
\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

的过程噪声方差，
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{M}_{I}}^{2}$
\end_inset

、
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{M}_{B}}^{2}$
\end_inset

和
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{V}_{wind}}^{2}$
\end_inset

，可由用户自行设定。
\end_layout

\begin_layout Standard
至此，已经完成预测(先验)估计协方差的计算。
\end_layout

\begin_layout Section
ECL EKF 测量更新方程
\begin_inset CommandInset label
LatexCommand label
name "sec:ECL-EKF-测量更新方程"

\end_inset


\end_layout

\begin_layout Standard
ECL EKF 算法最大的特点就是使用传感器组合进行状态估计。这样的好处是系统具有很高的容错性，不管发生什么异常，总是有方法进行数据校正。但是带来的问题就是算法
复杂，代码分支繁多，很难把握，更难调试。
\end_layout

\begin_layout Standard
该算法的第二个特点是将
\begin_inset Formula $xy$
\end_inset

水平面和
\begin_inset Formula $z$
\end_inset

轴方向的高度分离估计。一个原因是因为GPS的高度数据误差太大，而高度数据源又很多，这样处理可以提升高度数据的精度，并且当GPS类的全局定位数据缺失时，高度数据是
可信的，只是
\begin_inset Formula $xy$
\end_inset

水平面定位进入惯性航位推算模式。
\end_layout

\begin_layout Standard
该算法的第三个特点是对所有的观测向量都是拆分为一维一维的数据进行校正。这是一种优化算法，通过使用更多的运算步骤换取使用更少的栈空间。这对于MCU这种内存紧张的环
境有好处。
\end_layout

\begin_layout Subsection
磁力计融合
\begin_inset CommandInset label
LatexCommand label
name "subsec:磁力计融合"

\end_inset


\end_layout

\begin_layout Standard
磁力计更新分为两种情况：
\end_layout

\begin_layout Enumerate
用三轴磁力计的数据作为三维观测(3D Fusion)。
\end_layout

\begin_layout Enumerate
直接将磁力计的数据转换为磁偏角作为一维观测(Heading Fusion)。
\end_layout

\begin_layout Standard
第二种方法对于磁场异常和大的初置陀螺偏差更有鲁棒性。 它是启动期间和在地面时的默认方法。第一种方法是通常使用的方法，它有更好的精度，但是更容易受到地球局部磁场畸
变的影响，当存在显著的外部磁场异常时表现较差。
\end_layout

\begin_layout Standard
三轴磁场的更新根据是否有磁偏角的约束分为两个阶段。在初始化或差工况时，先进行无磁偏角约束的磁力计融合阶段，再进行有磁偏角约束的融合阶段；好工况时则相反。下面2个
小节分别进行这两个阶段的方程推导。第3小节进行一维观测的方程推导。
\end_layout

\begin_layout Subsubsection
磁力计测量融合方程
\end_layout

\begin_layout Standard
无磁偏角约束的三轴磁场的融合阶段，不考虑磁偏角
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset

，也就是假设地球的地理南北极与地磁南北极重合。
\end_layout

\begin_layout Standard
由磁力计测量的机体磁场强度为
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset

。已知磁力计的测量方差为
\begin_inset Formula $\boldsymbol{R}_{MAG}$
\end_inset

。
\end_layout

\begin_layout Standard
预测的机体磁场强度为
\begin_inset Formula $\boldsymbol{M}_{pred}$
\end_inset

，由状态向量中的地球磁场
\begin_inset Formula $\boldsymbol{M}_{I}$
\end_inset

旋转到机体轴得到：
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{pred} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\\
\left[\begin{array}{c}
M_{pred_{X}}\\
M_{pred_{Y}}\\
M_{pred_{Z}}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
M_{N}\\
M_{E}\\
M_{D}
\end{array}\right]+\left[\begin{array}{c}
M_{X}\\
M_{Y}\\
M_{Z}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
磁场观测矩阵
\begin_inset Formula $\boldsymbol{H}_{MAG}$
\end_inset

是一个
\begin_inset Formula $3\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{MAG} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{H}_{M_{I}} & \boldsymbol{H}_{M_{B}} & 0_{3\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}$
\end_inset

、
\begin_inset Formula $\boldsymbol{H}_{M_{I}}$
\end_inset

和
\begin_inset Formula $\boldsymbol{H}_{M_{B}}$
\end_inset

这3个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{q}$
\end_inset

为磁力计的观测相对于姿态四元数的观测矩阵，即磁场测量值相对于旋转的 Jacobian ，大小为
\begin_inset Formula $3\times4$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{q} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial q}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\right)}{\partial q}\\
 & =\dfrac{\partial\left(\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
M_{N}\\
M_{E}\\
M_{D}
\end{array}\right]\right)}{\partial q}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)M_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)M_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)M_{D}\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right)M_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)M_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)M_{D}\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right)M_{N}+2\left(q_{2}q_{3}-q_{0}q_{1}\right)M_{E}+\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)M_{D}
\end{array}\right]\right)}{\partial q}\\
 & \tiny=2\left[\begin{array}{cccc}
q_{0}M_{N}+q_{3}M_{E}-q_{2}M_{D} & q_{1}M_{N}+q_{2}M_{E}+q_{3}M_{D} & -q_{2}M_{N}+q_{1}M_{E}-q_{0}M_{D} & -q_{3}M_{N}+q_{0}M_{E}+q_{1}M_{D}\\
-q_{3}M_{N}+q_{0}M_{E}+q_{1}M_{D} & q_{2}M_{N}-q_{1}M_{E}+q_{0}M_{D} & q_{1}M_{N}+q_{2}M_{E}+q_{3}M_{D} & -q_{0}M_{N}-q_{3}M_{E}+q_{2}M_{D}\\
q_{2}M_{N}-q_{1}M_{E}+q_{0}M_{D} & q_{3}M_{N}-q_{0}M_{E}-q_{1}M_{D} & q_{0}M_{N}+q_{3}M_{E}-q_{2}M_{D} & q_{1}M_{N}+q_{2}M_{E}+q_{3}M_{D}
\end{array}\right]\\
 & =2\left[\begin{array}{c}
\left(\Phi_{4}\cdot\boldsymbol{M}_{I}\right)^{\mathrm{T}}\\
\left(\Phi_{5}\cdot\boldsymbol{M}_{I}\right)^{\mathrm{T}}\\
\left(\Phi_{6}\cdot\boldsymbol{M}_{I}\right)^{\mathrm{T}}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula 
\[
\Phi_{4}=\left[\begin{array}{ccc}
q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}\\
-q_{2} & q_{1} & -q_{0}\\
-q_{3} & q_{0} & q_{1}
\end{array}\right],\quad\Phi_{5}=\left[\begin{array}{ccc}
-q_{3} & q_{0} & q_{1}\\
q_{2} & -q_{1} & q_{0}\\
q_{1} & q_{2} & q_{3}\\
-q_{0} & -q_{3} & q_{2}
\end{array}\right],\quad\Phi_{6}=\left[\begin{array}{ccc}
q_{2} & -q_{1} & q_{0}\\
q_{3} & -q_{0} & -q_{1}\\
q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{M_{I}}$
\end_inset

为磁力计的观测相对于地球磁场向量的观测矩阵，即磁场测量值相对于地球磁场的 Jacobian ，大小
\begin_inset Formula $3\times3$
\end_inset

为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{M_{I}} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial\boldsymbol{M}_{I}}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\right)}{\partial\boldsymbol{M}_{I}}\\
 & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{M_{B}}$
\end_inset

为磁力计的观测相对于机体磁场偏差的观测矩阵，即磁场测量值相对于磁场偏差的 Jacobian ，大小
\begin_inset Formula $3\times3$
\end_inset

为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{M_{B}} & =\dfrac{\partial\boldsymbol{M}_{pred}}{\partial\boldsymbol{M}_{B}}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{M}_{I}+\boldsymbol{M}_{B}\right)}{\partial\boldsymbol{M}_{B}}\\
 & =\boldsymbol{I}_{3\times3}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在实际的代码里，磁场观测矩阵
\begin_inset Formula $\boldsymbol{H}_{MAG}$
\end_inset

实际上是分为
\begin_inset Formula $3$
\end_inset

个一维观测矩阵进行观测：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{MAG_{X}} & =\dfrac{\partial M_{pred_{X}}}{\partial\boldsymbol{x}}\\
\boldsymbol{H}_{MAG_{Y}} & =\dfrac{\partial M_{pred_{Y}}}{\partial\boldsymbol{x}}\\
\boldsymbol{H}_{MAG_{Z}} & =\dfrac{\partial M_{pred_{Z}}}{\partial\boldsymbol{x}}
\end{align*}

\end_inset

这是一种优化算法，使用更多的运算步骤换取使用更少的栈空间。这对于MCU这种内存紧张的环境有好处。
\end_layout

\begin_layout Subsubsection
综合偏差测量的融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:综合偏差测量的融合方程"

\end_inset


\end_layout

\begin_layout Standard
有磁偏角约束的融合阶段，考虑事实上，地球的地理南北极与地磁南北极并不重合，也就是真北和磁北有一定夹角，这个夹角称为磁偏角
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset

。 因此如果增加了磁偏角的约束，则需要在融合完三轴磁力计测量值的基础上进行此部分的融合。这用于在没有绝对位置或速度测量的情况下保持正确的航向
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

例如使用光流时。这可以用来防止在航向观测不良期间，因地球磁场估计而产生不必要的偏航旋转。
\end_layout

\begin_layout Standard
磁偏角的测量值
\begin_inset Formula $\psi_{meas}^{DECLINATION}$
\end_inset

，有两个来源：一是由GPS提供(参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:提供纬度/经度点的磁偏角"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的内容)，二是由用户设定本地的磁偏角数据。磁偏角的噪声为
\begin_inset Formula $R=\sigma_{decl}^{2}$
\end_inset

，其中标准差
\begin_inset Formula $\sigma_{decl}$
\end_inset

在代码中设定，好工况为
\begin_inset Formula $0.02$
\end_inset

，差工况为
\begin_inset Formula $0.5$
\end_inset

。
\end_layout

\begin_layout Standard
磁偏角的预测值
\begin_inset Formula $\psi_{pred}^{DECLINATION}$
\end_inset

为
\begin_inset Formula 
\[
\psi_{pred}^{DECLINATION}=\arctan\left(\dfrac{M_{E}}{M_{N}}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
磁偏角观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\psi_{pred}^{DECLINATION}}$
\end_inset

是一个
\begin_inset Formula $1\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{\psi_{pred}^{DECLINATION}} & =\dfrac{\partial\psi_{pred}^{DECLINATION}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
0_{1\times4} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & \boldsymbol{H}_{M_{I}}^{\psi_{pred}^{DECLINATION}} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{M_{I}}^{\psi_{pred}^{DECLINATION}}$
\end_inset

是一个
\begin_inset Formula $1\times3$
\end_inset

的矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{M_{I}}^{\psi_{pred}^{DECLINATION}} & =\dfrac{\partial\psi_{pred}^{DECLINATION}}{\partial\boldsymbol{M}_{I}}\\
 & =\dfrac{\partial\left(\tan^{-1}\left(\dfrac{M_{E}}{M_{N}}\right)\right)}{\partial\left(M_{N},M_{E},M_{D}\right)}\\
 & =\left[\begin{array}{ccc}
\dfrac{\partial\left(\tan^{-1}\left(\dfrac{M_{E}}{M_{N}}\right)\right)}{\partial\left(M_{N}\right)} & \dfrac{\partial\left(\tan^{-1}\left(\dfrac{M_{E}}{M_{N}}\right)\right)}{\partial\left(M_{E}\right)} & 0\end{array}\right]\\
 & =\left[\begin{array}{ccc}
\dfrac{-M_{E}}{M_{N}^{2}+M_{E}^{2}} & \dfrac{M_{N}}{M_{N}^{2}+M_{E}^{2}} & 0\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
在飞行期间磁力数据对准之后，进行最优估计之后的磁偏角
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset

成为磁偏角的第三个数据源，其它模块通过调用
\family typewriter
Ekf::getMagDeclination()
\family default
函数获得当前最适合的磁偏角数据。
\end_layout

\begin_layout Subsubsection
一维磁罗盘航向测量融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:一维磁罗盘航向测量融合方程"

\end_inset


\end_layout

\begin_layout Standard
航向角(heading)，也称偏航角(yaw) 
\begin_inset Formula $\psi$
\end_inset

。本节算法的一个重要假设是在上一时刻为零偏航角。然后在当前时刻，分别计算偏航角的测量值和预测值，再求残差。不过因为零偏航角假设与当前实际偏航角相差太大，因此该算
法不太准确。
\end_layout

\begin_layout Standard
既然假设偏航角为零偏航角，我们也可以假设偏航角与磁偏角
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset

方向重合，则其测量值就可由磁力计测量值
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset

计算出来。
\end_layout

\begin_layout Standard
首先将机体磁场旋转到 NED 坐标系：
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{meas_{I}} & =\left[T\right]_{B}^{N}\left(\boldsymbol{M}_{meas}-\boldsymbol{M}_{B}\right)\\
\left[\begin{array}{c}
M_{meas_{N}}\\
M_{meas_{E}}\\
M_{meas_{D}}
\end{array}\right] & =\left[T\right]_{B}^{N}\left(\left[\begin{array}{c}
M_{meas_{X}}\\
M_{meas_{Y}}\\
M_{meas_{Z}}
\end{array}\right]-\left[\begin{array}{c}
M_{X}\\
M_{Y}\\
M_{Z}
\end{array}\right]\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
则航向角的测量值
\begin_inset Formula $\psi_{meas}$
\end_inset

为：
\begin_inset Formula 
\[
\psi_{meas}=-\arctan\left(\dfrac{M_{meas_{E}}}{M_{meas_{N}}}\right)+\psi^{DECLINATION}
\]

\end_inset

其噪声
\begin_inset Formula $R_{yaw}$
\end_inset

根据磁力计特性设定。
\end_layout

\begin_layout Standard
航向角的预测值
\begin_inset Formula $\psi_{pred}$
\end_inset

可由旋转矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

，即由状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

提供的姿态四元数
\begin_inset Formula $q$
\end_inset

计算出来：
\begin_inset Formula 
\begin{align*}
\psi_{pred} & =\begin{cases}
\arctan\left(\dfrac{\left(\left[T\right]_{B}^{N}\right)_{\left(1,0\right)}}{\left(\left[T\right]_{B}^{N}\right)_{\left(0,0\right)}}\right) & \text{for yaw321}\\
\arctan\left(\dfrac{-\left(\left[T\right]_{B}^{N}\right)_{\left(0,1\right)}}{\left(\left[T\right]_{B}^{N}\right)_{\left(1,1\right)}}\right) & \text{for yaw312}
\end{cases}\\
 & =\begin{cases}
\arctan\left(\dfrac{2\left(q_{1}\cdot q_{2}+q_{0}\cdot q_{3}\right)}{q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}}\right) & \text{for yaw321}\\
\arctan\left(\dfrac{-2\left(q_{1}\cdot q_{2}-q_{0}\cdot q_{3}\right)}{q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}}\right) & \text{for yaw312}
\end{cases}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename Heading.pdf
	scale 50

\end_inset


\end_layout

\begin_layout Standard
航向角的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\psi}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{\psi} & =\dfrac{\partial\psi_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{\psi} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{\psi}$
\end_inset

为航向角的观测相对于姿态四元数
\begin_inset Formula $q$
\end_inset

的观测矩阵，为
\begin_inset Formula $1\times4$
\end_inset

矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{q}^{\psi}=\dfrac{\partial\psi_{pred}}{\partial q}
\]

\end_inset

这个偏导展开太复杂，很难手工推导。使用符号推导系统生成的计算式如下：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{H}_{q}^{\psi}=\begin{cases}
\left[\begin{array}{c}
\frac{2\left(-2q_{0}\left(q_{0}q_{3}+q_{1}q_{2}\right)+q_{3}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(-2q_{1}\left(q_{0}q_{3}+q_{1}q_{2}\right)+q_{2}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(q_{1}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)+2q_{2}\left(q_{0}q_{3}+q_{1}q_{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(q_{0}\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)+2q_{3}\left(q_{0}q_{3}+q_{1}q_{2}\right)\right)}{4\left(q_{0}q_{3}+q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)^{2}}
\end{array}\right]^{\mathrm{T}} & \text{for yaw321}\\
\\
\left[\begin{array}{c}
\frac{2\left(-2q_{0}\left(q_{0}q_{3}-q_{1}q_{2}\right)+q_{3}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(2q_{1}\left(q_{0}q_{3}-q_{1}q_{2}\right)-q_{2}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
-\frac{2q_{1}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)+4q_{2}\left(q_{0}q_{3}-q_{1}q_{2}\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}\\
\frac{2\left(q_{0}\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)+2q_{3}\left(q_{0}q_{3}-q_{1}q_{2}\right)\right)}{4\left(q_{0}q_{3}-q_{1}q_{2}\right)^{2}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)^{2}}
\end{array}\right]^{\mathrm{T}} & \text{for yaw312}
\end{cases}
\]

\end_inset


\end_layout

\begin_layout Standard
简单的一维偏航角融合，其实也可以称为偏航角去除偏差后再应用EKF的自平滑算法，虽然结果不太准确，但其受地球磁场畸变的影响较小。它适用于俯仰角在
\begin_inset Formula $-60^{\circ}<\theta<+60^{\circ}$
\end_inset

之间的情况。
\end_layout

\begin_layout Standard
注意，当第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:外部视觉融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的外部视觉复用该算法时，由其提供
\begin_inset Formula $R_{yaw}$
\end_inset

，并且对于航向角的测量值
\begin_inset Formula $\psi_{meas}$
\end_inset

，由其提供的姿态四元数
\begin_inset Formula $q_{ev}$
\end_inset

计算出来，即此时的新息是两个姿态四元数，
\begin_inset Formula $q_{ekf}$
\end_inset

和
\begin_inset Formula $q_{ev}$
\end_inset

，两者的偏航角差异值。
\end_layout

\begin_layout Subsection
光流测量序列融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:光流测量序列融合方程"

\end_inset


\end_layout

\begin_layout Standard
光流传感器(optical flow)依赖于测距仪(range finder)，它可以提供
\begin_inset Formula $xy$
\end_inset

水平面的速度测量值，并且已知其测量噪声
\begin_inset Formula $R_{LOS}$
\end_inset

。 光流传感器的观测量有：
\end_layout

\begin_layout Itemize
视轴(line of sight, LOS)角速度测量(相对于传感器坐标系)，从向下看的光流传感器测量，以
\begin_inset Formula $\mathrm{rad}/\sec$
\end_inset

为单位，围绕
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

传感器坐标系轴。这些速度是运动补偿的。
\end_layout

\begin_layout Itemize
正视轴
\begin_inset Formula $X$
\end_inset

速度是图像围绕
\begin_inset Formula $X$
\end_inset

传感器轴的相对旋转，在正的
\begin_inset Formula $Y$
\end_inset

轴方向上产生地面相对速度。
\end_layout

\begin_layout Itemize
正视轴
\begin_inset Formula $Y$
\end_inset

速度是图像围绕
\begin_inset Formula $Y$
\end_inset

传感器轴的相对旋转，在负的
\begin_inset Formula $X$
\end_inset

轴方向上产生地面相对速度。
\end_layout

\begin_layout Itemize
距离(range)的测量与机体
\begin_inset Formula $Z$
\end_inset

轴对准(假设为平地模型)。
\end_layout

\begin_layout Standard
距离(range)为从摄像机焦点到传感器视场(field of view, fov)中心的距离，由地形高差(terrain height offset)估计算法
计算，并且为描述方便，测量视轴角速度
\begin_inset Formula $\boldsymbol{V}_{meas}^{LOS}$
\end_inset

的计算都在第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:光流速度融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节中描述。
\end_layout

\begin_layout Standard
为预测视轴角速度，首先计算传感器坐标系中的相对速度
\begin_inset Formula $\boldsymbol{V}^{B}$
\end_inset

 (更精确的算法见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:光流速度融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的描述)：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}^{B} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{NED}\\
\left[\begin{array}{c}
V_{X}\\
V_{Y}\\
V_{Z}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset

将相对速度除以距离(range)得到相对于
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的预测视轴角速度
\begin_inset Formula $\boldsymbol{V}_{pred}^{LOS}$
\end_inset

 (注：这些是已经过机体角速度运动补偿的光流速度)：
\begin_inset Formula 
\begin{align*}
V_{X}^{LOS} & =+V_{Y}/\mathrm{range}\\
V_{Y}^{LOS} & =-V_{X}/\mathrm{range}\\
\boldsymbol{V}_{pred}^{LOS} & =\left[\begin{array}{c}
V_{X}^{LOS}\\
V_{Y}^{LOS}
\end{array}\right]\\
 & =\dfrac{1}{\mathrm{range}}\left[\begin{array}{c}
2\left(q_{1}q_{2}-q_{0}q_{3}\right)V_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)V_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}\\
-\left(\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)V_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)V_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}\right)
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
视轴角速度的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\text{\boldsymbol{H}_{LOS}}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $2\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{LOS} & =\dfrac{\partial\boldsymbol{V}_{pred}^{LOS}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{V^{LOS}} & \boldsymbol{H}_{V}^{V^{LOS}} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{V^{LOS}}$
\end_inset

和
\begin_inset Formula $\boldsymbol{H}_{V}^{V^{LOS}}$
\end_inset

这2个分块矩阵见下面的推导。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{q}^{V^{LOS}}$
\end_inset

为视轴角速度的观测相对于姿态四元数的观测矩阵，即视轴角速度相对于旋转的 Jacobian ，大小为
\begin_inset Formula $2\times4$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{q}^{V^{LOS}} & =\dfrac{\partial\boldsymbol{V}_{pred}^{LOS}}{\partial q}\\
 & =\dfrac{\partial\left(\dfrac{1}{\mathrm{range}}\left[\begin{array}{c}
2\left(q_{1}q_{2}-q_{0}q_{3}\right)V_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)V_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}\\
-\left(\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)V_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)V_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}\right)
\end{array}\right]\right)}{\partial q}\\
 & \tiny=\dfrac{2}{\mathrm{range}}\left[\begin{array}{cccc}
-q_{3}V_{N}+q_{0}V_{E}+q_{1}V_{D} & q_{2}V_{N}-q_{1}V_{E}+q_{0}V_{D} & q_{1}V_{N}+q_{2}V_{E}+q_{3}V_{D} & -q_{0}V_{N}-q_{3}V_{E}+q_{2}V_{D}\\
-\left(q_{0}V_{N}+q_{3}V_{E}-q_{2}V_{D}\right) & -\left(q_{1}V_{N}+q_{2}V_{E}+q_{3}V_{D}\right) & -\left(-q_{2}V_{N}+q_{1}V_{E}-q_{0}V_{D}\right) & -\left(-q_{3}V_{N}+q_{0}V_{E}+q_{1}V_{D}\right)
\end{array}\right]\\
 & =\dfrac{2}{\mathrm{range}}\left[\begin{array}{c}
\left(\Phi_{5}\cdot\boldsymbol{V}_{NED}\right)^{\mathrm{T}}\\
\left(-\Phi_{4}\cdot\boldsymbol{V}_{NED}\right)^{\mathrm{T}}
\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula 
\[
\Phi_{4}=\left[\begin{array}{ccc}
q_{0} & q_{3} & -q_{2}\\
q_{1} & q_{2} & q_{3}\\
-q_{2} & q_{1} & -q_{0}\\
-q_{3} & q_{0} & q_{1}
\end{array}\right],\quad\Phi_{5}=\left[\begin{array}{ccc}
-q_{3} & q_{0} & q_{1}\\
q_{2} & -q_{1} & q_{0}\\
q_{1} & q_{2} & q_{3}\\
-q_{0} & -q_{3} & q_{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset Formula $\boldsymbol{H}_{V}^{V^{LOS}}$
\end_inset

为视轴角速度的观测相对于 NED 坐标系下机体速度的观测矩阵，即视轴角速度相对于 NED 坐标系下机体速度的 Jacobian ，大小为
\begin_inset Formula $2\times3$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{V}^{V^{LOS}} & =\dfrac{\partial\boldsymbol{V}_{pred}^{LOS}}{\partial\boldsymbol{V}_{NED}}\\
 & =\dfrac{\partial\left(\dfrac{1}{\mathrm{range}}\left[\begin{array}{c}
2\left(q_{1}q_{2}-q_{0}q_{3}\right)V_{N}+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)V_{E}+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}\\
-\left(\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)V_{N}+2\left(q_{1}q_{2}+q_{0}q_{3}\right)V_{E}+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}\right)
\end{array}\right]\right)}{\partial\boldsymbol{V}_{NED}}\\
 & =\dfrac{1}{\mathrm{range}}\left[\begin{array}{ccc}
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
-\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right) & -2\left(q_{1}q_{2}+q_{0}q_{3}\right) & -2\left(q_{1}q_{3}-q_{0}q_{2}\right)
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在实际的代码里，磁场观测矩阵
\begin_inset Formula $\boldsymbol{H}_{LOS}$
\end_inset

实际上是分为2个一维观测矩阵进行观测：
\begin_inset Formula 
\begin{align*}
H_{LOS_{X}} & =\dfrac{\partial V_{X}^{LOS}}{\partial\boldsymbol{x}}\\
H_{LOS_{Y}} & =\dfrac{\partial V_{Y}^{LOS}}{\partial\boldsymbol{x}}
\end{align*}

\end_inset

这是一种优化算法，使用更多的运算步骤换取使用更少的栈空间。这对于MCU这种内存紧张的环境有好处。
\end_layout

\begin_layout Subsection
GPS融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:GPS融合方程"

\end_inset


\end_layout

\begin_layout Subsubsection
GPS的偏航角融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:GPS的偏航角融合方程"

\end_inset


\end_layout

\begin_layout Standard
某些GPS设备设计有双天线，或者两个特殊GPS设备组成双天线，在这种条件下，GPS设备可以提供偏航角测量值，因此可以进行双天线航向融合。该方法的一个重要的概念是
移动基线(Moving Baseline)，即在两个GPS天线之间的线。其可以提供两个测量值：基线偏航角
\begin_inset Formula $\psi_{baseline}$
\end_inset

和基线相对于机体
\begin_inset Formula $x$
\end_inset

轴的偏航偏移角
\begin_inset Formula $\psi_{antenna}$
\end_inset

。该融合方程与第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:一维磁罗盘航向测量融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节对磁偏角观测的原理类似，是对偏航偏移角
\begin_inset Formula $\psi_{antenna}$
\end_inset

的观测融合。以下推导双天线偏航测量融合方程。
\end_layout

\begin_layout Standard
测量噪声方差
\begin_inset Formula $R_{yaw}$
\end_inset

，设置为GPS航向噪声的数值，如果没有也可用磁力计的噪声数值应急。
\end_layout

\begin_layout Standard
计算天线阵列的观测偏航角，将其从机体变换为天线的偏航测量值
\begin_inset Formula $\psi_{meas}$
\end_inset


\begin_inset Formula 
\[
\psi_{meas}=\psi_{baseline}+\psi_{antenna}
\]

\end_inset


\end_layout

\begin_layout Standard
在机体坐标系中定义天线向量
\begin_inset Formula $\boldsymbol{v}_{B}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{v}_{B}=\left[\begin{array}{c}
\cos\left(\psi_{antenna}\right)\\
\sin\left(\psi_{antenna}\right)\\
0
\end{array}\right]
\]

\end_inset

将其旋转到地球坐标系
\begin_inset Formula 
\begin{align*}
\boldsymbol{v}_{I} & =\left[T\right]_{B}^{N}\cdot\boldsymbol{v}_{B}\\
\left[\begin{array}{c}
v_{N}\\
v_{E}\\
v_{D}
\end{array}\right] & =\left[T\right]_{B}^{N}\cdot\left[\begin{array}{c}
\cos\left(\psi_{antenna}\right)\\
\sin\left(\psi_{antenna}\right)\\
0
\end{array}\right]
\end{align*}

\end_inset

根据投影计算预测天线偏航角
\begin_inset Formula $\psi_{pred}$
\end_inset


\begin_inset Formula 
\[
\psi_{pred}=\arctan\left(\dfrac{v_{E}}{v_{N}}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
偏航偏移角的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\psi}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

的稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{\psi} & =\dfrac{\partial\psi_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{\psi} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{\psi}$
\end_inset

为磁偏角的观测相对于姿态四元数
\begin_inset Formula $q$
\end_inset

的观测矩阵，为
\begin_inset Formula $1\times4$
\end_inset

矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{q}^{\psi}=\dfrac{\partial\psi_{pred}}{\partial q}
\]

\end_inset

这个偏导展开太复杂，无法手工推导。具体可见代码中用符号推导系统生成的计算式。
\end_layout

\begin_layout Subsubsection
GPS速度和水平位置融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:GPS速度和水平位置融合方程"

\end_inset


\end_layout

\begin_layout Standard
GPS的速度和位置都涉及状态的直接观测，因此观测模型比较简单。因为GPS在
\begin_inset Formula $z$
\end_inset

轴方向上的数据误差比较大，而高度数据源比较多，所以对于位置向量只进行水平位置更新。
\end_layout

\begin_layout Standard
GPS 的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{GPS}$
\end_inset

，即对应的观测矩阵 Jacobian 比较简单，为
\begin_inset Formula $5\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{GPS}=\left[\begin{array}{cccccccc}
0_{3\times4} & \boldsymbol{I}_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\\
0_{2\times4} & 0_{2\times3} & \left[\begin{array}{ccc}
1 & 0 & 0\\
0 & 1 & 0
\end{array}\right] & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times3} & 0_{2\times2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
并且已知GPS的测量噪声
\begin_inset Formula $\boldsymbol{R}_{GPS}$
\end_inset

，由此可对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度和水平位置进行校正。
\end_layout

\begin_layout Subsection
空速融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:空速融合方程"

\end_inset


\end_layout

\begin_layout Standard
对于固定翼平台，空速观测方程假设传感器测量相对于风场的速度
\begin_inset Formula $\boldsymbol{V}_{EAS}$
\end_inset

为：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{EAS} & =\boldsymbol{V}_{NED}-\boldsymbol{V}_{wind}\\
\left[\begin{array}{c}
V_{EAS_{N}}\\
V_{EAS_{E}}\\
V_{EAS_{D}}
\end{array}\right] & =\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]-\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
则真空速的预测值
\begin_inset Formula $V_{pred}^{TAS}$
\end_inset

为：
\begin_inset Formula 
\[
V_{pred}^{TAS}=\sqrt{\left(V_{EAS_{N}}^{2}+V_{EAS_{E}}^{2}+V_{EAS_{D}}^{2}\right)}
\]

\end_inset


\end_layout

\begin_layout Standard
当只使用风速估计而不使用合成侧滑时，真空速的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{TAS}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{TAS} & =\dfrac{\partial V_{pred}^{TAS}}{\partial\boldsymbol{x}}\\
 & =\dfrac{\partial\left(\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}\right)^{\frac{1}{2}}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
0_{1\times4} & \boldsymbol{H}_{V_{NED}}^{V_{pred}^{TAS}} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & \boldsymbol{H}_{V_{wind}}^{V_{pred}^{TAS}}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{V_{NED}}^{V_{pred}^{TAS}}$
\end_inset

为真空速相对于速度的
\begin_inset Formula $1\times3$
\end_inset

观测矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{V_{NED}}^{V_{pred}^{TAS}}=\left[\begin{array}{c}
\dfrac{V_{N}-V_{wind_{N}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}\\
\dfrac{V_{E}-V_{wind_{E}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}\\
\dfrac{V_{D}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}
\end{array}\right]^{\mathrm{T}}
\]

\end_inset


\begin_inset Formula $\boldsymbol{H}_{V_{wind}}^{V_{pred}^{TAS}}$
\end_inset

为真空速相对于风速的
\begin_inset Formula $1\times2$
\end_inset

观测矩阵：
\begin_inset Formula 
\[
\boldsymbol{H}_{V_{wind}}^{V_{pred}^{TAS}}=-\left[\begin{array}{c}
\dfrac{V_{N}-V_{wind_{N}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}\\
\dfrac{V_{E}-V_{wind_{E}}}{\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}}
\end{array}\right]^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
并且已知风速传感器的测量值
\begin_inset Formula $V_{meas}^{TAS}$
\end_inset

及其测量噪声
\begin_inset Formula $R_{TAS}$
\end_inset

，由此可对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度和风速进行校正。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:真实空速融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“真实空速融合”的内容。
\end_layout

\begin_layout Standard
注意，因为风速的误差相当大，为减小其对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度的影响，正常情况下都将
\begin_inset Formula $\boldsymbol{H}_{V_{NED}}^{V_{pred}^{TAS}}=\boldsymbol{0}$
\end_inset

，直到ECL估计系统进入风场航位推算模式模式后，才用
\begin_inset Formula $\boldsymbol{H}_{V_{NED}}^{V_{pred}^{TAS}}$
\end_inset

对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的速度进行校正。具体见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“惯性航位推算”中的讨论。
\end_layout

\begin_layout Subsection
合成侧滑融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:合成侧滑融合方程"

\end_inset


\end_layout

\begin_layout Standard
非固定翼平台可以利用假定的侧滑观测值为零来改进风速估计，也可以在没有空速传感器的情况下进行风速估计。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“合成侧滑融合”的内容。
\end_layout

\begin_layout Standard
首先将等效风速
\begin_inset Formula $\boldsymbol{V}_{EAS}$
\end_inset

旋转到机体坐标系中得到机体的风速
\begin_inset Formula $\boldsymbol{V}_{wind_{B}}$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind_{B}} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{EAS}\\
 & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\boldsymbol{V}_{NED}-\boldsymbol{V}_{wind}\right)\\
\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]-\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]\right)\\
 & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
V_{N}-V_{wind_{N}}\\
V_{E}-V_{wind_{E}}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
用小角近似法计算预测侧滑角度，也是侧滑新息，因为假设观测值为零：
\begin_inset Formula 
\[
\mathrm{beta}=\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}
\]

\end_inset


\end_layout

\begin_layout Standard
合成侧滑的噪声
\begin_inset Formula $R_{beta}$
\end_inset

由用户设定。合成侧滑的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{beta}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $1\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{beta} & =\dfrac{\partial\left(\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}\right)}{\partial\boldsymbol{x}}\\
 & =\dfrac{\partial\left(\dfrac{2\left(q_{1}q_{2}-q_{0}q_{3}\right)\left(V_{N}-V_{wind_{N}}\right)+\left(q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2}\right)\left(V_{E}-V_{wind_{E}}\right)+2\left(q_{2}q_{3}+q_{0}q_{1}\right)V_{D}}{\left(q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2}\right)\left(V_{N}-V_{wind_{N}}\right)+2\left(q_{1}q_{2}+q_{0}q_{3}\right)\left(V_{E}-V_{wind_{E}}\right)+2\left(q_{1}q_{3}-q_{0}q_{2}\right)V_{D}}\right)}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{beta} & \boldsymbol{H}_{V}^{beta} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & \boldsymbol{H}_{V_{wind}}^{beta}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{beta}$
\end_inset

为合成侧滑的观测相对于姿态四元数的观测矩阵，即合成侧滑相对于旋转的 Jacobian，大小为
\begin_inset Formula $1\times4$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V}^{beta}$
\end_inset

为合成侧滑的观测相对于 NED 坐标系下机体速度的观测矩阵，即合成侧滑相对于 NED 坐标系下机体速度的 Jacobian ，大小为
\begin_inset Formula $1\times3$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V_{wind}}^{beta}$
\end_inset

为合成侧滑的观测相对于风速观测矩阵，大小为
\begin_inset Formula $1\times3$
\end_inset

。这3个偏导展开太复杂，就不在这里推导。具体可见代码中用符号推导系统生成的计算式。
\end_layout

\begin_layout Standard
注意，因为合成侧滑的误差相当大，为减小其对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的姿态和速度的影响，正常情况下都将
\begin_inset Formula $\boldsymbol{H}_{q}^{beta}=\boldsymbol{0},\boldsymbol{H}_{V}^{beta}=\boldsymbol{0}$
\end_inset

，直到ECL估计系统进入风场航位推算模式模式后，才用
\begin_inset Formula $\boldsymbol{H}_{q}^{beta}$
\end_inset

和
\begin_inset Formula $\boldsymbol{H}_{V}^{beta}$
\end_inset

对状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

中的姿态和速度进行校正。具体见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“惯性航位推算”的讨论。
\end_layout

\begin_layout Subsection
阻力比力融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:阻力比力融合方程"

\end_inset


\end_layout

\begin_layout Standard
与合成侧滑类似，首先将等效风速
\begin_inset Formula $\boldsymbol{V}_{EAS}$
\end_inset

旋转到机体坐标系中得到机体的风速
\begin_inset Formula $\boldsymbol{V}_{wind_{B}}$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind_{B}} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\boldsymbol{V}_{EAS}\\
 & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\boldsymbol{V}_{NED}-\boldsymbol{V}_{wind}\right)\\
\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right] & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
V_{D}
\end{array}\right]-\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]\right)\\
 & =\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
V_{N}-V_{wind_{N}}\\
V_{E}-V_{wind_{E}}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
将前面计算得到的增量速度
\begin_inset Formula $\boldsymbol{\Delta V}_{meas}$
\end_inset

将其假设为加速度测量值
\begin_inset Formula $\boldsymbol{a}_{meas}$
\end_inset

，减去加速度偏差
\begin_inset Formula $\boldsymbol{\Delta a}_{b}$
\end_inset

得到阻力比力
\begin_inset Formula $\mathrm{drag}$
\end_inset

：
\begin_inset Formula 
\[
\mathrm{drag}=\boldsymbol{a}_{meas}-\boldsymbol{\Delta a}_{b}
\]

\end_inset


\end_layout

\begin_layout Standard
并用空气密度
\begin_inset Formula $\rho$
\end_inset

和弹道系数
\begin_inset Formula $\mathrm{coef}$
\end_inset

估算空速
\begin_inset Formula $\mathrm{airspeed}$
\end_inset

：
\begin_inset Formula 
\[
\mathrm{airspeed}=\sqrt{\left(2\left|\mathrm{drag}\right|\right)/\left(\mathrm{coef}\cdot\rho\right)}
\]

\end_inset


\end_layout

\begin_layout Standard
并计算比力系数
\begin_inset Formula $\boldsymbol{K}_{acc}$
\end_inset

：
\begin_inset Formula 
\[
\boldsymbol{K}_{acc}=\mathrm{coef}\cdot\mathrm{airspeed}
\]

\end_inset


\end_layout

\begin_layout Standard
预测的加速度
\begin_inset Formula $\boldsymbol{a}_{pred}$
\end_inset

为：
\begin_inset Formula 
\[
\boldsymbol{a}_{pred}=-\dfrac{1}{2}\mathrm{sign}\left(\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right]\right)\left(\mathrm{coef}\cdot\rho\right)\left[\begin{array}{c}
V_{wind_{X}}^{2}\\
V_{wind_{Y}}^{2}\\
V_{wind_{Z}}^{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
则阻力比力新息
\begin_inset Formula $\mathrm{drag\_innov}$
\end_inset

为：
\begin_inset Formula 
\[
\mathrm{drag\_innov}=\boldsymbol{a}_{pred}-\mathrm{drag}
\]

\end_inset


\end_layout

\begin_layout Standard
阻力比力的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{drag}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $3\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{drag} & =\dfrac{\partial\boldsymbol{a}_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{drag} & \boldsymbol{H}_{V}^{drag} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & \boldsymbol{H}_{V_{wind}}^{drag}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{drag}$
\end_inset

为阻力比力的观测相对于姿态四元数的观测矩阵，即阻力比力相对于旋转的 Jacobian，大小为
\begin_inset Formula $3\times4$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V}^{drag}$
\end_inset

为阻力比力的观测相对于 NED 坐标系下机体速度的观测矩阵，即阻力比力相对于 NED 坐标系下机体速度的 Jacobian，大小为
\begin_inset Formula $3\times3$
\end_inset

，
\begin_inset Formula $\boldsymbol{H}_{V_{wind}}^{drag}$
\end_inset

为阻力比力的观测相对于风速观测矩阵，大小为
\begin_inset Formula $3\times2$
\end_inset

。这3个偏导展开太复杂，就不在这里推导。具体可见代码中用符号推导系统生成的计算式。
\end_layout

\begin_layout Subsection
高度融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:高度融合方程"

\end_inset


\end_layout

\begin_layout Standard
高度涉及状态的直接观测，因此观测模型比较简单。
\end_layout

\begin_layout Standard
高度数据源比较多，有4种：
\end_layout

\begin_layout Enumerate
气压计(baro)
\end_layout

\begin_layout Enumerate
GPS
\end_layout

\begin_layout Enumerate
外部视觉(EV)
\end_layout

\begin_layout Enumerate
测距仪(range)
\end_layout

\begin_layout Standard
同一时刻只能使用其中一种。软件内部会根据数据源的质量状况进行切换。
\end_layout

\begin_layout Standard
高度的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{hgt}$
\end_inset

，即对应的观测 Jacobian 矩阵，为
\begin_inset Formula $1\times24$
\end_inset

稀疏矩阵：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{H}_{hgt}=\left[\begin{array}{cccccccc}
0_{1\times4} & 0_{1\times3} & \left[\begin{array}{ccc}
0 & 0 & 1\end{array}\right] & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times3} & 0_{1\times2}\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
根据各自传感器
\begin_inset Formula $z$
\end_inset

轴的噪声
\begin_inset Formula $R_{hgt}$
\end_inset

，就可以对高度进行校正。
\end_layout

\begin_layout Standard
高度融合方程虽然简单，但是因为涉及到NED坐标系和切换高度数据源的算法，实际的算法还是有些复杂。具体算法将在第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:高度数据的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章讨论。
\end_layout

\begin_layout Subsection
重力融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:重力融合方程"

\end_inset


\end_layout

\begin_layout Standard
本算法以重力向量为观测向量对姿态进行校正。它假设机体加速度不大，接近零，则IMU测量得到的加速度测量值大部分是重力向量，因此它在静止状态下比较准确。
\end_layout

\begin_layout Standard
首先从增量速度方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:7"
plural "false"
caps "false"
noprefix "false"

\end_inset

)计算测量加速度
\begin_inset Formula $\boldsymbol{a}_{meas}$
\end_inset

：
\begin_inset Formula 
\[
\boldsymbol{a}_{meas}=\boldsymbol{\Delta V}_{meas}/\Delta t-\boldsymbol{\Delta a}_{b}
\]

\end_inset

该加速度向量包含机体加速度和重力，在此假设机体加速度不大。重力测量噪声
\begin_inset Formula $\boldsymbol{\sigma}_{gravity}^{2}$
\end_inset

由用户设置。
\end_layout

\begin_layout Standard
其次，因为重力观测向量为一个向上的向量，则当前时刻的预测值可将其旋转到机体坐标系中计算出来：
\begin_inset Formula 
\[
\boldsymbol{a}_{pred}=\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
0\\
0\\
-g
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
接着计算新息：
\begin_inset Formula 
\begin{align*}
\mathrm{gravity\_innov} & =\boldsymbol{a}_{pred}-g\cdot\boldsymbol{a}_{meas}/\left\Vert \boldsymbol{a}_{meas}\right\Vert 
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
重力的观测相对于状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\boldsymbol{a}}$
\end_inset

，即对应的观测矩阵 Jacobian ，为
\begin_inset Formula $3\times24$
\end_inset

稀疏矩阵：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{\boldsymbol{a}} & =\dfrac{\partial\boldsymbol{a}_{pred}}{\partial\boldsymbol{x}}\\
 & =\left[\begin{array}{cccccccc}
\boldsymbol{H}_{q}^{\boldsymbol{a}} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 0_{3\times2}\end{array}\right]
\end{align*}

\end_inset

其中，
\begin_inset Formula $\boldsymbol{H}_{q}^{\boldsymbol{a}}$
\end_inset

为重力的观测相对于姿态四元数的观测矩阵，即重力相对于旋转的 Jacobian，大小为
\begin_inset Formula $3\times4$
\end_inset

：
\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{q}^{\boldsymbol{a}} & =\dfrac{\partial\boldsymbol{a}_{pred}}{\partial q}\\
 & =\dfrac{\partial\left(\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\left[\begin{array}{c}
0\\
0\\
-g
\end{array}\right]\right)}{\partial q}\\
 & =\dfrac{\partial\left(\left[\begin{array}{ccc}
q_{0}^{2}+q_{1}^{2}-q_{2}^{2}-q_{3}^{2} & 2\left(q_{1}q_{2}+q_{0}q_{3}\right) & 2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{1}q_{2}-q_{0}q_{3}\right) & q_{0}^{2}-q_{1}^{2}+q_{2}^{2}-q_{3}^{2} & 2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
2\left(q_{1}q_{3}+q_{0}q_{2}\right) & 2\left(q_{2}q_{3}-q_{0}q_{1}\right) & q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}
\end{array}\right]\left[\begin{array}{c}
0\\
0\\
-g
\end{array}\right]\right)}{\partial q}\\
 & =\dfrac{\partial\left(-g\left[\begin{array}{c}
2\left(q_{1}q_{3}-q_{0}q_{2}\right)\\
2\left(q_{2}q_{3}+q_{0}q_{1}\right)\\
\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)
\end{array}\right]\right)}{\partial q}\\
 & =-2g\left[\begin{array}{cccc}
-q_{2} & +q_{3} & -q_{0} & +q_{1}\\
+q_{1} & +q_{0} & +q_{3} & +q_{2}\\
+q_{0} & -q_{1} & -q_{2} & +q_{3}
\end{array}\right]\\
 & =-2g\cdot\Phi_{3}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
注意，为适应MCU设备内存紧张的环境，在实际的代码里，重力观测矩阵
\begin_inset Formula $\boldsymbol{H}_{\boldsymbol{a}}$
\end_inset

分为 
\begin_inset Formula $X/Y/Z$
\end_inset

三个方向分别进行观测。
\end_layout

\begin_layout Subsection
外部视觉融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:外部视觉融合方程"

\end_inset


\end_layout

\begin_layout Standard
外部视觉系统可以提供速度
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

、位置
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

和姿态四元数的测量值
\begin_inset Formula $q_{ev}$
\end_inset

，因此也可以提供航向角的测量值
\begin_inset Formula $\psi_{meas}$
\end_inset

。需要注意的是，外部视觉的坐标系不一定是NED，可能需要进行坐标系变换。速度与水平位置的融合方程与第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS速度和水平位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的融合方程类似，高度则提供给第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:高度融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的融合方程，航向角则提供给第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:一维磁罗盘航向测量融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的融合方程，只是由其提供其自身的测量噪声
\begin_inset Formula $R_{yaw}$
\end_inset

和姿态四元数
\begin_inset Formula $q_{ev}$
\end_inset

。
\end_layout

\begin_layout Subsection
辅助速度融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:辅助速度融合方程"

\end_inset


\end_layout

\begin_layout Standard
某些飞行器具有红外锁定(IR-Lock)和Pixy视觉传感器，在这些飞行器着陆阶段，PX4系统可以提供着陆目标的二维速度估计，该速度为着陆目标相对于机体的
\begin_inset Formula $x/y$
\end_inset

方向速度。当着陆目标固定时，根据机体着陆姿态近水平面的假设，该速度向量取负值就是机体相对于大地的北/东方向速度(
\begin_inset Formula $V_{N}/V_{E}$
\end_inset

)。相应的融合方程与第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS速度和水平位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的GPS速度融合方程类似。
\end_layout

\begin_layout Subsection
虚拟位置融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:虚拟位置融合方程"

\end_inset


\end_layout

\begin_layout Standard
当没有一种水平面的位置和速度的测量值以校正用IMU数据进行的水平面位置推算时，则需要使用合成位置观测来防止惯性导航系统(Inertial Navigation
 System, INS)状态的无约束漂移。其方法是在最后一个已知位置进行虚拟位置测量，并且设置特别的位置方差，以限制漂移。为提高效率，虚拟位置测量最小融合频率
为
\begin_inset Formula $5~\mathrm{Hz}$
\end_inset

。
\end_layout

\begin_layout Standard
相关的信息见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“惯性航位推算”中的讨论。
\end_layout

\begin_layout Subsection
虚拟高度融合方程
\begin_inset CommandInset label
LatexCommand label
name "subsec:虚拟高度融合方程"

\end_inset


\end_layout

\begin_layout Standard
与上一节类似，当没有一种高度测量值以校正用IMU数据进行的高度推算时，用于限制漂移的虚拟高度测量。如果我们没有任何辅助校正，则需要使用最后已知的垂直位置进行虚拟
高度测量以限制漂移。相关的信息见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“惯性航位推算”中的讨论。
\end_layout

\begin_layout Subsection
IMU偏差的自校正
\end_layout

\begin_layout Standard
检查以上融合方程可以发现，没有一种传感器测量值直接校正增量角度偏差
\begin_inset Formula $\boldsymbol{\Delta\theta}_{b}$
\end_inset

和加速度偏差
\begin_inset Formula $\boldsymbol{\Delta a}_{b}$
\end_inset

。这两者是通过校正后的姿态四元数
\begin_inset Formula $q$
\end_inset

和速度
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

，以及各传感器的噪声一起影响在EKF中计算出来的，这种方法被称为传感器的自校正。但是因为没有测量值对其进行直接校正，这两个偏差有可能发散，所以需要对其进行限制，
\begin_inset Formula $\left|\boldsymbol{\Delta\theta}_{b}\right|<20^{\circ}/s\cdot\Delta t,\ \left|\boldsymbol{\Delta a}_{b}\right|<0.4m/s^{2}\cdot\Delta t$
\end_inset

。
\end_layout

\begin_layout Section
地形高差估计的EKF方程
\begin_inset CommandInset label
LatexCommand label
name "sec:地形高差估计的EKF方程"

\end_inset


\end_layout

\begin_layout Standard
因为光流的算法依赖测距仪提供的高度数据，所以ECL模块在原先维护的
\begin_inset Formula $24$
\end_inset

元状态向量EKF(24-EKF)之外，还单独维护一个地形估计器，其目的是融合测距仪的测量值以估计地形垂直位置。地形高差(terrain height
 offset)估计的EKF方程在本章描述，注意其数值的正负符号，在NED坐标系中
\begin_inset Formula $z$
\end_inset

轴向下为正，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:高度数据的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的描述。
\end_layout

\begin_layout Subsection
距地高度的估计
\begin_inset CommandInset label
LatexCommand label
name "subsec:距地高度的估计"

\end_inset


\end_layout

\begin_layout Standard
在地形估计器内部用一个标准KF维护一个地形高度(terrain height)状态值，又称地形垂直位置(terrain vertical position,
 
\begin_inset Formula $\mathrm{terrain}_{vpos}$
\end_inset

)，也称在向下轴的地形位置(position of terrain in down axis, ptd)。相对应的，在 ECL/EKF2 中维护的垂直高度
\begin_inset Formula $P_{D}$
\end_inset

为海平面高差(altitude)，又称在向下轴飞行器的位置(position of vehicle in down axis, pd)。
\end_layout

\begin_layout Standard
假设距地高度(height above ground level, 
\begin_inset Formula $H^{agl}$
\end_inset

)是一个固定模型，它的变化由噪声驱动，所以
\begin_inset Formula $F=1$
\end_inset

。距地高度的测量值
\begin_inset Formula $H_{meas}^{agl}$
\end_inset

由测距仪提供。另外我们有地形测量标准差
\begin_inset Formula $\sigma_{terrain}$
\end_inset

，并有地形梯度
\begin_inset Formula $\nabla_{terrain}$
\end_inset

，用于当位置变化时估计过程噪声。
\end_layout

\begin_layout Standard
初始化时设置
\begin_inset Formula 
\[
\mathrm{terrain}_{vpos}=P_{D}+H_{meas}^{agl}
\]

\end_inset


\end_layout

\begin_layout Standard
时间更新时，因为是固定模型，所以只需要计算状态方差
\begin_inset Formula $P$
\end_inset


\begin_inset Formula 
\begin{align*}
Q & =\left(\sigma_{terrain}\cdot\Delta t\right)^{2}+\left(\nabla_{terrain}\cdot\Delta t\right)^{2}\left(V_{N}^{2}+V_{E}^{2}\right)\\
P & =P+Q
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
测量更新时，有两种数据融合，一是测距仪距地高度融合，二是光流速度融合。本节讨论前者，在下一节讨论后者。
\end_layout

\begin_layout Standard
测距仪距地高度融合。距地高度预测值
\begin_inset Formula $H_{pred}^{agl}$
\end_inset

由以下方程计算(注意在NED坐标系中
\begin_inset Formula $z$
\end_inset

轴的正偏移将导致更低的距地高度)：
\begin_inset Formula 
\[
H_{pred}^{agl}=\mathrm{terrain}_{vpos}-P_{D}
\]

\end_inset

计算距地高度新息：
\begin_inset Formula 
\[
\tilde{y}=H_{pred}^{agl}-H_{meas}^{agl}
\]

\end_inset

计算观测噪声有些复杂。我们从协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的对角线相应位置得到
\begin_inset Formula $P_{D}$
\end_inset

的状态方差
\begin_inset Formula $P_{P_{D}}$
\end_inset

，设置其增益系数
\begin_inset Formula $G_{P_{D}}$
\end_inset

。我们有测距仪测距仪噪声方差
\begin_inset Formula $\sigma_{range}^{2}$
\end_inset

，及其测量噪声增益
\begin_inset Formula $G_{range}$
\end_inset

，以及测距仪测量值
\begin_inset Formula $\mathrm{range}_{meas}$
\end_inset

，由此计算观测噪声
\begin_inset Formula $R$
\end_inset


\begin_inset Formula 
\[
R=P_{P_{D}}\cdot G_{P_{D}}+\sigma_{range}^{2}+G_{range}\cdot\mathrm{range}_{meas}
\]

\end_inset

计算新息方差
\begin_inset Formula 
\[
S=P+R
\]

\end_inset

计算距地高度新息测试率
\begin_inset Formula 
\[
\mathrm{hagl\_test\_ratio}=\tilde{y}^{2}/\left(\mathrm{gate}^{2}\cdot S\right)
\]

\end_inset

其中新息门限
\begin_inset Formula $\mathrm{gate}=5$
\end_inset

。当距地高度新息测试率
\begin_inset Formula $\mathrm{hagl\_test\_ratio}<1$
\end_inset

时，继续执行卡尔曼滤波的后面两个步骤，否则将该离群的测量值剔除。计算卡尔曼增益
\begin_inset Formula 
\[
K=P/S
\]

\end_inset

更新状态值为
\begin_inset Formula 
\[
\mathrm{terrain}_{vpos}=\mathrm{terrain}_{vpos}-K\cdot\tilde{y}
\]

\end_inset

更新状态不确定性方差
\begin_inset Formula 
\[
P=P−K\cdot P
\]

\end_inset


\end_layout

\begin_layout Standard
由此可以得出最优估计的地形高度
\begin_inset Formula $\mathrm{terrain}_{vpos}$
\end_inset

。
\end_layout

\begin_layout Subsection
光流速度融合
\begin_inset CommandInset label
LatexCommand label
name "subsec:光流速度融合"

\end_inset


\end_layout

\begin_layout Standard
我们有从机体坐标系导航坐标系到的旋转矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

及其逆矩阵
\begin_inset Formula $\left[T\right]_{N}^{B}$
\end_inset

，其第
\begin_inset Formula $3$
\end_inset

行第
\begin_inset Formula $3$
\end_inset

列数值用姿态四元数计算为
\begin_inset Formula $R_{3,3}=q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}$
\end_inset

。根据工况好坏用互补滤波计算得出光流观测方差
\begin_inset Formula $R_{LOS}$
\end_inset

。注意光流测量使用的符号约定：LOS速率是在场景中围绕该轴的右手旋转为正。
\end_layout

\begin_layout Standard
光流传感器直接提供的测量向量有：
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xy}^{flow}$
\end_inset

，围绕
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

机体轴的图像的测量增量角度(
\begin_inset Formula $\mathrm{rad}$
\end_inset

)，右手旋转为正。
\end_layout

\begin_layout Itemize
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xyz}$
\end_inset

，从速率陀螺测量中获得的惯性系绕机体轴的测量增量角度(
\begin_inset Formula $\mathrm{rad}$
\end_inset

)，右手旋转为正。其
\begin_inset Formula $xy$
\end_inset

平面的数据为
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xy}$
\end_inset

。
\end_layout

\begin_layout Standard
计算用测量增量角度
\begin_inset Formula $\boldsymbol{\Delta\theta}_{meas}^{flow}$
\end_inset

需补偿机体运动以计算LOS速率测量值
\begin_inset Formula 
\[
\boldsymbol{\Delta\theta}_{meas}^{flow}=\boldsymbol{\Delta\theta}_{xy}^{flow}-\boldsymbol{\Delta\theta}_{xy}
\]

\end_inset


\end_layout

\begin_layout Standard
首先计算LOS速率测量值。先计算运动补偿的陀螺偏差误差
\begin_inset Formula $\boldsymbol{\Delta\omega}_{bias}^{flow}$
\end_inset

。我们有机体参考增量角
\begin_inset Formula $\boldsymbol{\Delta\theta}_{true}$
\end_inset

和光流测量增量角
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xyz}$
\end_inset

，可计算出光流陀螺偏差误差
\begin_inset Formula $\boldsymbol{\omega}_{bias}^{flow}$
\end_inset


\begin_inset Formula 
\begin{align*}
\boldsymbol{\omega}_{true} & =\boldsymbol{\Delta\theta}_{true}/\Delta t\\
\boldsymbol{\omega}^{flow} & =\boldsymbol{\Delta\theta}_{xyz}/\Delta t\\
\boldsymbol{\omega}_{bias}^{flow} & =0.99\cdot\boldsymbol{\omega}_{bias}^{flow}+0.01\cdot\left(\boldsymbol{\omega}_{true}-\boldsymbol{\omega}^{flow}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
光流测量值去除机体旋转后，图像围绕
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的测量增量角为
\begin_inset Formula $\boldsymbol{\Delta\theta}_{meas}^{flow}$
\end_inset

，即光流已在
\begin_inset Formula $xy$
\end_inset

平面做补偿，将其除以时间
\begin_inset Formula $\Delta t$
\end_inset

可得光流速率。使用光流速率，再去除机体角速率提供的，用于校正进行运动补偿的陀螺偏差误差
\begin_inset Formula $\boldsymbol{\omega}_{bias}^{flow}$
\end_inset

，可计算出光学LOS速率测量值
\begin_inset Formula $\boldsymbol{V}_{meas}^{LOS}$
\end_inset

，
\begin_inset Formula 
\[
\boldsymbol{V}_{meas}^{LOS}=\boldsymbol{\Delta\theta}_{meas}^{flow}/\Delta t+\boldsymbol{\omega}_{bias}^{flow}
\]

\end_inset


\end_layout

\begin_layout Standard
其次计算LOS速率预测值。先计算光流传感器在机体坐标系中的速度。我们有光流传感器从速率陀螺仪测量获得的惯性系绕机体轴的测量增量角
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xyz}$
\end_inset

，根据设置有光流传感器相对于IMU的偏移
\begin_inset Formula $\boldsymbol{\Delta P}^{B}$
\end_inset

，由此计算传感器在机体坐标系中相对于IMU的速度，下式中
\begin_inset Formula $\otimes$
\end_inset

代表向量叉乘，注意，惯性系的增量角
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xyz}$
\end_inset

在机体坐标系中需加负号
\begin_inset Formula 
\[
\boldsymbol{V}_{flow\to IMU}^{B}=-\boldsymbol{\Delta\theta}_{xyz}/\Delta t\otimes\boldsymbol{\Delta P}^{B}
\]

\end_inset

计算光流传感器在地球坐标系中的速度
\begin_inset Formula 
\[
\boldsymbol{V}_{flow}^{I}=\boldsymbol{V}_{NED}+\left[T\right]_{B}^{N}\cdot\boldsymbol{V}_{flow\to IMU}^{B}
\]

\end_inset

计算光流传感器在机体坐标系中的相对速度
\begin_inset Formula 
\[
\boldsymbol{V}_{flow}^{B}=\left[\begin{array}{c}
V_{X}\\
V_{Y}\\
V_{Z}
\end{array}\right]=\left[T\right]_{N}^{B}\cdot\boldsymbol{V}_{flow}^{I}
\]

\end_inset


\end_layout

\begin_layout Standard
距离(range)为从摄像机焦点到传感器视场(field of view, fov)中心的距离，由以下方程计算：
\begin_inset Formula 
\begin{align*}
\mathrm{range} & =H^{agl}/R_{3,3}\\
 & =\left(\mathrm{terrain}_{vpos}-P_{D}\right)/\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
将相对速度除以距离(range)得到相对于
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的预测视轴角速率
\begin_inset Formula $\boldsymbol{V}_{pred}^{LOS}$
\end_inset

(注：这些是已经过机体角速度运动补偿的光流速度)：
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
V_{X}^{LOS} & =+V_{Y}/\mathrm{range}\\
V_{Y}^{LOS} & =-V_{X}/\mathrm{range}\\
\boldsymbol{V}_{pred}^{LOS} & =\left[\begin{array}{c}
V_{X}^{LOS}\\
V_{Y}^{LOS}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
分别计算
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的观测Jacobian矩阵：
\begin_inset Formula 
\begin{align*}
H_{flow}^{X,Y} & =\dfrac{\partial\left(V_{X}^{LOS},V_{Y}^{LOS}\right)}{\partial\left(\mathrm{terrain}_{vpos}\right)}\\
 & =\dfrac{\partial\left(\dfrac{+V_{Y}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-P_{D}\right)},\dfrac{-V_{X}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-P_{D}\right)}\right)}{\partial\left(\mathrm{terrain}_{vpos}\right)}\\
 & =\left(\dfrac{+V_{Y}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-P_{D}\right)^{2}},\dfrac{-V_{X}\left(q_{0}^{2}-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}\right)}{\left(\mathrm{terrain}_{vpos}-P_{D}\right)^{2}}\right)
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
分别计算
\begin_inset Formula $X$
\end_inset

和
\begin_inset Formula $Y$
\end_inset

轴的新息及其协方差和卡尔曼增益，两次校正地形高度
\begin_inset Formula $\mathrm{terrain}_{vpos}$
\end_inset

，剩下的步骤和上一节类似。由此可以得出最优估计的地形高度
\begin_inset Formula $\mathrm{terrain}_{vpos}$
\end_inset

。
\end_layout

\begin_layout Section
使用 IMU 和 GPS 进行偏航对准
\begin_inset CommandInset label
LatexCommand label
name "sec:使用IMU和GPS进行偏航对准"

\end_inset


\end_layout

\begin_layout Subsection
EKF-GSF 偏航估计器描述
\end_layout

\begin_layout Standard
该算法能在没有磁力计或外部偏航传感器的情况下运行，其目的是自动校正偏航误差引起的起飞后导航损失。它可以从不良磁偏航引起的起飞后导航故障中快速自动恢复。
\end_layout

\begin_layout Standard
ECL项目自2018年起进行的初步算法工作，以确定是否有可能仅使用 IMU 和 GPS 速度数据快速确定偏航角(yaw)，而不依赖机体动力学的假设。最后确定使用
多个 EKF 状态的高斯和滤波器(Gaussian Sum Filter, GSF)算法，即EKF-GSF，因其为应用提供了最佳的性能/计算成本权衡。
\end_layout

\begin_layout Standard
EKF-GSF算法也是在24-EKF之外又一个EKF实现，包括以下内容：
\end_layout

\begin_layout Itemize
使用互补滤波器的
\begin_inset Formula $5$
\end_inset

组AHRS的解
\end_layout

\begin_deeper
\begin_layout Itemize
这些计算预测偏航角和向前、向右加速度。
\end_layout

\begin_layout Itemize
空速(测量或估计)用于固定翼飞机飞行期间的向心加速度校正。
\end_layout

\end_deeper
\begin_layout Itemize
\begin_inset Formula $5$
\end_inset

组
\begin_inset Formula $3$
\end_inset

参数状态扩展卡尔曼滤波器
\end_layout

\begin_deeper
\begin_layout Itemize
状态为向北(N)、向东(E)速度和偏航角。
\end_layout

\begin_layout Itemize
偏航角估算开始时的角度间隔相等，
\begin_inset Formula $\left[\begin{array}{ccccc}
-4/5\pi & -2/5\pi & 0 & 2/5\pi & 4/5\pi\end{array}\right]$
\end_inset

。
\end_layout

\begin_layout Itemize
GPS的向北(N)、向东(E)速度作为观测值。
\end_layout

\end_deeper
\begin_layout Itemize
高斯和滤波器(Gaussian Sum Filter)
\end_layout

\begin_deeper
\begin_layout Itemize
根据标准化GPS的向北(N)、向东(E)速度新息数值级别计算每个EKF的权重。总权重为
\begin_inset Formula $1$
\end_inset

。
\end_layout

\begin_layout Itemize
输出偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

估计值，这是单个EKF估计值的加权平均值。
\end_layout

\end_deeper
\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
GSF-EKF过程框图如下：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename EKF-GSF.png
	scale 35

\end_inset


\end_layout

\begin_layout Standard
该算法运行要求无人机在起飞和初始水平运动时必须处于不需要位置固定模式(Position Control Mode)，让无人机水平移动一段距离。根据实验，无人机大
约在
\begin_inset Formula $1\mathrm{s}$
\end_inset

左右移动
\begin_inset Formula $4\mathrm{m}$
\end_inset

左右的距离，EKF 将自动对准偏航并开始使用 GPS，从而启用位置固定模式。测试结果表明：
\end_layout

\begin_layout Itemize
GSF权重在单个EKF滤波器之前收敛。
\end_layout

\begin_layout Itemize
要求水平速度变化大于GPS速度不确定性。
\end_layout

\begin_layout Itemize
速度变化越大，收敛速度越快。
\end_layout

\begin_layout Itemize
由于失去导航，速度变化较大，导致在
\begin_inset Formula $1\mathrm{s}$
\end_inset

内收敛。
\end_layout

\begin_layout Subsection
偏航估计器的算法直觉
\end_layout

\begin_layout Standard
EKF-GSF算法是一个很新奇也很有创意的算法。不论是在KF方面还是在传感器方面，以及无人机的运动特性方面，设计者在技术方面和工程方面都已经炉火纯青、游刃有余。
该算法基于动力学方程设计，虽然在数学方面还有说不清的地方，但是KF同样擅长在相关性领域工作，建模不一定要因果关系。
\end_layout

\begin_layout Standard
首先该算法一个假设就是偏航角由
\begin_inset Formula $xy$
\end_inset

水平面的向北(N)、向东(E)的增量速度和绕
\begin_inset Formula $z$
\end_inset

轴旋转的增量角度所驱动，所以偏航角的测量误差也和这
\begin_inset Formula $3$
\end_inset

个值的测量噪声相关
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\psi_{error}\propto\left(\sigma_{\Delta V_{x}}^{2},\sigma_{\Delta V_{y}}^{2},\sigma_{\Delta\psi}^{2}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
这
\begin_inset Formula $3$
\end_inset

个值和
\begin_inset Formula $3$
\end_inset

个噪声由IMU提供。于是我们可以在
\begin_inset Formula $xy$
\end_inset

水平面上面预置
\begin_inset Formula $5$
\end_inset

个偏航角
\begin_inset Formula $\psi_{i},i\in1\sim5$
\end_inset

，每个偏航角由这
\begin_inset Formula $3$
\end_inset

个值和
\begin_inset Formula $3$
\end_inset

个噪声驱动演化，独立进行时间更新。在测量更新阶段，我们观测GPS提供的
\begin_inset Formula $xy$
\end_inset

水平面的向北(N)、向东(E)的速度，因为残差的存在，这
\begin_inset Formula $5$
\end_inset

个偏航角
\begin_inset Formula $\psi_{i}$
\end_inset

会向真实的偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

聚拢，但是真实的偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

不可见。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-01.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
不过我们可以通过高斯和的算法，计算这
\begin_inset Formula $5$
\end_inset

个偏航角
\begin_inset Formula $\psi_{i}$
\end_inset

的权重并相加，得到距离真实的偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

最近的复合偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-02.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
因此该算法就可以在没有磁力计的情况下估计偏航角，并且是水平速度变化越大，收敛越快。
\end_layout

\begin_layout Subsection
偏航估计器的初始化与对准
\end_layout

\begin_layout Subsubsection
偏航估计器的初始化
\end_layout

\begin_layout Standard
初始化的关键在于在
\begin_inset Formula $xy$
\end_inset

平面上预制
\begin_inset Formula $5$
\end_inset

个偏航角，平均间隔，平均权重。其它初始化都是常规操作。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-00.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Subsubsection
AHRS倾斜对准
\end_layout

\begin_layout Standard
倾斜对准就是考虑如何从增量速度计算旋转矩阵。旋转矩阵直接从加速度测量中构造，对于所有模型都是相同的，因此只需计算一次。其假设是：
\end_layout

\begin_layout Enumerate
偏航角为零
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

当速度融合开始时，每个模型的偏航角稍后对准。
\end_layout

\begin_layout Enumerate
机体没有加速，因此所有测量的加速度都是由重力引起的。
\end_layout

\begin_layout Standard
用
\begin_inset Formula $\Delta t$
\end_inset

表示传感器事件间隔时间。从主模块得到的加速度
\begin_inset Formula $\boldsymbol{a}^{I}$
\end_inset

(参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:计算当前加速度、速度和位置"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节)计算得到增量速度
\begin_inset Formula $\boldsymbol{\Delta V}^{I}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{\Delta V}^{I}=\boldsymbol{a}^{I}\cdot\Delta t
\]

\end_inset

这是地球坐标系中的数据，需要转换到机体坐标系中并归一得到重力
\begin_inset Formula $D$
\end_inset

轴方向的单位向量
\begin_inset Formula 
\[
\boldsymbol{D}^{B}=-\boldsymbol{\Delta V}^{I}/\left\Vert \boldsymbol{\Delta V}^{I}\right\Vert 
\]

\end_inset


\end_layout

\begin_layout Standard
计算地球坐标系向北
\begin_inset Formula $N$
\end_inset

轴的单位向量，旋转为机体坐标系，与
\begin_inset Formula $\boldsymbol{D}^{B}$
\end_inset

正交
\begin_inset Formula 
\begin{align*}
\boldsymbol{N}^{B} & =\left[\begin{array}{c}
1\\
0\\
0
\end{array}\right]-\boldsymbol{D}^{B}\cdot\left(\left[\begin{array}{ccc}
1 & 0 & 0\end{array}\right]\boldsymbol{D}^{B}\right)\\
\boldsymbol{N}^{B} & =\boldsymbol{N}^{B}/\left\Vert \boldsymbol{N}^{B}\right\Vert 
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算地球坐标系向东
\begin_inset Formula $E$
\end_inset

轴的单位向量，旋转为机体坐标系，与
\begin_inset Formula $\boldsymbol{D}^{B}$
\end_inset

和
\begin_inset Formula $\boldsymbol{N}^{B}$
\end_inset

正交
\begin_inset Formula 
\[
\boldsymbol{E}^{B}=\boldsymbol{D}^{B}\times\boldsymbol{N}^{B}
\]

\end_inset


\end_layout

\begin_layout Standard
从地球坐标系到机体坐标系的旋转矩阵中的每一列表示旋转到机体坐标系的相应地球坐标系单位向量的投影，例如
\begin_inset Formula $\boldsymbol{N}^{B}$
\end_inset

将是第一列。我们需要从机体坐标系到地球坐标系的旋转矩阵，因此旋转到机体坐标系的地球坐标系单位向量被复制到相应的行中
\begin_inset Formula 
\[
\left[T\right]_{B}^{N}=\left[\begin{array}{ccc}
\boldsymbol{N}^{B} & \boldsymbol{E}^{B} & \boldsymbol{D}^{B}\end{array}\right]^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
倾斜对准完成后即可对每一个模型进行时间更新。
\end_layout

\begin_layout Subsubsection
AHRS偏航角对准
\end_layout

\begin_layout Standard
其算法是根据最新的偏航角
\begin_inset Formula $\psi$
\end_inset

更新欧拉角向量，进而生成新的姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

。在24-EKF算法之外，在EKF-GSF算法中为每一个模型用增益系数法维护一个独立的姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

，用于后面的算法中。
\end_layout

\begin_layout Standard
偏航角对准完成后可对每一个模型进行测量更新。
\end_layout

\begin_layout Subsubsection
AHRS预测
\end_layout

\begin_layout Standard
在每次时间更新前先从IMU数据生成姿态基准，即每一个模型的姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

被IMU数据驱动往前旋转了一个角度。所用数据为IMU数据及真实空速(固定翼飞机)，并用加速度融合增益系数和陀螺仪偏差增益系数进行计算。最后计算得到一个校正后的增
量角度，将其应用到姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

就得到新的姿态矩阵。
\end_layout

\begin_layout Subsubsection
AHRS更新
\end_layout

\begin_layout Standard
同样的，在每次测量更新之后，需要对姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

进行更新。因为增量偏航角
\begin_inset Formula $\Delta\psi$
\end_inset

发生在
\begin_inset Formula $xy$
\end_inset

平面上，所以利用偏航旋转矩阵的稀疏性可以对姿态矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset

做优化更新。
\end_layout

\begin_layout Subsection
偏航估计器的预测方程
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\psi$
\end_inset

表示机体坐标系相对于地球坐标系的偏航角(yaw)。
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\boldsymbol{V}_{NE}$
\end_inset

表示机体在世界坐标系中的向北(N)和向东(E)的速度，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\boldsymbol{V}_{NE}=\left[\begin{array}{c}
V_{N}\\
V_{E}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
令
\begin_inset Formula $\Delta\psi$
\end_inset

表示IMU的
\begin_inset Formula $z$
\end_inset

轴在机体轴上的增量角度测量值，即增量偏航角的测量值。
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\sigma_{\Delta\psi}^{2}$
\end_inset

表示IMU的
\begin_inset Formula $z$
\end_inset

轴增量角度测量方差值。
\end_layout

\begin_layout Standard
令
\begin_inset Formula $\boldsymbol{\Delta V}_{xy}$
\end_inset

表示IMU的
\begin_inset Formula $x$
\end_inset

轴和
\begin_inset Formula $y$
\end_inset

轴在机体轴上的增量速度测量值
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{xy}=\left[\begin{array}{c}
\Delta V_{x}\\
\Delta V_{y}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
令
\begin_inset Formula $\boldsymbol{\sigma}_{\boldsymbol{\Delta V}xy}^{2}$
\end_inset

表示IMU的
\begin_inset Formula $x$
\end_inset

轴和
\begin_inset Formula $y$
\end_inset

轴增量速度测量方差
\begin_inset Formula 
\[
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}xy}^{2}=\left[\begin{array}{c}
\sigma_{\Delta V_{x}}^{2}\\
\sigma_{\Delta V_{y}}^{2}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
推导机体到导航方向的变换矩阵(2D)
\begin_inset Formula 
\[
\left[T\right]_{B}^{N}=\left[\begin{array}{cc}
\cos\left(\psi\right) & -\sin\left(\psi\right)\\
\sin\left(\psi\right) & \cos\left(\psi\right)
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
姿态更新方程
\begin_inset Formula 
\[
\psi^{\prime}=\psi+\Delta\psi
\]

\end_inset


\end_layout

\begin_layout Standard
速度更新方程
\begin_inset Formula 
\[
\boldsymbol{V}_{NE}^{\prime}=\boldsymbol{V}_{NE}+\left[T\right]_{B}^{N}\boldsymbol{\Delta V}_{xy}
\]

\end_inset


\end_layout

\begin_layout Standard
定义状态向量
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k-1|k-1}=\left[\begin{array}{c}
\boldsymbol{V}_{NE}\\
\psi
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
定义过程方程的向量
\begin_inset Formula 
\[
\hat{\boldsymbol{x}}_{k|k-1}=\left[\begin{array}{c}
\boldsymbol{V}_{NE}^{\prime}\\
\psi^{\prime}
\end{array}\right]
\]

\end_inset

此即方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:1"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，预测 (先验) 状态估计。
\end_layout

\begin_layout Standard
计算状态转移矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{F} & =\dfrac{\partial\hat{\boldsymbol{x}}_{k|k-1}}{\partial\hat{\boldsymbol{x}}_{k-1|k-1}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
V_{N}+\cos\left(\psi\right)\Delta V_{x}-\sin\left(\psi\right)\Delta V_{y}\\
V_{E}+\sin\left(\psi\right)\Delta V_{x}+\cos\left(\psi\right)\Delta V_{y}\\
\psi+\Delta\psi
\end{array}\right]\right)}{\partial\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
\psi
\end{array}\right]\right)}\\
 & =\left[\begin{array}{ccc}
1 & 0 & -\sin\left(\psi\right)\Delta V_{x}-\cos\left(\psi\right)\Delta V_{y}\\
0 & 1 & \cos\left(\psi\right)\Delta V_{x}-\sin\left(\psi\right)\Delta V_{y}\\
0 & 0 & 1
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
定义控制(干扰)向量
\begin_inset Formula 
\[
\boldsymbol{u}=\left[\begin{array}{c}
\boldsymbol{\Delta V}_{xy}\\
\Delta\psi
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
推导协方差预测方程。在消除偏差效应后，假设惯性解中的误差增长由增量角度和增量速度中的“噪声”驱动。推导IMU噪声到状态噪声的
\begin_inset Formula $3\times3$
\end_inset

控制(干扰)影响矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{G} & =\dfrac{\partial\hat{\boldsymbol{x}}_{k|k-1}}{\partial\boldsymbol{u}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
V_{N}+\cos\left(\psi\right)\Delta V_{x}-\sin\left(\psi\right)\Delta V_{y}\\
V_{E}+\sin\left(\psi\right)\Delta V_{x}+\cos\left(\psi\right)\Delta V_{y}\\
\psi+\Delta\psi
\end{array}\right]\right)}{\partial\left(\left[\begin{array}{c}
\Delta V_{x}\\
\Delta V_{y}\\
\Delta\psi
\end{array}\right]\right)}\\
 & =\left[\begin{array}{ccc}
\cos\left(\psi\right) & -\sin\left(\psi\right) & 0\\
\sin\left(\psi\right) & \cos\left(\psi\right) & 0\\
0 & 0 & 1
\end{array}\right]
\end{align*}

\end_inset

这实际上是在
\begin_inset Formula $xy$
\end_inset

平面上的旋转矩阵。
\end_layout

\begin_layout Standard
定义干扰(disturbance)矩阵，即
\begin_inset Formula $3\times3$
\end_inset

过程噪声矩阵
\begin_inset Formula 
\[
\boldsymbol{D}=\mathrm{diag}\left(\left[\begin{array}{c}
\boldsymbol{\sigma}_{\boldsymbol{\Delta V}xy}^{2}\\
\sigma_{\Delta\psi}^{2}
\end{array}\right]\right)
\]

\end_inset


\end_layout

\begin_layout Standard
推导状态误差矩阵，即过程噪声协方差矩阵
\begin_inset Formula 
\[
\boldsymbol{Q}=\boldsymbol{G}\boldsymbol{D}\boldsymbol{G}^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
传播协方差矩阵
\begin_inset Formula 
\[
\boldsymbol{P}_{k|k-1}=\boldsymbol{F}\boldsymbol{P}_{k-1|k-1}\boldsymbol{F}^{\mathrm{T}}+\boldsymbol{Q}
\]

\end_inset

此即方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

)，预测 (先验) 估计协方差。
\end_layout

\begin_layout Subsection
偏航估计器的观测方程
\end_layout

\begin_layout Standard
由GPS提供的向北(N)、向东(E)速度观测值为
\begin_inset Formula 
\[
\boldsymbol{V}_{GPS}=\left[\begin{array}{c}
V_{GPS_{N}}\\
V_{GPS_{E}}
\end{array}\right]
\]

\end_inset

其方差为
\begin_inset Formula $\sigma_{\Delta V_{GPS}}^{2}$
\end_inset

，由此构建
\begin_inset Formula $2\times2$
\end_inset

测量噪声矩阵
\begin_inset Formula 
\[
\boldsymbol{R}=\mathrm{diag}\left(\left[\begin{array}{c}
\sigma_{\Delta V_{GPS}}^{2}\\
\sigma_{\Delta V_{GPS}}^{2}
\end{array}\right]\right)
\]

\end_inset


\end_layout

\begin_layout Standard
因为是对速度的直接观测，所以测量矩阵比较简单
\begin_inset Formula 
\[
\boldsymbol{H}=\left[\begin{array}{ccc}
1 & 0 & 0\\
0 & 1 & 0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
推导向北(N)、向东(E)速度观测的协方差更新方程，即方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:3"
plural "false"
caps "false"
noprefix "false"

\end_inset

)、方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4"
plural "false"
caps "false"
noprefix "false"

\end_inset

)和方程(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:5"
plural "false"
caps "false"
noprefix "false"

\end_inset

)
\begin_inset Formula 
\begin{align*}
\tilde{\boldsymbol{y}} & =\boldsymbol{H}\hat{\boldsymbol{x}}_{k|k-1}-\boldsymbol{V}_{GPS}\\
\boldsymbol{S} & =\boldsymbol{H}\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{\mathrm{T}}+\boldsymbol{R}\\
\boldsymbol{K} & =\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{\mathrm{T}}\boldsymbol{S}^{-1}\\
\hat{\boldsymbol{x}}_{k|k} & =\hat{\boldsymbol{x}}_{k|k-1}-\boldsymbol{K}\tilde{\boldsymbol{y}}\\
\boldsymbol{P}_{k|k} & =\boldsymbol{P}_{k|k-1}-\boldsymbol{K}\boldsymbol{S}\boldsymbol{K}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Subsection
偏航估计器的GSF方程
\end_layout

\begin_layout Standard
对每个模型的状态计算高斯密度。首先计算马式距离(
\begin_inset CommandInset href
LatexCommand href
name "Mahalanobis distance"
target "https://en.wikipedia.org/wiki/Mahalanobis_distance"
literal "false"

\end_inset

)
\begin_inset Formula 
\[
D_{M}^{2}=\tilde{\boldsymbol{y}}^{\mathrm{T}}\boldsymbol{S}^{-1}\tilde{\boldsymbol{y}}
\]

\end_inset

再计算2D正态分布(
\begin_inset CommandInset href
LatexCommand href
name "Multivariate Normal Distribution"
target "https://online.stat.psu.edu/stat505/book/export/html/636"
literal "false"

\end_inset

)的密度
\begin_inset Formula 
\[
\mathrm{Density}=\left(\dfrac{1}{2}\right)^{p/2}\sqrt{\det\left(\boldsymbol{S}^{-1}\right)}\exp\left(-\dfrac{D_{M}^{2}}{2}\right)
\]

\end_inset

其中我们观测的是
\begin_inset Formula $2\times1$
\end_inset

速度向量，所以
\begin_inset Formula $p=2$
\end_inset

。
\end_layout

\begin_layout Standard
计算
\begin_inset Formula $5$
\end_inset

组AHRS的解的权重并归一
\begin_inset Formula 
\begin{align*}
W_{i}^{\prime} & =\mathrm{Density}_{i}\cdot W_{i}\\
\boldsymbol{W} & =\boldsymbol{W}^{\prime}/\left\Vert \boldsymbol{W}^{\prime}\right\Vert 
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
用每个模型的偏航状态的加权平均值以计算复合偏航向量。为避免角度回绕问题，在求和之前，将偏航状态转换为长度等于权重值为
\begin_inset Formula $1$
\end_inset

的向量
\begin_inset Formula 
\begin{align*}
x & =\sum_{i=1}^{5}W_{i}\cdot\cos\left(\psi_{i}\right)\\
y & =\sum_{i=1}^{5}W_{i}\cdot\sin\left(\psi_{i}\right)\\
\psi_{GSF} & =\mathrm{atan2}\left(y,x\right)
\end{align*}

\end_inset

该算法原理在于将每一个偏航状态
\begin_inset Formula $\psi_{i}$
\end_inset

看成是一个从原点出发的向量，因而在
\begin_inset Formula $x/y$
\end_inset

轴上的投影通过权重缩放后相加，就得到单位圆上的一个向量，因而求出加权复合偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

，该值将在第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:姿态的初始化值与对准"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章“姿态的初始化值与对准”中使用。
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename EKF-GSF-03.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
根据每个模型方差的加权平均值计算偏航状态的复合方差。具有较大新息的模型的权重较小
\begin_inset Formula 
\begin{align*}
\Delta\psi_{i} & =\psi_{i}-\psi_{GSF}\\
\sigma_{\psi_{GSF}}^{2} & =\sum_{i=1}^{5}W_{i}\cdot\left(P_{i}\left(3,3\right)+\Delta\psi_{i}^{2}\right)
\end{align*}

\end_inset

其中
\begin_inset Formula $P_{i}\left(3,3\right)$
\end_inset

为第
\begin_inset Formula $i$
\end_inset

组的协方差矩阵
\begin_inset Formula $\boldsymbol{P}_{i}$
\end_inset

中偏航角
\begin_inset Formula $\psi_{i}$
\end_inset

的方差。
\end_layout

\begin_layout Section
姿态的初始化值与对准
\begin_inset CommandInset label
LatexCommand label
name "sec:姿态的初始化值与对准"

\end_inset


\end_layout

\begin_layout Standard
对于卡尔曼滤波器的状态向量的初始值，可以将其设置为任意值，经过多轮迭代，最终都将收敛到距离真实值最近的数值。但是，如果在初始化时将其设置为较为接近真实值的数值，
则可以有效地减少迭代时间。这种设置，称之为对准。并且，当传感器受到外界的干扰，很容易造成估计值的无限制漂移。因此在ECL估计系统运行过程中，会使用几种不同原理的
估计器相互校验，对于误差较大的估计器，将其重置(重新对准)，以约束估计值的漂移。
\end_layout

\begin_layout Standard
姿态的初始化分为倾斜对准(tilt alignment)和偏航角对准(yaw alignment)两个阶段。其中偏航角对准的运行流程最为复杂，因为偏航角
\begin_inset Formula $\psi$
\end_inset

的主要由磁力计和GPS进行校正，而这两种传感器很容易受到外界的干扰，磁力计的问题主要是地磁本身太弱、很容易被环境干扰，GPS的问题主要是其信号很容易被山势、植被
和建筑物阻挡和干扰，因此在干扰大的环境中，偏航角
\begin_inset Formula $\psi$
\end_inset

经常需要重置(重新对准)。
\end_layout

\begin_layout Subsection
倾斜对准
\end_layout

\begin_layout Standard
因为能够校正
\begin_inset Formula $xy$
\end_inset

水平面的传感器数据比较多，干扰也较少，所以当姿态四元数
\begin_inset Formula $q$
\end_inset

设置好初值后，很快就可以迭代出较为精确的横滚角
\begin_inset Formula $\phi$
\end_inset

和俯仰角
\begin_inset Formula $\theta$
\end_inset

，因此倾斜对准只需要判断用三维旋转向量表示的姿态的
\begin_inset Formula $xy$
\end_inset

水平面的方差和小于阈值，即可认为估计系统完成倾斜对准。其算法比较简单。
\end_layout

\begin_layout Standard
我们有表示姿态的单位四元数
\begin_inset Formula $q$
\end_inset

，用
\begin_inset Formula $\boldsymbol{q}$
\end_inset

表示其向量部分，
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
q & =\left[\begin{array}{c}
q_{0}\\
q_{1}\\
q_{2}\\
q_{3}
\end{array}\right]=\left[\begin{array}{c}
q_{0}\\
\boldsymbol{q}
\end{array}\right]\\
 & =\left[\begin{array}{c}
\cos\left(\theta/2\right)\\
\boldsymbol{u}\sin\left(\theta/2\right)
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
相应有一个旋转向量
\begin_inset Formula $\boldsymbol{\theta}=\boldsymbol{u}\theta$
\end_inset

，其中
\begin_inset Formula $\boldsymbol{u}$
\end_inset

为表示旋转轴的单位向量，
\begin_inset Formula $\theta$
\end_inset

为旋转角度。
\end_layout

\begin_layout Standard
将姿态四元数
\begin_inset Formula $q$
\end_inset

变换为旋转向量
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

的方程为
\begin_inset Formula 
\begin{align*}
\theta & =2\arccos\left(q_{0}\right)\\
\boldsymbol{\theta} & =\dfrac{\theta}{\sin\left(\theta/2\right)}\boldsymbol{q}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算四元数到旋转向量的转移矩阵，为
\begin_inset Formula $3\times4$
\end_inset

矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{G} & =\dfrac{\partial\boldsymbol{\theta}}{\partial q}\\
 & =\dfrac{\partial\left(\dfrac{\theta}{\sin\left(\theta/2\right)}\boldsymbol{q}\right)}{\partial\left(\left[\begin{array}{c}
q_{0}\\
\boldsymbol{q}
\end{array}\right]\right)}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
姿态四元数
\begin_inset Formula $q$
\end_inset

的协方差矩阵
\begin_inset Formula $\boldsymbol{P}_{q}$
\end_inset

为24-EKF的
\begin_inset Formula $\boldsymbol{P}$
\end_inset

矩阵的左上角
\begin_inset Formula $4\times4$
\end_inset

部分。将协方差矩阵从四元数旋转到旋转向量为
\begin_inset Formula 
\[
\boldsymbol{P}_{rv}=\boldsymbol{G}\boldsymbol{P}_{q}\boldsymbol{G}^{\mathrm{T}}
\]

\end_inset

取出协方差矩阵
\begin_inset Formula $\boldsymbol{P}_{rv}$
\end_inset

的对角线元素即为旋转向量
\begin_inset Formula $x/y/z$
\end_inset

三轴的方差向量
\begin_inset Formula $\left[\begin{array}{ccc}
\sigma_{rv_{x}}^{2} & \sigma_{rv_{y}}^{2} & \sigma_{rv_{z}}^{2}\end{array}\right]^{\mathrm{T}}$
\end_inset

。我们设置倾斜对准的标准差为
\begin_inset Formula $3^{\circ}$
\end_inset

，方差和小于此阈值即认为倾斜对准，判断方程为
\begin_inset Formula 
\[
\sigma_{rv_{x}}^{2}+\sigma_{rv_{y}}^{2}<\left(\dfrac{3^{\circ}}{180^{\circ}}\pi\right)^{2}
\]

\end_inset


\end_layout

\begin_layout Standard
相对应的，我们也可以预置旋转向量的方差向量
\begin_inset Formula $\left[\begin{array}{ccc}
\sigma_{rv_{x}}^{2} & \sigma_{rv_{y}}^{2} & \sigma_{rv_{z}}^{2}\end{array}\right]^{\mathrm{T}}$
\end_inset

，并将其变换为姿态四元数
\begin_inset Formula $q$
\end_inset

的协方差矩阵
\begin_inset Formula $\boldsymbol{P}_{q}$
\end_inset

的初始化值。将旋转向量
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

变换为姿态四元数
\begin_inset Formula $q$
\end_inset

的方程为
\begin_inset Formula 
\begin{align*}
\theta & =\left\Vert \boldsymbol{\theta}\right\Vert \\
q & =\left[\begin{array}{c}
\cos\left(\dfrac{\theta}{2}\right)\\
\dfrac{\boldsymbol{\theta}}{\left\Vert \boldsymbol{\theta}\right\Vert }\sin\left(\dfrac{\theta}{2}\right)
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算旋转向量到四元数的转移矩阵，为
\begin_inset Formula $4\times3$
\end_inset

矩阵
\begin_inset Formula 
\begin{align*}
\boldsymbol{G} & =\dfrac{\partial q}{\partial\boldsymbol{\theta}}\\
 & =\dfrac{\partial\left(\left[\begin{array}{c}
\cos\left(\dfrac{\theta}{2}\right)\\
\dfrac{\boldsymbol{\theta}}{\left\Vert \boldsymbol{\theta}\right\Vert }\sin\left(\dfrac{\theta}{2}\right)
\end{array}\right]\right)}{\partial\boldsymbol{\theta}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
旋转向量
\begin_inset Formula $\boldsymbol{\theta}$
\end_inset

的协方差矩阵
\begin_inset Formula $\boldsymbol{P}_{rv}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{P}_{rv}=\mathrm{diag}\left(\left[\begin{array}{c}
\sigma_{rv_{x}}^{2}\\
\sigma_{rv_{y}}^{2}\\
\sigma_{rv_{z}}^{2}
\end{array}\right]\right)
\]

\end_inset


\end_layout

\begin_layout Standard
将协方差矩阵旋转为四元数坐标
\begin_inset Formula 
\[
\boldsymbol{P}_{q}=\boldsymbol{G}\boldsymbol{P}_{rv}\boldsymbol{G}^{\mathrm{T}}
\]

\end_inset


\end_layout

\begin_layout Standard
设置姿态四元数
\begin_inset Formula $q$
\end_inset

的算法比较简单。我们先设置姿态四元数
\begin_inset Formula $q=\left[\begin{array}{cccc}
1 & 0 & 0 & 0\end{array}\right]^{\mathrm{T}}$
\end_inset

，并假定飞行器开机时处于相对静止状态，判断为
\begin_inset Formula 
\begin{align*}
0.8g & <\left\Vert \boldsymbol{a}\right\Vert <1.2g\\
15^{\circ}/s & <\left\Vert \boldsymbol{\omega}\right\Vert 
\end{align*}

\end_inset

此时加速度
\begin_inset Formula $\boldsymbol{a}$
\end_inset

的数值大多为重力加速度，将其分解就得到欧拉角中的横滚角
\begin_inset Formula $\phi$
\end_inset

和俯仰角
\begin_inset Formula $\theta$
\end_inset

，
\begin_inset Formula 
\begin{align*}
\phi & =\mathrm{atan2}\left(-a_{y},-a_{z}\right)\\
\theta & =\mathrm{asin}\left(a_{x}\right)
\end{align*}

\end_inset

并假定偏航角
\begin_inset Formula $\psi=0$
\end_inset

，将该欧拉角变换为四元数即可得到姿态初值。
\end_layout

\begin_layout Subsection
应用GPS的偏航角对准
\end_layout

\begin_layout Standard
采用GPS强制重新校准偏航角，以与GPS的水平速度向量对准。它仅用于固定翼飞行器在发射或起飞后对准偏航角。它的使用条件比较严格，需要至少
\begin_inset Formula $5\ m/s$
\end_inset

的GPS水平速度，并且速度误差与速度之比小于
\begin_inset Formula $0.15$
\end_inset

才能进行可靠对准。算法假设机体为近水平姿态。
\end_layout

\begin_layout Standard
计算GPS航线过地(course over ground, COG)角度
\begin_inset Formula 
\[
COG_{GPS}=\mathrm{atan2}\left(V_{GPS_{E}},V_{GPS_{N}}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
计算EKF航线偏航角
\begin_inset Formula 
\[
COG_{EKF}=\mathrm{atan2}\left(V_{E},V_{N}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
检查EKF和GPS的航线过地角度是否一致
\begin_inset Formula 
\[
\psi_{Error}=COG_{GPS}-COG_{EKF}
\]

\end_inset


\end_layout

\begin_layout Standard
如果角度不一致(
\begin_inset Formula $\psi_{Error}>0.5\ \mathrm{rad}$
\end_inset

)，并且GPS水平速度新息较大(由第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS速度和水平位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节方程计算)，或者之前没有进行偏航对准，则使用GPS地面航道校正偏航角。
\end_layout

\begin_layout Standard
计算新的偏航角估计有三种情况：
\end_layout

\begin_layout Enumerate
当我们第一次飞行对准时，我们可以假设最近的速度变化是由于向前起飞或发射造成的，因此在姿态四元数中的惯性偏航角
\begin_inset Formula $\psi_{q}$
\end_inset

和GPS地面航线的差异是由于偏航误差造成的。
\end_layout

\begin_layout Enumerate
我们之前已经在飞行中对准了偏航，并对风进行了估算，因此设置了偏航值，以使飞行器机头与风场相对GPS速度向量对准。
\end_layout

\begin_layout Enumerate
我们没有风场的估计，所以将偏航与GPS速度向量对准。
\begin_inset Formula 
\[
\psi=\begin{cases}
\psi_{q}+\psi_{Error} & \text{first time}\\
\mathrm{atan2}\left(V_{GPS_{E}}-V_{wind_{E}},V_{GPS_{N}}-V_{wind_{N}}\right) & \text{have wind estimates}\\
\mathrm{atan2}\left(V_{GPS_{E}},V_{GPS_{N}}\right) & \text{no wind estimates}
\end{cases}
\]

\end_inset


\end_layout

\begin_layout Standard
使用组合的EKF和GPS的速度方差来计算对准后偏航误差的粗略估计
\begin_inset Formula 
\begin{align*}
\sigma_{V_{Error}}^{2} & =\mathrm{accuracy}_{GPS\_speed}^{2}+\sigma_{V_{N}}^{2}+\sigma_{V_{E}}^{2}\\
V_{GPS} & =\sqrt{V_{GPS_{E}}^{2}+V_{GPS_{N}}^{2}}\\
\sin\left(\psi_{Error}\right) & =\dfrac{\sqrt{\sigma_{V_{Error}}^{2}}}{V_{GPS}}\\
\sigma_{\psi}^{2} & =\left(\arcsin\left(\sin\left(\psi_{Error}\right)\right)\right)^{2}
\end{align*}

\end_inset

由此将新的偏航角
\begin_inset Formula $\psi$
\end_inset

和偏航角方差
\begin_inset Formula $\sigma_{\psi}^{2}$
\end_inset

应用于姿态四元数
\begin_inset Formula $q$
\end_inset

及其协方差。接着使用最新的磁力计测量值(机体坐标系中的向量)重置磁场状态
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{I} & =\boldsymbol{R}\left(q\right)\cdot\boldsymbol{M}_{meas}\\
\boldsymbol{M}_{B} & =\boldsymbol{0}
\end{align*}

\end_inset


\end_layout

\begin_layout Subsection
应用磁力计的偏航角对准
\end_layout

\begin_layout Standard
在大多数室外情况下，如果外部环境没有强磁干扰，则应用磁力计的偏航角对准。室内(INDOOR)情况不适用该方法。
\end_layout

\begin_layout Standard
首先计算可观测的偏航角和偏航方差。因为已经倾斜对准，姿态四元数
\begin_inset Formula $q$
\end_inset

中的横滚角
\begin_inset Formula $\phi$
\end_inset

和俯仰角
\begin_inset Formula $\theta$
\end_inset

可信，使用零偏航角
\begin_inset Formula $\psi=0$
\end_inset

将磁力计测量值旋转到地球地球坐标系中，投影到水平面上的角度给出了偏航角
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{I} & =\boldsymbol{R}\left(\phi,\theta,\psi=0\right)\cdot\boldsymbol{M}_{meas}\\
\psi & =-\mathrm{atan2}\left(M_{I_{E}},M_{I_{N}}\right)+\psi^{DECLINATION}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename resetMagHeading.pdf
	scale 70

\end_inset


\end_layout

\begin_layout Standard
将新的偏航角
\begin_inset Formula $\psi$
\end_inset

更新到姿态四元数
\begin_inset Formula $q$
\end_inset

中即完成对准。接着使用最新的磁力计测量值(机体坐标系中的向量)重置磁场状态
\begin_inset Formula 
\begin{align*}
\boldsymbol{M}_{I} & =\boldsymbol{R}\left(q\right)\cdot\boldsymbol{M}_{meas}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
最后用预置的地磁向量测量方差重置协方差矩阵中的相应行和列。
\end_layout

\begin_layout Subsection
应用EKF-GSF的偏航角对准
\end_layout

\begin_layout Standard
EKF-GSF算法(参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:使用IMU和GPS进行偏航对准"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的内容)可以在没有磁力计的情况下估计偏航角，因此可以发现强磁干扰情况下的偏航角漂移。
\end_layout

\begin_layout Standard
判断条件很简单。当飞行器位于空中并且GPS信号无丢失时，假定EKF-GSF偏航角
\begin_inset Formula $\psi_{GSF}$
\end_inset

虽然不如24-EKF偏航角
\begin_inset Formula $\psi$
\end_inset

精确，但是距离不可见的真实偏航角
\begin_inset Formula $\psi_{true}$
\end_inset

不会太远，在第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS速度和水平位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节计算时检查两个偏航角的一致性，当
\begin_inset Formula $\left|\psi_{GSF}-\psi\right|>25^{\circ}$
\end_inset

时，则认为24-EKF偏航角
\begin_inset Formula $\psi$
\end_inset

已经被外界强磁场干扰发生漂移。这时则用
\begin_inset Formula $\psi_{GSF}$
\end_inset

和
\begin_inset Formula $\sigma_{\psi_{GSF}}^{2}$
\end_inset

重置24-EKF的偏航角
\begin_inset Formula $\psi$
\end_inset

及其协方差以限制其漂移。
\end_layout

\begin_layout Section
输出互补滤波器
\begin_inset CommandInset label
LatexCommand label
name "sec:输出互补滤波器"

\end_inset


\end_layout

\begin_layout Standard
该算法使用当前时间范围内的最新IMU数据实现捷联惯导算法(strapdown INS algorithm)。该算法缓冲惯性导航状态，并计算延迟融合时间范围内(d
elayed fusion time horizon)与EKF状态的差异。根据差值计算增量角度、增量速度和速度校正，并在当前时间范围内应用它们，以便惯性导航状态
在延迟融合时间范围内跟踪EKF状态。使用互补滤波器校正EKF中的时间延迟的灵感来源于参考文档[12]的工作。
\end_layout

\begin_layout Standard
从软件的角度看，因为现在的系统越来越复杂，原本在RTOS时代所做的假设越来越不能得到满足。现在传感器采样，滤波器计算位姿，用户获取位姿，都分别处于不同的线程中，
有不同的工作频率。众多传感器各自工作在不同的频率，异步采样，数据异步到达。滤波器有自己的工作频率，上层软件也有另外的工作频率。所有这些，都会有一个时间差，因此在
用户获取当前位姿信息的瞬间，滤波器需要对当前所维护的信息做一个补偿，这就是输出互补滤波器。它的工作原理就是维护一个历史窗口，从历史数据中计算互补参数，然后对输出
信息进行校正，具体的原理请看参考文档[12]。在这里没有什么复杂的计算公式，一行的互补公式较多且大多简单细碎，经验参数众多，有很多工程细节，依赖专业背景和工程经
验方可调参。下面简单描述该算法的实现。
\end_layout

\begin_layout Subsection
融合时间范围
\end_layout

\begin_layout Standard
在传统的姿态估计的应用场景中，为简化计算并提高估计精度，有一个并行采样的假设。即所有的传感器数据都是同时采样。在高端设备上，并行采样是通过设计硬件电路来保证的。
在低成本的方案里，实际上执行的是串行采样，陀螺仪/加速计/地磁计这三者串行采样，有可能前后采样的时间差有
\begin_inset Formula $1\ ms$
\end_inset

左右。如果对估计精度不讲究，把它们当成并行采样处理也是可以的。那些低成本的无人机的姿态估计模块也都是这么做的。
\end_layout

\begin_layout Standard
此外，还有一个数据采样周期不一致的问题会影响估计精度。在低成本方案里，陀螺仪/加速计可以达到
\begin_inset Formula $100\sim200\ \mathrm{Hz}$
\end_inset

的采样率，而地磁计的采样率可能只有
\begin_inset Formula $10\ \mathrm{Hz}$
\end_inset

，而GPS可能只有
\begin_inset Formula $2\ \mathrm{Hz}$
\end_inset

。但是嵌入式软件系统为了简化设计，往往只围绕一种采样率进行设计。如果陀螺仪/加速计/地磁计这三者都以
\begin_inset Formula $100\ \mathrm{Hz}$
\end_inset

进行采样，因地磁计来不及锁定数据，可能连续
\begin_inset Formula $10$
\end_inset

次上报同一个数据，直到寄存器锁定后才上报新的数据。这样的数据组合，既会影响估计精度，也会增加系统负荷。
\end_layout

\begin_layout Standard
因此，为提高估计精度，必须处理多速率多延迟的向量测量这种情况。多延迟如下图所示，如果同时对所有传感器发出采样指令，IMU是反应最灵敏的，可以认为是立即返回，其它
传感器相对于IMU都有不同程度的延迟。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename input-01.pdf

\end_inset


\end_layout

\begin_layout Standard
由此可以看出，像GPS或外部视觉这类复杂传感器反应都很慢。另外，从传感器与测量值关系列表中也可以看出，每种传感器的采样速率也不一样：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="14" columns="5">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
传感器
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测量值
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
调用方法
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最小频率
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
用途
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
IMU
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\omega},\boldsymbol{a}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setIMUData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
预测
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
磁力计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{M}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setMagData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{meas},\boldsymbol{V}_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setGpsData
\end_layout

\end_inset
</cell>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2Hz
\end_layout

\end_inset
</cell>
<cell multirow="3" alignment="center" valignment="middle" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset


\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2-GPS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\psi_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multirow="4" alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
气压计
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $H_{meas}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setBaroData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
空速传感器
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $V_{meas}^{TAS}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setAirspeedData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
测距仪
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $H_{meas}^{agl}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setRangeData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
光流
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{\Delta\theta}_{xy}^{flow},\boldsymbol{\Delta\theta}_{xyz}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setOpticalFlowData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
外部视觉
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{P}_{meas},\boldsymbol{V}_{meas},q_{ev}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setExtVisionData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
着陆速度
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\boldsymbol{V}_{xy}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
setAuxVelData
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
5Hz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
虚拟
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{beta}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
内部调用
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
虚拟
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\mathrm{drag}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
内部调用
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
校正
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
甚至在当前的复杂系统中，采样时间点也不可能同步，而ECL EKF估计系统的运行频率与这些传感器不一样也不同步。ECL EKF估计系统的设计主要考虑两种频率：IM
U的采样频率和EKF的运行频率。其中，IMU的常见采样频率为
\begin_inset Formula $100\sim250\ \mathrm{Hz}$
\end_inset

，而EKF的运行频率在理想情况下应该是IMU采样频率的整数倍，为
\begin_inset Formula $50\sim200\ \mathrm{Hz}$
\end_inset

。我们将其称之为延迟融合时间范围(delayed fusion time horizon)。为简化设计，在实现中两者都采用
\begin_inset Formula $100\ \mathrm{Hz}$
\end_inset

的设计。
\end_layout

\begin_layout Standard
因为增量角度和增量速度依赖时间间隔
\begin_inset Formula $\mathrm{d}t$
\end_inset

的积分，所以IMU的
\begin_inset Formula $\mathrm{d}t_{\mathrm{imu}}$
\end_inset

的精度影响滤波器的估计精度。如果IMU的名义采样率为
\begin_inset Formula $100\ \mathrm{Hz}$
\end_inset

，因为系统的各种原因，实际采样率可能在
\begin_inset Formula $98\sim102\ \mathrm{Hz}$
\end_inset

之间抖动。所以在代码中
\begin_inset Formula $\mathrm{d}t_{\mathrm{imu}}$
\end_inset

的数值不能写死，而是采用采样事件之间的时间戳差值，并使用低通滤波计算：
\begin_inset Formula 
\[
\mathrm{d}t_{\mathrm{imu\_avg}}=\alpha\cdot\mathrm{d}t_{\mathrm{imu\_avg}}+\left(1-\alpha\right)\mathrm{d}t_{\mathrm{imu\_diff}}
\]

\end_inset

其中，
\begin_inset Formula $\alpha=0.8$
\end_inset

，这意味着我们假定采样时钟比较稳定，偶尔才会出现抖动。
\end_layout

\begin_layout Standard
同样的，ECL的运行频率，
\begin_inset Formula $\mathrm{d}t_{\mathrm{ekf}}$
\end_inset

，也需要使用低通滤波计算：
\begin_inset Formula 
\[
\mathrm{d}t_{\mathrm{ekf\_avg}}=\alpha\cdot\mathrm{d}t_{\mathrm{ekf\_avg}}+\left(1-\alpha\right)\mathrm{d}t_{\mathrm{ekf\_diff}}
\]

\end_inset

其中，
\begin_inset Formula $\alpha=0.99$
\end_inset

，这意味着我们假定系统时钟很稳定，偶尔才会出现抖动。
\end_layout

\begin_layout Standard
各传感器采样率与EKF的运行频率的可能的组合如下图所示：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename input-02.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
在实现中，ECL EKF估计系统的运行线程会被各种传感器多次唤醒。如果我们对输入系统以IMU周期为栅格进行考察，其它传感器测量值将随机落到不同的栅格中。因为各种
传感器采样速率差别巨大，实际上有很多栅格里并没有校正传感器测量值到达，也就是在这时间段内，位姿只有预测而没有校正。如果滤波器以预测-校正为一个完整迭代周期，则因
为采样率与采样时间点的差异，以及ECL EKF估计系统运行的延迟，最终所实现的滤波系统为在一段时间内估计精度可接受的近似最优估计系统。
\end_layout

\begin_layout Subsection
互补滤波基本原理
\end_layout

\begin_layout Standard
因为多速率多延迟的问题，24-EKF所估计的姿态四元数
\begin_inset Formula $q_{ekf}$
\end_inset

、速度向量
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

和位置向量
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

并不直接对外输出，所以ECL EKF估计系统采用一个时间滑窗系统跟踪24-EKF估计的状态向量，然后动态估计增益系数，再用互补滤波对输出数据进行校正。
\end_layout

\begin_layout Standard
其算法是，程序维护
\begin_inset Formula $3$
\end_inset

个有
\begin_inset Formula $N$
\end_inset

个元素的时间滑窗跟踪24-EKF估计的状态向量：
\end_layout

\begin_layout Enumerate
IMU采样输入环形缓冲区
\end_layout

\begin_layout Enumerate
三维姿态、速度和位置输出环形缓冲区，输出姿态四元数
\begin_inset Formula $q_{INS}$
\end_inset

、速度向量
\begin_inset Formula $\boldsymbol{V}_{NED}^{\prime}$
\end_inset

和位置向量
\begin_inset Formula $\boldsymbol{P}_{NED}^{\prime}$
\end_inset

。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $z$
\end_inset

轴速度输出环形缓冲区，输出
\begin_inset Formula $z$
\end_inset

轴速度
\begin_inset Formula $V_{D}^{\prime}$
\end_inset

。
\end_layout

\begin_layout Standard
其中之所以单独估计
\begin_inset Formula $z$
\end_inset

轴速度，是因为在
\begin_inset Formula $z$
\end_inset

轴方向上的速度误差过大，所以需要一个更精细的估计。该算法基本原理是，假设互补滤波输出的是无延迟的理想值，则延迟估计的24-EKF的状态与之就会有误差，该时间滑窗
系统就是为了捕捉当前
\begin_inset Formula $k$
\end_inset

时刻24-EKF的状态与输出互补滤波的状态之间的误差值：
\end_layout

\begin_layout Enumerate
时间的误差值，
\begin_inset Formula $\mathrm{d}t_{\mathrm{delay}}$
\end_inset

。
\end_layout

\begin_layout Enumerate
姿态的误差值，用四元数表示为
\begin_inset Formula $\left(\delta q\right)_{k}$
\end_inset

，用旋转向量表示为
\begin_inset Formula $\left(\boldsymbol{\delta\theta}\right)_{k}$
\end_inset

。
\end_layout

\begin_layout Enumerate
三维速度向量和位置向量的误差值，
\begin_inset Formula $\left(\boldsymbol{\delta V}\right)_{k}$
\end_inset

和
\begin_inset Formula $\left(\boldsymbol{\delta P}\right)_{k}$
\end_inset

，及其误差的积分值，
\begin_inset Formula $\sum_{i=1}^{k}\left(\boldsymbol{\delta V}\right)_{i}$
\end_inset

和
\begin_inset Formula $\sum_{i=1}^{k}\left(\boldsymbol{\delta P}\right)_{i}$
\end_inset

。
\end_layout

\begin_layout Enumerate
\begin_inset Formula $z$
\end_inset

轴速度的误差值，
\begin_inset Formula $\left(\delta V_{D}\right)_{k}$
\end_inset

，以及
\begin_inset Formula $z$
\end_inset

轴位置误差值的积分值
\begin_inset Formula $\sum_{i=1}^{k}\left(\delta P_{D}\right)_{i}$
\end_inset

。
\end_layout

\begin_layout Standard
其中，使用有
\begin_inset Formula $N$
\end_inset

个元素的时间滑窗就是放大这些误差值，并且假设EKF估计器会收敛到稳态，因此所观测的误差值也会收敛到稳态。于是在近一段时间内，这些误差值会趋向某些稳定的局部特征，
并且从长时间看，这些误差值的分布符合高斯分布，因此这些误差值的积分趋向于靠近零点的某些特征值。滑窗与输入输出之间的关系如图：
\end_layout

\begin_layout Standard
\noindent
\align left
\begin_inset Graphics
	filename output-01.pdf
	scale 75

\end_inset


\end_layout

\begin_layout Standard
因此我们用这些误差值或特征值计算以下增量增益系数：
\end_layout

\begin_layout Enumerate
增量姿态增益系数，
\begin_inset Formula $G_{\theta}$
\end_inset

。
\end_layout

\begin_layout Enumerate
增量速度增益系数，
\begin_inset Formula $G_{V}$
\end_inset

。
\end_layout

\begin_layout Enumerate
增量位置增益系数，
\begin_inset Formula $G_{P}$
\end_inset

。
\end_layout

\begin_layout Standard
并且所有的增量值、误差值及其积分在初始化时都设置为零。
\end_layout

\begin_layout Subsection
计算过程
\end_layout

\begin_layout Subsubsection
计算姿态补偿
\begin_inset CommandInset label
LatexCommand label
name "subsec:计算姿态补偿"

\end_inset


\end_layout

\begin_layout Standard
为在EKF融合时间范围内跟踪的四元数状态所需的增量角度进行校正
\begin_inset Formula 
\[
\boldsymbol{\Delta\theta}_{truth}=\boldsymbol{\Delta\theta}_{meas}-\boldsymbol{\Delta\theta}_{b}\cdot\mathrm{d}t_{\boldsymbol{\theta}}+\boldsymbol{\Delta\theta}_{correct}
\]

\end_inset

其中，
\begin_inset Formula $\boldsymbol{\Delta\theta}_{correct}$
\end_inset

为上一次迭代时留下的增量角度校正向量，本次迭代中将在后面使用增量姿态增益系数
\begin_inset Formula $G_{\theta}$
\end_inset

进行计算，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:计算增量增益系数"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节，并且
\begin_inset Formula $\boldsymbol{\Delta\theta}_{truth}$
\end_inset

为在机体坐标系中校正后的增量角度。
\end_layout

\begin_layout Standard
计算绕地球坐标系垂直方向的偏航角变化
\begin_inset Formula 
\[
\left[\begin{array}{c}
\Delta\phi_{I}\\
\Delta\theta_{I}\\
\Delta\psi_{I}
\end{array}\right]=\boldsymbol{\Delta\theta}_{truth}^{\mathrm{T}}\cdot\boldsymbol{R}\left(\left(q_{INS}\right)_{k-1}\right)
\]

\end_inset

其中，
\begin_inset Formula $\Delta\psi_{I}$
\end_inset

为最近绕地球坐标系
\begin_inset Formula $z$
\end_inset

轴测得的偏航角变化(
\begin_inset Formula $\mathrm{rad}$
\end_inset

)，
\begin_inset Formula $\boldsymbol{R}$
\end_inset

为从
\begin_inset Formula $k-1$
\end_inset

时刻的输出姿态四元数
\begin_inset Formula $\left(q_{INS}\right)_{k-1}$
\end_inset

变换来的从机体坐标系到地球坐标系的旋转矩阵。
\end_layout

\begin_layout Standard
使用低通滤波计算偏航变化率(偏航角导数)
\begin_inset Formula 
\[
\dot{\psi}=\left(1-\alpha\right)\dot{\psi}+\alpha\cdot\Delta\psi_{I}/\mathrm{d}t_{\boldsymbol{\theta}}
\]

\end_inset

其中，
\begin_inset Formula $\alpha=0.05$
\end_inset

，假设偏航变化率短时间内没有大的变化。注意，固定系数用于保存计算。确切的时间常数并不重要。
\end_layout

\begin_layout Standard
用增量四元数旋
\begin_inset Formula $\delta q$
\end_inset

转先前的惯性导航系统(INS)的姿态四元数
\begin_inset Formula $q_{INS}$
\end_inset

，并用此更新计算旋转矩阵
\begin_inset Formula $\boldsymbol{R}$
\end_inset

，
\begin_inset Formula 
\[
\left(q_{INS}\right)_{k}=\left(q_{INS}\right)_{k-1}\cdot\delta q\left(\boldsymbol{\Delta\theta}_{truth}\right)
\]

\end_inset


\end_layout

\begin_layout Standard
修改后的四元数必须进行归一化
\begin_inset Formula 
\[
\left(q_{INS}\right)_{k}=\left(q_{INS}\right)_{k}/\left\Vert \left(q_{INS}\right)_{k}\right\Vert 
\]

\end_inset


\end_layout

\begin_layout Subsubsection
计算当前加速度、速度和位置
\begin_inset CommandInset label
LatexCommand label
name "subsec:计算当前加速度、速度和位置"

\end_inset


\end_layout

\begin_layout Standard
用加速度偏差校正机体坐标系的增量速度
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{truth}^{B}=\boldsymbol{\Delta V}_{meas}-\boldsymbol{\Delta a}_{b}\cdot\mathrm{d}t_{\boldsymbol{a}}
\]

\end_inset


\end_layout

\begin_layout Standard
将校正后的增量速度旋转到地球坐标系
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{truth}^{I}=\left[\begin{array}{c}
\Delta V_{N}\\
\Delta V_{E}\\
\Delta V_{D}
\end{array}\right]=\boldsymbol{R}\left(\left(q_{INS}\right)_{k}\right)\boldsymbol{\Delta V}_{truth}^{B}
\]

\end_inset


\end_layout

\begin_layout Standard
叠加重力引起的测量加速度
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{truth}^{I}=\boldsymbol{\Delta V}_{truth}^{I}+\left[\begin{array}{c}
0\\
0\\
g
\end{array}\right]\cdot\mathrm{d}t_{\mathrm{imu}}
\]

\end_inset


\end_layout

\begin_layout Standard
计算机体在地球坐标系中的速度导数(加速度)
\begin_inset Formula 
\[
\boldsymbol{a}^{I}=\left[\begin{array}{c}
a_{N}\\
a_{E}\\
a_{D}
\end{array}\right]=\boldsymbol{\Delta V}_{truth}^{I}/\mathrm{d}t_{\mathrm{imu}}
\]

\end_inset


\end_layout

\begin_layout Standard
通过测量加上校正，增加惯性导航系统的速度状态
\begin_inset Formula 
\[
\left(\boldsymbol{V}_{NED}^{\prime}\right)_{k}=\left(\boldsymbol{V}_{NED}^{\prime}\right)_{k-1}+\boldsymbol{\Delta V}_{truth}^{I}
\]

\end_inset


\end_layout

\begin_layout Standard
对于替代校正算法所使用的垂直速度状态也同样如此
\begin_inset Formula 
\[
\left(V_{D}^{\prime}\right)_{k}=\left(V_{D}^{\prime}\right)_{k-1}+\Delta V_{D}
\]

\end_inset


\end_layout

\begin_layout Standard
使用先前时刻和当前时刻的速度，使用梯形积分计算惯性导航系统的位置状态
\begin_inset Formula 
\begin{align*}
\boldsymbol{\Delta P} & =\left[\begin{array}{c}
\Delta P_{N}\\
\Delta P_{E}\\
\Delta P_{D}
\end{array}\right]=\dfrac{1}{2}\left(\left(\boldsymbol{V}_{NED}^{\prime}\right)_{k-1}+\left(\boldsymbol{V}_{NED}^{\prime}\right)_{k}\right)\cdot\mathrm{d}t_{\mathrm{imu}}\\
\left(\boldsymbol{P}_{NED}^{\prime}\right)_{k} & =\left(\boldsymbol{P}_{NED}^{\prime}\right)_{k-1}+\boldsymbol{\Delta P}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
对于替代校正算法所使用的垂直位置状态(垂直速度积分)也同样如此
\begin_inset Formula 
\[
\sum_{i=1}^{k}\left(\delta P_{D}\right)_{i}=\sum_{i=1}^{k-1}\left(\delta P_{D}\right)_{i}+\Delta P_{D}
\]

\end_inset


\end_layout

\begin_layout Standard
用IMU偏移校正原点速度。计算上一次IMU更新的平均角速度变化率(角加速度)
\begin_inset Formula 
\[
\boldsymbol{\alpha}=\boldsymbol{\Delta\theta}_{meas}/\mathrm{d}t_{\mathrm{imu}}
\]

\end_inset


\end_layout

\begin_layout Standard
我们有IMU位于机体坐标系的位置
\begin_inset Formula $\boldsymbol{P}_{imu}^{B}$
\end_inset

，用来计算IMU点在机体坐标系中相对于机体原点的速度，下式中
\begin_inset Formula $\otimes$
\end_inset

代表向量叉乘
\begin_inset Formula 
\[
\boldsymbol{V}_{imu}^{B}=\boldsymbol{\alpha}\otimes\boldsymbol{P}_{imu}^{B}
\]

\end_inset


\end_layout

\begin_layout Standard
将相对速度旋转到地球坐标系中，就得到NED地球坐标系中IMU点相对于机体原点的速度
\begin_inset Formula 
\[
\left(\boldsymbol{V}_{imu}^{I}\right)_{k}=\left[\begin{array}{c}
V_{imu_{N}}\\
V_{imu_{E}}\\
V_{imu_{D}}
\end{array}\right]=\boldsymbol{R}\left(\left(q_{INS}\right)_{k}\right)\boldsymbol{V}_{imu}^{B}
\]

\end_inset


\end_layout

\begin_layout Subsubsection
计算增量增益系数
\begin_inset CommandInset label
LatexCommand label
name "subsec:计算增量增益系数"

\end_inset


\end_layout

\begin_layout Standard
INS状态存储环形缓冲区与IMU数据缓冲区具有相同长度
\begin_inset Formula $N$
\end_inset

和时间坐标。从INS环形缓冲区获取最旧的INS状态数据，为
\begin_inset Formula $k-N+1$
\end_inset

时刻的数据，这些数据将与24-EKF当前
\begin_inset Formula $k$
\end_inset

时刻的融合时间范围状态相比较，其中两者的时间误差为
\begin_inset Formula $\mathrm{d}t_{\mathrm{delay}}$
\end_inset

。该算法主要是为了放大误差值。
\end_layout

\begin_layout Standard
在EKF融合时间范围内计算INS四元数
\begin_inset Formula $\left(q_{INS}\right)_{k-N+1}$
\end_inset

和EKF四元数
\begin_inset Formula $\left(q_{ekf}\right)_{k}$
\end_inset

之间的四元数增量
\begin_inset Formula 
\[
\left(\delta q\right)_{k}=\left[\begin{array}{c}
\delta q_{0}\\
\delta q_{1}\\
\delta q_{2}\\
\delta q_{3}
\end{array}\right]=\left(q_{ekf}\right)_{k}^{-1}\cdot\left(q_{INS}\right)_{k-N+1}
\]

\end_inset


\end_layout

\begin_layout Standard
将四元数增量转换为增量角度(小角度近似)
\begin_inset Formula 
\[
\delta\boldsymbol{\theta}=2\left[\begin{array}{c}
\delta q_{1}\\
\delta q_{2}\\
\delta q_{3}
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
计算一个姿态增益，提供对24-EKF估计器姿态状态的严密跟踪，并调整时间延迟的变化，以保持约
\begin_inset Formula $0.7$
\end_inset

的一致阻尼比
\begin_inset Formula 
\[
G_{\theta}=\dfrac{1}{2}\mathrm{d}t_{\mathrm{imu}}/\mathrm{d}t_{\mathrm{delay}}
\]

\end_inset


\end_layout

\begin_layout Standard
用其计算增量角度的校正向量，这将导致INS跟踪24-EKF姿态四元数，并且该增量角度校正向量将在下一迭代被使用到，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:计算姿态补偿"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节
\begin_inset Formula 
\[
\boldsymbol{\Delta\theta}_{correct}=G_{\theta}\cdot\delta\boldsymbol{\theta}
\]

\end_inset


\end_layout

\begin_layout Standard
计算速度和位置的互补滤波器增益。用户设置的增益系数，
\begin_inset Formula $\mathrm{d}t_{\mathrm{ekf}}<\tau_{V},\tau_{P}<10$
\end_inset

，由此计算速度和位置的增益系数
\begin_inset Formula 
\begin{align*}
G_{V} & =\mathrm{d}t_{\mathrm{ekf}}/\tau_{V}\\
G_{P} & =\mathrm{d}t_{\mathrm{ekf}}/\tau_{P}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
后面将遍历输出滤波器状态历史，
\begin_inset Formula $i\in1\sim N$
\end_inset

，并将校正应用于速度和位置状态。在这里使用与姿态校正不一样的方法。因为上述用于校正姿态状态的方法需要四元数运算，对于速度和位置来说太昂贵了。这里的方法由于它允许
使用更高的跟踪增益，因此消除了“校正回路”中的时间延迟，并减少了相对于EKF状态的跟踪误差。
\end_layout

\begin_layout Subsubsection
计算垂直速度补偿
\end_layout

\begin_layout Standard
计算
\begin_inset Formula $z$
\end_inset

轴的速度和位置跟踪增量
\begin_inset Formula 
\begin{align*}
\left(\delta V_{D}\right)_{k} & =\left(V_{D}\right)_{k}-\left(V_{D}^{\prime}\right)_{k-N+1}\\
\left(\delta P_{D}\right)_{k} & =\left(P_{D}\right)_{k}-\left(P_{D}^{\prime}\right)_{k-N+1}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算将应用于输出状态历史的速度校正，使用一个PD反馈调参到
\begin_inset Formula $5\%$
\end_inset

超调
\begin_inset Formula 
\[
\Delta V_{correct}=G_{P}\cdot\delta P_{D}+1.1\cdot G_{V}\cdot\delta V_{D}
\]

\end_inset


\end_layout

\begin_layout Standard
计算要应用于
\begin_inset Formula $V_{D}^{\prime}$
\end_inset

的校正，该校正导致垂直位置增量
\begin_inset Formula $\sum_{i=1}^{k}\left(\delta P_{D}\right)_{i}$
\end_inset

使用用于速度和位置状态跟踪的替代算法，以在融合时间范围内跟踪EKF的
\begin_inset Formula $z$
\end_inset

轴位置状态。该算法对
\begin_inset Formula $V_{D}^{\prime}$
\end_inset

状态历史应用校正，并使用当前校正后的
\begin_inset Formula $V_{D}^{\prime}$
\end_inset

向前传播
\begin_inset Formula $\sum_{i=1}^{k}\left(\delta P_{D}\right)_{i}$
\end_inset

。这提供了一种替代的垂直速度输出，该输出更接近于位置的一阶导数，但相对于24-EKF状态确实降低了跟踪成本。
\end_layout

\begin_layout Standard
从最早的垂直输出滤波器状态历史开始循环，
\begin_inset Formula $i\in1\sim N$
\end_inset

，并将校正应用于
\begin_inset Formula $V_{D}^{\prime}$
\end_inset

状态，并使用校正后的
\begin_inset Formula $V_{D}^{\prime}$
\end_inset

向前传播
\begin_inset Formula $\sum_{i=1}^{k}\left(\delta P_{D}\right)_{i}$
\end_inset


\end_layout

\begin_layout Itemize
校正当前的垂直速度
\begin_inset Formula 
\[
\left(V_{D}^{\prime}\right)_{i}=\left(V_{D}^{\prime}\right)_{i}+\Delta V_{correct}
\]

\end_inset


\end_layout

\begin_layout Itemize
使用校正后的速度和梯形积分器向前传播位置积分
\begin_inset Formula 
\[
\sum_{i=1}^{k}\left(\delta P_{D}\right)_{i}=\sum_{i=1}^{k-1}\left(\delta P_{D}\right)_{i}+\dfrac{1}{2}\left(\left(V_{D}^{\prime}\right)_{k}+\left(V_{D}^{\prime}\right)_{k-1}\right)\cdot\mathrm{d}t_{\mathrm{imu}}
\]

\end_inset


\end_layout

\begin_layout Standard
最后将当前垂直速度的输出状态更新为INS输出缓冲区中最新的校正值。
\end_layout

\begin_layout Subsubsection
计算三维速度和位置补偿
\end_layout

\begin_layout Standard
计算水平速度和位置跟踪误差
\begin_inset Formula 
\begin{align*}
\left(\boldsymbol{\delta V}\right)_{k} & =\left(\boldsymbol{V}_{NED}\right)_{k}-\left(\boldsymbol{V}_{NED}^{\prime}\right)_{k-N+1}\\
\left(\boldsymbol{\delta P}\right)_{k} & =\left(\boldsymbol{P}_{NED}\right)_{k}-\left(\boldsymbol{P}_{NED}^{\prime}\right)_{k-N+1}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算将应用于输出状态历史的速度校正
\begin_inset Formula 
\[
\boldsymbol{\Delta V}_{correct}=G_{V}\cdot\left(\boldsymbol{\delta V}\right)_{k}+0.1\cdot G_{V}^{2}\cdot\sum_{i=1}^{k}\left(\boldsymbol{\delta V}\right)_{i}
\]

\end_inset


\end_layout

\begin_layout Standard
计算将应用于输出状态历史的位置校正
\begin_inset Formula 
\[
\boldsymbol{\Delta P}_{correct}=G_{P}\cdot\left(\boldsymbol{\delta P}\right)_{k}+0.1\cdot G_{P}^{2}\cdot\sum_{i=1}^{k}\left(\boldsymbol{\delta P}\right)_{i}
\]

\end_inset


\end_layout

\begin_layout Standard
计算要应用于速度和位置输出状态历史的校正。速度和位置状态历史被分别校正，以便它们在融合时间范围内跟踪EKF状态。此选项提供最准确的EKF状态跟踪。
\end_layout

\begin_layout Standard
遍历输出滤波器状态历史，
\begin_inset Formula $i\in1\sim N$
\end_inset

，并将校正应用于速度和位置状态
\end_layout

\begin_layout Itemize
应用常量速度校正
\begin_inset Formula 
\[
\left(\boldsymbol{V}_{NED}^{\prime}\right)_{i}=\left(\boldsymbol{V}_{NED}^{\prime}\right)_{i}+\boldsymbol{\Delta V}_{correct}
\]

\end_inset


\end_layout

\begin_layout Itemize
应用常量位置校正
\begin_inset Formula 
\[
\left(\boldsymbol{P}_{NED}^{\prime}\right)_{i}=\left(\boldsymbol{P}_{NED}^{\prime}\right)_{i}+\boldsymbol{\Delta P}_{correct}
\]

\end_inset


\end_layout

\begin_layout Standard
最后将当前三维速度和位置的输出状态更新为INS输出缓冲区中最新的校正值。
\end_layout

\begin_layout Subsection
输出状态
\begin_inset CommandInset label
LatexCommand label
name "subsec:输出状态"

\end_inset


\end_layout

\begin_layout Standard
在经过互补滤波校正后，ECL EKF输出以下常用数据：
\end_layout

\begin_layout Itemize
输出姿态四元数
\begin_inset Formula $\left(q_{INS}\right)_{k}$
\end_inset

，用户可用来转换成易读的欧拉角。
\end_layout

\begin_layout Itemize
输出速度，即在局部NED地球坐标系中机体坐标系原点的速度
\begin_inset Formula 
\[
\boldsymbol{V}_{NED}^{O}=\left(\boldsymbol{V}_{NED}^{\prime}\right)_{k}-\left(\boldsymbol{V}_{imu}^{I}\right)_{k}
\]

\end_inset


\end_layout

\begin_layout Itemize
输出加速度，即机体在地球坐标系中的速度导数
\begin_inset Formula $\boldsymbol{a}^{I}$
\end_inset

。
\end_layout

\begin_layout Itemize
输出垂直方向速度，即局部NED地球坐标系中机体坐标系原点垂直位置的导数
\begin_inset Formula 
\[
V_{D}^{O}=\left(V_{D}^{\prime}\right)_{k}-V_{imu_{D}}
\]

\end_inset


\end_layout

\begin_layout Itemize
输出位置，即在局部地球坐标系中机体坐标系原点的位置。将IMU相对于机体原点的位置
\begin_inset Formula $\boldsymbol{P}_{imu}^{B}$
\end_inset

旋转到地球坐标系中
\begin_inset Formula 
\[
\boldsymbol{P}_{imu}^{I}=\boldsymbol{R}\left(\left(q_{INS}\right)_{k}\right)\boldsymbol{P}_{imu}^{B}
\]

\end_inset

将其从EKF位置(即IMU位置)减去，即得到机体原点的位置
\begin_inset Formula 
\[
\boldsymbol{P}_{NED}^{O}=\left(\boldsymbol{P}_{NED}^{\prime}\right)_{k}-\boldsymbol{P}_{imu}^{I}
\]

\end_inset


\end_layout

\begin_layout Itemize
输出预测姿态四元数。即使用最新的IMU增量角数据向前预测先前的四元数输出状态。使用EKF的偏差状态估计值校正偏差误差的增量角数据，并应用跟踪EKF四元数状态所需
的校正
\begin_inset Formula 
\[
\boldsymbol{\delta\theta}=\boldsymbol{\Delta\theta}_{meas}-\boldsymbol{\Delta\theta}_{b}\cdot S_{\mathrm{d}t}+\boldsymbol{\Delta\theta}_{correct}
\]

\end_inset

使用校正后的增量角向量校正姿态四元数
\begin_inset Formula 
\[
q_{pred}=q_{INS}\cdot\delta q\left(\boldsymbol{\delta\theta}\right)
\]

\end_inset

修改后的姿态四元数必须进行归一化
\begin_inset Formula 
\[
q_{pred}=q_{pred}/\left\Vert q_{pred}\right\Vert 
\]

\end_inset


\end_layout

\begin_layout Standard
在PX4项目中组合这些输出数据，对外发布如下信息：
\end_layout

\begin_layout Itemize
发布里程计信息
\end_layout

\begin_deeper
\begin_layout Itemize
位置
\begin_inset Formula $\boldsymbol{P}_{NED}^{O}$
\end_inset


\end_layout

\begin_layout Itemize
姿态四元数
\begin_inset Formula $q_{INS}$
\end_inset


\end_layout

\begin_layout Itemize
速度
\begin_inset Formula $\boldsymbol{V}_{NED}^{O}$
\end_inset


\end_layout

\begin_layout Itemize
角速度
\begin_inset Formula $\boldsymbol{\omega}=\left(\boldsymbol{\Delta\theta}_{meas}-\boldsymbol{\Delta\theta}_{b}\right)/\mathrm{d}t_{\mathrm{imu}}$
\end_inset


\end_layout

\begin_layout Itemize
速度方差，24-EKF的
\begin_inset Formula $\boldsymbol{P}$
\end_inset

矩阵速度方阵的对角线向量。
\end_layout

\begin_layout Itemize
位置方差，24-EKF的
\begin_inset Formula $\boldsymbol{P}$
\end_inset

矩阵位置方阵的对角线向量。
\end_layout

\begin_layout Itemize
姿态方差，24-EKF的
\begin_inset Formula $\boldsymbol{P}$
\end_inset

矩阵姿态方阵的对角线向量。
\end_layout

\end_deeper
\begin_layout Itemize
发布局部位置信息
\end_layout

\begin_deeper
\begin_layout Itemize
位置
\begin_inset Formula $\boldsymbol{P}_{NED}^{O}$
\end_inset


\end_layout

\begin_layout Itemize
速度
\begin_inset Formula $\boldsymbol{V}_{NED}^{O}$
\end_inset


\end_layout

\begin_layout Itemize
垂直方向速度
\begin_inset Formula $V_{D}^{O}$
\end_inset


\end_layout

\begin_layout Itemize
加速度
\begin_inset Formula $\boldsymbol{a}^{I}$
\end_inset


\end_layout

\begin_layout Itemize
经纬度与海拔高度
\end_layout

\end_deeper
\begin_layout Itemize
发布(预测)姿态
\begin_inset Formula $q_{pred}$
\end_inset

信息
\end_layout

\begin_layout Section
风速估计
\begin_inset CommandInset label
LatexCommand label
name "sec:风速估计"

\end_inset


\end_layout

\begin_layout Standard
因为风速对评估飞行环境十分重要，并且为了容错，所以除了在主要的24-EKF估计器中估计风速之外，ECL还采用另外不同模型的3-EKF算法来估计风速。ECL估计系
统对外发布的风速数据由该估计器发布，24-EKF估计器中估计的风速只在其内部使用。
\end_layout

\begin_layout Subsection
假设
\end_layout

\begin_layout Standard
假设飞行器为近水平面姿态。飞行器有
\begin_inset Formula $z$
\end_inset

轴方向上的运动，但是飞行器以近水平面姿态运动。对于旋翼飞机这意味着零侧滑(Zero sideslip)假设。
\end_layout

\begin_layout Standard
假设风速为近水平面风场，因此
\begin_inset Formula $z$
\end_inset

轴方向风速为
\begin_inset Formula $0$
\end_inset

。用
\begin_inset Formula $V_{wind_{N}}/V_{wind_{E}}$
\end_inset

表示在 NED 坐标系中在北/东 (N/E) 方向上的风速，则风速向量
\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

表示为
\begin_inset Formula 
\[
\boldsymbol{V}_{wind}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
0
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Standard
真实空速(True Air Speed, TAS)，又称真空速，是表示飞行器飞行时相对于周围空气运动的速度。真实空速的方程与温度和空气密度相关。在这里做一个简化
，假设其为飞行器相对于地球固定坐标系的速度向量
\begin_inset Formula $\boldsymbol{V}_{I}$
\end_inset

和风速向量
\begin_inset Formula $\boldsymbol{V}_{wind}$
\end_inset

的差值，并乘上真实空速缩放因子
\begin_inset Formula $k_{TAS}$
\end_inset

。
\end_layout

\begin_layout Standard
所以，最终的要估计的状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

为
\begin_inset Formula 
\[
\boldsymbol{x}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{TAS}
\end{array}\right]
\]

\end_inset

并且假设风场在短时间内不会有大的变化，所以采用固定过程模型。
\end_layout

\begin_layout Standard
外部系统输入航向角
\begin_inset Formula $\psi$
\end_inset

，以及飞行器相对于地表的速度向量
\begin_inset Formula $\boldsymbol{V}_{I}=\left[\begin{array}{ccc}
V_{N} & V_{E} & V_{D}\end{array}\right]^{\mathrm{T}}$
\end_inset

，我们关注N/E方向的地面速度方差
\begin_inset Formula $\boldsymbol{\sigma}^{2}=\left[\begin{array}{cc}
\sigma_{V_{N}}^{2} & \sigma_{V_{E}}^{2}\end{array}\right]^{\mathrm{T}}$
\end_inset

。对于风速的过程噪声分量为
\begin_inset Formula $Q_{w}$
\end_inset

，对于真实空速过程噪声分量为
\begin_inset Formula $Q_{k_{TAS}}$
\end_inset

。对于固定翼飞机，由空速传感器提供真实空速测量值
\begin_inset Formula $V_{meas}^{TAS}$
\end_inset

，其测量噪声为
\begin_inset Formula $R_{TAS}$
\end_inset

；对于旋翼飞机，由合成侧滑
\begin_inset Formula $\mathrm{beta}$
\end_inset

计算真实空速测量值，其测量噪声为
\begin_inset Formula $R_{beta}$
\end_inset

。
\end_layout

\begin_layout Subsection
初始化
\end_layout

\begin_layout Standard
初始化阶段的主要目标是通过地面速度初始化风速协方差。这是一种对准算法，与时间更新阶段的方程不一样。
\end_layout

\begin_layout Standard
由外部输入航向角
\begin_inset Formula $\psi$
\end_inset

。根据近水平面的假设，根据飞行器地面速度、航向和空速测量值计算风速估计值(状态向量)
\begin_inset Formula 
\[
\mathrm{wind}_{est}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}
\end{array}\right]=\left[\begin{array}{c}
V_{N}\\
V_{E}
\end{array}\right]-\left[\begin{array}{c}
\cos\left(\psi\right)\\
\sin\left(\psi\right)
\end{array}\right]\cdot V_{meas}^{TAS}
\]

\end_inset


\end_layout

\begin_layout Standard
风速向量的估计与水平速度(
\begin_inset Formula $V_{N}/V_{E}$
\end_inset

)，航向角
\begin_inset Formula $\psi$
\end_inset

，合成侧滑
\begin_inset Formula $\mathrm{beta}$
\end_inset

，空速测量值
\begin_inset Formula $V_{meas}^{TAS}$
\end_inset

这
\begin_inset Formula $5$
\end_inset

个量相关。因为是零侧滑，所以使用航向角
\begin_inset Formula $\psi$
\end_inset

的偏导数传播合成侧滑方差。因此，风速的状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

，其为相对于这
\begin_inset Formula $5$
\end_inset

个量的Jacobian矩阵，
\begin_inset Formula 
\begin{align*}
\boldsymbol{F} & =\dfrac{\partial\left(\mathrm{wind}_{est}\right)}{\partial\left(\left[\begin{array}{c}
V_{N}\\
V_{E}\\
\psi\\
\psi\\
V_{meas}^{TAS}
\end{array}\right]\right)}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
设置初始状态协方差矩阵的对角线为前面
\begin_inset Formula $5$
\end_inset

个量的方差
\begin_inset Formula 
\[
\boldsymbol{P}_{0}=\mathrm{diag}\left(\left[\begin{array}{c}
\sigma_{V_{N}}^{2}\\
\sigma_{V_{E}}^{2}\\
\sigma_{\psi}^{2}\\
\sigma_{beta}^{2}\\
\sigma_{TAS}^{2}
\end{array}\right]\right)
\]

\end_inset


\end_layout

\begin_layout Standard
根据状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

，获得初始化时的状态协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的估计值
\begin_inset Formula 
\begin{align*}
\boldsymbol{P} & =\boldsymbol{F}\boldsymbol{P}_{0}\boldsymbol{F}^{\mathrm{T}}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
设置状态向量
\begin_inset Formula $\boldsymbol{x}$
\end_inset

初始值为
\begin_inset Formula 
\[
\boldsymbol{x}=\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
1
\end{array}\right]
\]

\end_inset


\end_layout

\begin_layout Subsection
时间更新
\end_layout

\begin_layout Standard
因为算法采用的是固定过程模型，
\begin_inset Formula $\boldsymbol{x}_{k+1}=\boldsymbol{x}_{k}$
\end_inset

，所以我们只需要提供协方差矩阵
\begin_inset Formula $\boldsymbol{P}$
\end_inset

的预测方程
\begin_inset Formula 
\[
\boldsymbol{P}_{k|k-1}=\boldsymbol{P}_{k-1|k-1}+\left[\begin{array}{c}
Q_{w}\\
Q_{w}\\
Q_{k_{TAS}}
\end{array}\right]\cdot\mathrm{d}t
\]

\end_inset


\end_layout

\begin_layout Subsection
测量更新
\end_layout

\begin_layout Subsubsection
真实空速融合
\begin_inset CommandInset label
LatexCommand label
name "subsec:真实空速融合"

\end_inset


\end_layout

\begin_layout Standard
对于带有空速传感器的非旋翼无人机，采用这个分支。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:空速融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“空速融合方程”的内容。
\end_layout

\begin_layout Standard
由外界输入真实空速测量值
\begin_inset Formula $V_{meas}^{TAS}$
\end_inset

和飞行器相对于地表的速度
\begin_inset Formula $\boldsymbol{V}^{N}=\left[\begin{array}{ccc}
V_{N} & V_{E} & V_{D}\end{array}\right]^{\mathrm{T}}$
\end_inset

。
\end_layout

\begin_layout Standard
计算真实空速预测值
\begin_inset Formula $V_{pred}^{TAS}$
\end_inset


\begin_inset Formula 
\begin{align*}
V_{pred}^{TAS} & =\left\Vert \boldsymbol{V}^{N}-\boldsymbol{V}_{wind}\right\Vert _{2}\cdot k_{TAS}\\
 & =\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}\cdot k_{TAS}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
真实空速的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{TAS}$
\end_inset


\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{TAS} & =\dfrac{\partial\left(V_{pred}^{TAS}\right)}{\partial\boldsymbol{x}}\\
 & =\dfrac{\partial\left(\sqrt{\left(V_{N}-V_{wind_{N}}\right)^{2}+\left(V_{E}-V_{wind_{E}}\right)^{2}+V_{D}^{2}}\cdot k_{TAS}\right)}{\partial\left(\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{TAS}
\end{array}\right]\right)}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
计算新息(或残差)协方差
\begin_inset Formula $S$
\end_inset


\begin_inset Formula 
\[
S=\boldsymbol{H}\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{{\rm T}}+R_{TAS}
\]

\end_inset


\end_layout

\begin_layout Standard
最佳卡尔曼增益
\begin_inset Formula $\boldsymbol{K}_{3\times1}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{K}=\boldsymbol{P}_{k|k-1}\boldsymbol{H}^{{\rm T}}S^{-1}
\]

\end_inset


\end_layout

\begin_layout Standard
更新(后验)的协方差
\begin_inset Formula $\boldsymbol{P}_{3\times3}$
\end_inset


\begin_inset Formula 
\[
\boldsymbol{P}_{k|k}=\boldsymbol{P}_{k|k-1}-\boldsymbol{K}\boldsymbol{H}\boldsymbol{P}_{k|k-1}
\]

\end_inset


\end_layout

\begin_layout Standard
最后注意，风速融合频率不超过
\begin_inset Formula $10\ \mathrm{Hz}$
\end_inset

。
\end_layout

\begin_layout Subsubsection
合成侧滑融合
\begin_inset CommandInset label
LatexCommand label
name "subsec:合成侧滑融合"

\end_inset


\end_layout

\begin_layout Standard
对于提供虚拟合成侧滑数值的旋翼无人机，采用这个分支。本节的方程可对比第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“合成侧滑融合方程”的内容。
\end_layout

\begin_layout Standard
由外界输入姿态四元数
\begin_inset Formula $q$
\end_inset

和飞行器相对于地表的速度
\begin_inset Formula $\boldsymbol{V}^{N}=\left[\begin{array}{ccc}
V_{N} & V_{E} & V_{D}\end{array}\right]^{\mathrm{T}}$
\end_inset

。
\end_layout

\begin_layout Standard
计算在飞行器机体坐标系中的相对于地球坐标系的风速向量
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind}^{N} & =\boldsymbol{V}^{N}-\boldsymbol{V}_{wind}\\
 & =\left[\begin{array}{c}
V_{N}-V_{wind_{N}}\\
V_{E}-V_{wind_{E}}\\
V_{D}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
根据外部输入的姿态四元数
\begin_inset Formula $q$
\end_inset

得到从机体坐标系到导航坐标系的旋转矩阵
\begin_inset Formula $\left[T\right]_{B}^{N}$
\end_inset


\begin_inset Formula 
\[
\left[T\right]_{B}^{N}=\boldsymbol{R}\left(q\right)
\]

\end_inset


\end_layout

\begin_layout Standard
计算相对于机体坐标系的风速
\begin_inset Formula 
\begin{align*}
\boldsymbol{V}_{wind}^{B} & =\left(\left[T\right]_{B}^{N}\right)^{\mathrm{T}}\cdot\boldsymbol{V}_{wind}^{N}\\
 & =\left[\begin{array}{c}
V_{wind_{X}}\\
V_{wind_{Y}}\\
V_{wind_{Z}}
\end{array}\right]
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
合成侧滑模型的小角度近似方程为
\begin_inset Formula 
\[
\mathrm{beta}=\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}
\]

\end_inset

并且根据零侧滑假设，
\begin_inset Formula $-\mathrm{beta}$
\end_inset

即为新息。
\end_layout

\begin_layout Standard
计算合成侧滑的观测矩阵
\begin_inset Formula $\boldsymbol{H}_{beta}$
\end_inset


\begin_inset Formula 
\begin{align*}
\boldsymbol{H}_{beta} & =\dfrac{\partial\left(\mathrm{beta}\right)}{\partial\boldsymbol{x}}\\
 & =\dfrac{\partial\left(\dfrac{V_{wind_{Y}}}{V_{wind_{X}}}\right)}{\partial\left(\left[\begin{array}{c}
V_{wind_{N}}\\
V_{wind_{E}}\\
k_{TAS}
\end{array}\right]\right)}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
后面的计算如上一小节一样。
\end_layout

\begin_layout Section
ECL EKF的架构设计
\end_layout

\begin_layout Standard
PX4项目主要使用C++实现。但是其中的代码并没有使用C++的高级功能，称之为带类的C也不为过。在总体架构上，PX4项目采用微内核的设计思想，即各个功能模块都运
行在各自的独立空间，由RTOS提供消息机制，各个模块相互之间不能直接访问，而只能通过消息交换数据。这种方法有效地避免了因共享变量的并发访问而带来的复杂的同步与互
斥机制，从而使得软件模型变得简单。但是这也会带来其它一些问题，例如，
\begin_inset CommandInset href
LatexCommand href
name "消息海洋的问题"
target "https://docs.px4.io/main/en/middleware/uorb_graph.html"
literal "false"

\end_inset

，有时会让程序难以定位问题并且难以调试，同时整个系统的效率严重依赖OS提供的消息机制的效率。
\end_layout

\begin_layout Standard
ECL EKF估计系统主要有三类主动对象(Active Object)
\end_layout

\begin_layout Enumerate
传感器驱动。一种传感器封装成一个主动对象。
\end_layout

\begin_layout Enumerate
估计器。有24-EKF位姿估计器和3-EKF风速估计器两种，其中前者可能有多个实例同时运行，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:估计器多实例的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章，后者参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:风速估计"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
使用估计数据的模块。有多个，靠订阅消息获取估计信息，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:输出状态"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Standard
每个主动对象都绑定在一个线程(Thread)上，用生产-消费模式异步运行，这也造成了多速率多延迟的问题，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:输出互补滤波器"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的描述。
\end_layout

\begin_layout Standard
ECL EKF的核心算法部分为了可移植性，没有采用C++语言的高级功能，基本上是C语言的过程模型，并且它们也没有调用OS或外部模块的特殊函数(注意，这个原则已经
被打破，最新的版本已经依赖uORB消息接口)，基本上都是数学公式的代码，所以可以比较方便地移植到其它项目中。后面简单讨论核心算法的设计和运行流程，以及传感器数据
的流向。
\end_layout

\begin_layout Subsection
算法设计
\end_layout

\begin_layout Standard
24-EKF核心算法是基于运动学方程的设计，并且是基于传感器误差噪声的设计。因为这种选择可以规避动力学建模。经过多年的工程实践，人们发现：
\end_layout

\begin_layout Itemize
基于实际环境的动力学模型很难建立；
\end_layout

\begin_layout Itemize
建立起来的模型很复杂、状态量很大，当外界环境变化则动力学模型也需要跟着变化；
\end_layout

\begin_layout Itemize
就算能精确建模，因此增加的复杂性并不总是产生预期的结果；
\end_layout

\begin_layout Itemize
并且外界环境有许多未知因素无法建模。
\end_layout

\begin_layout Standard
因此，基于运动学方程、基于传感器误差噪声的设计，是一种提高估计精度的有效设计，因为这种设计需要的状态量少，并且传感器误差噪声可以内部精确测量，不易受到外界干扰，
未知因素少。因此这种设计成了近二十年来流行的方案。
\end_layout

\begin_layout Standard
在第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:ECL-EKF-时间更新方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的预测(先验)估计状态方程中：
\begin_inset Formula 
\[
\boldsymbol{x}_{k+1}=\boldsymbol{F}\boldsymbol{x}_{k}+\boldsymbol{G}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}
\]

\end_inset

我们假定在上一迭代中的状态
\begin_inset Formula $\boldsymbol{x}_{k}$
\end_inset

 已是最优估计，其中包含测量偏差值的最优估计，因此经过状态转移矩阵
\begin_inset Formula $\boldsymbol{F}$
\end_inset

变换得到的是时间更新的理想值。这时我们假定惯性解中的误差增长是由增量角度和加速度中的“噪声”驱动的，即由IMU的测量噪声驱动。这可以用控制矩阵
\begin_inset Formula $\boldsymbol{G}$
\end_inset

来表达，而控制向量
\begin_inset Formula $\boldsymbol{u}$
\end_inset

则由IMU的测量噪声构成。因此整个方程自然分解成两个部份：标称量
\begin_inset Formula $\boldsymbol{F}\boldsymbol{x}_{k}$
\end_inset

和误差量
\begin_inset Formula $\boldsymbol{G}\boldsymbol{u}_{k}+\boldsymbol{w}_{k}$
\end_inset

。这也体现这样的思想：一个总的变化可以分解成个体本身的变化和背景的变化两部分。个体本身的变化用分量导数描述，背景变化用对偶空间上的算子描述。
\end_layout

\begin_layout Standard
但是，基于动力学方程的设计也是可以工作的。第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:使用IMU和GPS进行偏航对准"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的算法本质上就是基于动力学方程的设计。已知外力和扭矩的公式为
\begin_inset Formula $F=ma,\tau=I\alpha$
\end_inset

，当质量
\begin_inset Formula $m$
\end_inset

和代表质量分布的惯性矩
\begin_inset Formula $I$
\end_inset

很难实时精确测量时，就很难得到精确的状态估计值。但是当我们假设质量
\begin_inset Formula $m$
\end_inset

和惯性矩
\begin_inset Formula $I$
\end_inset

在短时间内没有大的变化时，测量得到的线性加速度
\begin_inset Formula $\boldsymbol{a}$
\end_inset

和角速度
\begin_inset Formula $\boldsymbol{\omega}$
\end_inset

就与所要估计的状态量有一个近似线性关系。这就是 EKF-GSF 算法的基本假设。并且因为与24-EKF算法的原理不同，EKF-GSF 算法因此也可以对24-EK
F算法进行校验。
\end_layout

\begin_layout Standard
此外，为使状态估计更准确且抗干扰，就需要更多的传感器测量值进行校验，要“榨干”每一个测量值内含的信息，如第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:ECL-EKF-测量更新方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的内容所见。其中最典型的是第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:重力融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节重力融合方程的算法。IMU的加速度
\begin_inset Formula $\boldsymbol{a}$
\end_inset

的测量值由线性加速度和重力组成。在前面的预测(先验)估计状态方程中，我们实际上过滤掉了重力。因此后面还可以用重力向量做为观测向量对机体姿态进行校正。原本对机体姿
态的校正严重依赖于第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:磁力计融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的磁力计融合算法，而地磁测量值本身很容易被干扰。如今多了一个重力融合的算法，则机体姿态的估计值抗干扰能力更强。
\end_layout

\begin_layout Subsection
算法流程
\end_layout

\begin_layout Standard
ECL EKF的核心算法流程是一个事件处理的大循环，其线程被唤醒后就进行事件处理，其方法名为
\family typewriter
bool Ekf::update()
\family default
。唤醒事件有各种传感器数据输入，还有一个
\begin_inset Formula $10\ \mathrm{Hz}$
\end_inset

的定时事件。当一段时间内没有任何传感器数据输入时，系统以
\begin_inset Formula $10\ \mathrm{Hz}$
\end_inset

频率进行惯性航位推算，并对外报告异常。算法的处理流程如下(在不同的版本之间会有一些差异)：
\end_layout

\begin_layout Enumerate
运行主要的24-EKF估计器(
\begin_inset Formula $100\ \mathrm{Hz}$
\end_inset

)
\end_layout

\begin_deeper
\begin_layout Enumerate
预测新的状态(24-EKF 方程 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:1"
plural "false"
caps "false"
noprefix "false"

\end_inset

 )，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:ECL-EKF-时间更新方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
预测新的协方差矩阵(24-EKF 方程 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:2"
plural "false"
caps "false"
noprefix "false"

\end_inset

 )，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:ECL-EKF-时间更新方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
受控制的观测数据的融合(24-EKF 方程 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:3"
plural "false"
caps "false"
noprefix "false"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:4"
plural "false"
caps "false"
noprefix "false"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:5"
plural "false"
caps "false"
noprefix "false"

\end_inset

 )，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:ECL-EKF-测量更新方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_deeper
\begin_layout Enumerate
检查倾斜对准并在对准后选择高度数据源，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:姿态的初始化值与对准"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
检查baro/GPS/MAG/range/flow/EV/airspeed等传感器的可用情况，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:异常判断算法"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
检查并在必要时切换高度数据源(baro/EV/GPS/range)，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:高度数据的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
运行验证偏航角
\begin_inset Formula $\psi$
\end_inset

估计器(EKF-GSF)，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:使用IMU和GPS进行偏航对准"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
磁力融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:磁力计融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
光流融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:光流测量序列融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
GPS融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
空速融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:空速融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
beta融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
drag融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:阻力比力融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
高度融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:高度融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
重力融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:重力融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
外部视觉融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:外部视觉融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
辅助速度融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:辅助速度融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
零新息航向角更新。当飞行器处于静止状态时，航向角的新息很小，需要设置特别参数，以便估计器能正常运行。
\end_layout

\begin_layout Enumerate
零速度更新。当飞行器处于静止状态时，速度的新息很小，需要设置特别参数，以便估计器能正常运行。
\end_layout

\begin_layout Enumerate
虚拟位置融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:虚拟位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
虚拟高度融合，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:虚拟高度融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
更新航位推算状态，检查我们是否不再融合直接约束速度漂移的测量。参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\end_deeper
\end_deeper
\begin_layout Enumerate
运行地形高差估计器(1-KF)，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:地形高差估计的EKF方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Enumerate
运行输出观测器，计算当前时间范围的输出补偿(
\begin_inset Formula $100\ \mathrm{Hz}$
\end_inset

)，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:输出互补滤波器"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Subsection
数据流向
\end_layout

\begin_layout Standard
下面简单总结传感器测量值和估计值的输入输出流向，注意，图中没有包含噪声与方差的传播路径。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename sensor_flow.pdf
	scale 53
	rotateAngle -90

\end_inset


\end_layout

\begin_layout Subsection
算法优化
\end_layout

\begin_layout Standard
在PX4项目中的算法，以前采用 matlab 描述，后来采用 python/SymPy 描述，C++ 代码则是由符号推导系统优化后的展开式。这种C++计算式很难
看，基本无法理解。如今情况有些改观，PX4项目中的算法开始转向用python/SymForce描述。
\begin_inset CommandInset href
LatexCommand href
name "SymForce"
target "https://github.com/symforce-org/symforce"
literal "false"

\end_inset

 可译为“符号动力”。虽然SymForce也是基于SymPy构建，但是其输出更为易读一些，因为SymForce号称其代码生成器针对任何语言都使用一个模板系统将符
号表达式转换为快速的、无分支的代码，并且有着干净的API和最小的依赖项。
\end_layout

\begin_layout Standard
ECL估计器采用的大多是EKF算法，其中的Jacobian矩阵十分重要，而且大多很复杂，基本上无法手写推导。采用符号推导系统的优点，一是可以针对复杂的原函数生成
Jacobian矩阵，设计人员只需要考虑信息的关联关系而不需要关心如何生成复杂的偏导方程，这样就释放了设计人员的想象力，二是开发人员只需要维护原函数，如何快速计
算Jacobian矩阵，由已经长久验证的成熟模板生成优化代码，比手写的快且不容易出错。但是缺点也有，就是生成的代码丧失了可读性，使得函数代码又长又难看。
\end_layout

\begin_layout Standard
现在更换成SymForce以后，对比以前老版本的SymPy的输出代码，SymForce的输出代码的格式要漂亮一些，至少能读个半懂，从输出的注释中能了解一些其中的
步骤和意图。并且有了SymForce提供的封装函数，应用程序总体上也会简洁易读一些，不会被原先那些奇奇怪怪的代码打断。至于SymForce的输出代码能否运行得更
快一些，因为ECL估计算法的规模太小，所以无法判断。
\end_layout

\begin_layout Subsection
面向问题方面的分析
\end_layout

\begin_layout Standard
以上章节的方程基于面向流程的分析方式进行组织。但是在实际工程中，问题十分复杂，所以ECL/EKF2的代码流程也十分复杂，我们还需要基于另一个维度的分析，即面向问
题方面的分析。
\end_layout

\begin_layout Standard
面向问题方面有如下话题：
\end_layout

\begin_layout Itemize
异常判断算法，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:异常判断算法"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Itemize
偏航角数据的管理，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:偏航角数据的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Itemize
水平面数据的管理，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:水平面数据的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Itemize
高度数据的管理，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:高度数据的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Itemize
估计器多实例的管理，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:估计器多实例的管理"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Itemize
惯性航位推算，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章。
\end_layout

\begin_layout Section
异常判断算法
\begin_inset CommandInset label
LatexCommand label
name "sec:异常判断算法"

\end_inset


\end_layout

\begin_layout Standard
对于卡尔曼滤波系统的运行情况，通常采用马氏距离进行判断。马氏距离(Mahalanobis distance)是一种衡量点
\begin_inset Formula $P$
\end_inset

和概率分布 
\begin_inset Formula $D$
\end_inset

 之间距离的方法，它是对衡量
\begin_inset Formula $P$
\end_inset

距离
\begin_inset Formula $D$
\end_inset

的均值有多少标准差的概念的多维概括。
\begin_inset Formula $P$
\end_inset

在
\begin_inset Formula $D$
\end_inset

的均值处的距离为零，并随着
\begin_inset Formula $P$
\end_inset

沿每个主分量轴远离均值而增长。如果这些轴中的每一个都被重新标定为具有单位方差，那么马氏距离就对应于变换空间中的标准欧几里德距离。因此，马氏距离是无单位的、尺度不
变的，并考虑到了数据集的相关性。
\end_layout

\begin_layout Standard
设一组观测值为
\begin_inset Formula $\boldsymbol{x}=\left(x_{1},x_{2},x_{3},\ldots,x_{N}\right)^{\mathrm{T}}$
\end_inset

与一组具有均值
\begin_inset Formula $\boldsymbol{\mu}=\left(\mu_{1},\mu_{2},\mu_{3},\ldots,\mu_{N}\right)^{\mathrm{T}}$
\end_inset

及其协方差矩阵 
\begin_inset Formula $\boldsymbol{S}$
\end_inset

 的观测值的马氏距离定义为
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
D_{M}\left(\boldsymbol{x}\right)=\sqrt{\left(\boldsymbol{x}-\boldsymbol{\mu}\right)^{\mathrm{T}}\boldsymbol{S}^{-1}\left(\boldsymbol{x}-\boldsymbol{\mu}\right)}
\]

\end_inset


\end_layout

\begin_layout Standard
在卡尔曼滤波的应用中，我们以状态的当前
\begin_inset Formula $k$
\end_inset

时刻的预测值
\begin_inset Formula $\hat{\boldsymbol{x}}_{k\mid k-1}$
\end_inset

为均值，其位于新息协方差矩阵
\begin_inset Formula $\boldsymbol{S}$
\end_inset

表示的概率中心，则马氏距离(或其平方值即为“广义的点间距离的平方”)也可以定义为在用新息协方差矩阵
\begin_inset Formula $\boldsymbol{S}$
\end_inset

表示的相同概率分布下，测量值
\begin_inset Formula $\boldsymbol{z}_{k}$
\end_inset

与均值
\begin_inset Formula $h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)$
\end_inset

之间的距离，即测量值到达概率中心的距离：
\begin_inset Formula 
\[
D_{M}^{2}\left(\boldsymbol{z},\boldsymbol{x}\right)=\left(\boldsymbol{z}_{k}-h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)\right)^{\mathrm{T}}\boldsymbol{S}^{-1}\left(\boldsymbol{z}_{k}-h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)\right)
\]

\end_inset


\end_layout

\begin_layout Standard
该方法的直觉是，对于单维状态，输入数据的方差将标准正态分布扩散为非标正态分布，对于多维状态，各维数据的方差将圆球状的白化数据扩散为橢球状，而马氏距离则将这些被方
差驱动扩散的数据重新变换为标准正态分布或圆球状的白化数据。因此这种方法又称为标准化新息平方(Normalized Innovation Squared,
 NIS)。NIS是一个标量数据，它的分布符合卡方分布。
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename NIS-01.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
卡尔曼滤波属于动态递归的最优化算法，协方差矩阵在算法里面起着核心作用。所以对于卡尔曼滤波器当前的质量状态，可以通过对当前的协方差矩阵状态进行判断。具体就是使用新
息向量和新息协方差计算马氏距离进行判断。我们可以设置一个门限(gate)，比如
\begin_inset Formula $5$
\end_inset

，代表着
\begin_inset Formula $\pm5$
\end_inset

倍的标准差，根据常识，
\begin_inset Formula $\pm3$
\end_inset

倍的标准差已经包含
\begin_inset Formula $99.7\%$
\end_inset

的数据，因此如果新息的马氏距离超过门限则说明该测量值已不可信，我们就称其为离群值(Outlier)。
\end_layout

\begin_layout Standard
因为在卡尔曼滤波器中，协方差矩阵是由新息驱动而动态变化的。因为统计学上杠杆效应问题，距离概率中心越远的离群值，对协方差矩阵的影响越大。如果频繁发生马氏距离超过门
限的事件，则说明或者是测量值或者是协方差矩阵质量出现了问题。
\end_layout

\begin_layout Standard
PX4/ECL项目采用一种更直观的度量，即测试率(test ratio)，以表示各个输入测量值的质量状况。测试率将测量向量的各维数据拆开单独计算
 NIS，用比率直观判断该维数据的质量，其中新息协方差矩阵
\begin_inset Formula $\boldsymbol{S}$
\end_inset

中的相应对角项元素称为该维数据的新息方差(因为非对角项对扩散无影响)：
\begin_inset Formula 
\begin{align*}
\tilde{\boldsymbol{y}}_{k} & =\boldsymbol{z}_{k}-h\left(\hat{\boldsymbol{x}}_{k\mid k-1}\right)\\
\boldsymbol{S}_{k} & =\boldsymbol{H}_{k}\boldsymbol{P}_{k\mid k-1}\boldsymbol{H}_{k}^{{\rm T}}+\boldsymbol{R}_{k}\\
\sigma_{i}^{2} & =\boldsymbol{S}\left(i,i\right)\\
\mathrm{test\_ratio}_{i} & =\tilde{y}_{i}^{2}/\left(\mathrm{gate}\cdot\sigma_{i}\right)^{2}
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
当
\begin_inset Formula $\mathrm{test\_ratio}_{i}>1$
\end_inset

，则我们判断该维的数据已经超过标准差的门限倍数，比如我们设置
\begin_inset Formula $\mathrm{gate}=3$
\end_inset

，则我们认为该维数据已经超出
\begin_inset Formula $\pm3$
\end_inset

倍的标准差的范围。
\end_layout

\begin_layout Standard
传感器测量值新息的门限大小列表如下：
\end_layout

\begin_layout Itemize

\family typewriter
baro_innov_gate = 5.0
\family default
 : 气压和GPS高度新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
gps_pos_innov_gate = 5.0
\family default
 : GPS水平位置新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
gps_vel_innov_gate = 5.0
\family default
 : GPS速度新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
heading_innov_gate = 2.6
\family default
 : 航向融合新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
mag_innov_gate = 3.0
\family default
 : 磁力计融合新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
mag_acc_gate = 0.5
\family default
 : 当处于自动选择模式时，当机动加速度低于此值(
\begin_inset Formula $m/s^{2}$
\end_inset

)时，将使用航向融合 
\end_layout

\begin_layout Itemize

\family typewriter
mag_yaw_rate_gate = 0.25
\family default
 : 模式选择逻辑使用的偏航率阈值(
\begin_inset Formula $\mathrm{rad}/s$
\end_inset

)
\end_layout

\begin_layout Itemize

\family typewriter
tas_innov_gate = 5.0
\family default
 : 真实空速新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
beta_innov_gate = 5.0
\family default
 : 标准偏差下的合成侧滑新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
range_innov_gate = 5.0
\family default
 : 测距仪融合新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
range_aid_innov_gate = 1.0
\family default
 : 用于距离辅助融合新息一致性检查的门限大小
\end_layout

\begin_layout Itemize

\family typewriter
range_kin_consistency_gate = 1.0
\family default
 : 测距仪运动一致性检查使用的门限大小
\end_layout

\begin_layout Itemize

\family typewriter
ev_vel_innov_gate = 3.0
\family default
 : 视觉速度融合新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
ev_pos_innov_gate = 5.0
\family default
 : 视觉位置融合新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
flow_innov_gate = 3.0
\family default
 : 光流融合新息一致性门限大小(STD)
\end_layout

\begin_layout Itemize

\family typewriter
auxvel_gate = 5.0
\family default
 : 辅助速度融合新息一致性门限大小(STD)
\end_layout

\begin_layout Standard
\begin_inset Phantom Phantom
status open

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
在ECL估计系统中的测试率列表如下：
\end_layout

\begin_layout Itemize

\family typewriter
yaw_test_ratio
\family default
 : 偏航角新息与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
mag_test_ratio
\family default
 : 最大磁力计新息分量与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
vel_test_ratio
\family default
 : 最大速度新息分量与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
pos_test_ratio
\family default
 : 最大水平位置新息分量与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
hgt_test_ratio
\family default
 : 垂直位置新息与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
tas_test_ratio
\family default
 : 真实空速新息与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
hagl_test_ratio
\family default
 : 距地高度新息与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
beta_test_ratio
\family default
 : 合成侧滑新息与新息测试极限的比率。
\end_layout

\begin_layout Itemize

\family typewriter
innov_test_ratio
\family default
 : 标准化新息平方(NIS)测试率。
\end_layout

\begin_layout Itemize

\family typewriter
combined_test_ratio
\family default
 : 组合测试率，是速度和位置平均测试率和高度测试率的最大值，
\family typewriter

\begin_inset Newline newline
\end_inset

max((vel_test_ratio + pos_test_ratio) / 2, hgt_test_ratio
\family default
)
\end_layout

\begin_layout Itemize

\family typewriter
relative_test_ratio
\family default
 : 相对测试率，在多实例EKF中与当前实例的组合测试率有最大差值的测试率
\begin_inset Newline newline
\end_inset


\family typewriter
combined_test_ratio[i] - combined_test_ratio[selected]
\end_layout

\begin_layout Section
偏航角数据的管理
\begin_inset CommandInset label
LatexCommand label
name "sec:偏航角数据的管理"

\end_inset


\end_layout

\begin_layout Standard
在ECL估计系统中，偏航角的数据源有 3 种：
\end_layout

\begin_layout Enumerate
具有双天线的GPS，算法参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS的偏航角融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
外部视觉 (EV)，算法参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:外部视觉融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
磁力计，算法参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:磁力计融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Standard
在同一时刻只能使用其中一种，这个顺序也是内部选择的优先级。软件根据传感器的数据质量、数据连续性，以及偏航新息测试率(
\family typewriter
yaw_test_ratio
\family default
)进行掉落选择。其中对于GPS的数据质量检查得最多，因为其最重要。但是因为成本的原因，在大多数情况下，飞行器只有磁力计这一个易受外界干扰的偏航角数据源。例如，地
面磁场异常足以影响磁力计，当飞行器飞离地面一定高度后(
\begin_inset Formula $1.5\ m$
\end_inset

)，需要重置偏航角，以便从地面磁干扰中恢复。
\end_layout

\begin_layout Section
水平面数据的管理
\begin_inset CommandInset label
LatexCommand label
name "sec:水平面数据的管理"

\end_inset


\end_layout

\begin_layout Standard
在ECL估计系统中，水平面的数据源有 4 种：
\end_layout

\begin_layout Enumerate
GPS提供
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

和
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

，算法参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS速度和水平位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
光流提供水平面的速度
\begin_inset Formula $V_{N}$
\end_inset

和
\begin_inset Formula $V_{E}$
\end_inset

，算法参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:光流测量序列融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
外部视觉提供
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

和
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

，算法参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:外部视觉融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节。
\end_layout

\begin_layout Enumerate
风场提供
\begin_inset Formula $V_{wind_{N}}$
\end_inset

和
\begin_inset Formula $V_{wind_{E}}$
\end_inset

，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:空速融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节，以及相关的合成侧滑
\begin_inset Formula $\mathrm{beta}$
\end_inset

，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

节。
\end_layout

\begin_layout Standard
前3种数据源可以同时使用以校正水平面的速度与位置。因为估计风速的误差太大，所以只有在前3种数据源不可用的情况下，才会使用第 4 种数据源，这时ECL估计系统进入
风场航位推算模式，如果连风速数据都没有，则会进入水平航位推算模式，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:惯性航位推算"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章的讨论。软件根据速度新息测试率(
\family typewriter
vel_test_ratio
\family default
)和位置新息测试率(
\family typewriter
pos_test_ratio
\family default
)判断水平面数据的质量状况。
\end_layout

\begin_layout Section
高度数据的管理
\begin_inset CommandInset label
LatexCommand label
name "sec:高度数据的管理"

\end_inset


\end_layout

\begin_layout Standard
因为高度数据源较多，且基准不一样，偏差不一样，所以需要进行统一管理，以去除测量高度的偏差，并在相同规范下计算出高度新息和新息方差，再交由24-EKF估计出最优高
度值。
\end_layout

\begin_layout Standard
在24-EKF的状态向量中，
\begin_inset Formula $\boldsymbol{P}_{NED}=\left[\begin{array}{ccc}
P_{N} & P_{E} & P_{D}\end{array}\right]^{\mathrm{T}}$
\end_inset

表示机体在 NED 坐标系中的位置，其中
\begin_inset Formula $P_{D}$
\end_inset

为机体相对于海平面的高差，即负的海拔高度。注意，在 NED 坐标系中，
\begin_inset Formula $z$
\end_inset

轴向下为正。而高度传感器的测量值经过处理后，统一得到的是海拔高度，其中，虽然测距仪测量得到的是距地高度，但加上第 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:地形高差估计的EKF方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 章维护的地形高度，仍然可以得到海拔高度，测量数据都是
\begin_inset Formula $z$
\end_inset

轴向上为正。因此，在ECL估计系统中有如下的高度数据关系：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Graphics
	filename height_frame.pdf
	scale 90

\end_inset


\end_layout

\begin_layout Standard
高度偏差估计器是一个标准卡尔曼滤波器，高度偏差
\begin_inset Formula $H_{bias}=P_{D}+H_{meas}$
\end_inset

用一维标准卡尔曼滤波算法进行最优估计，然后计算去除偏差的测量值
\begin_inset Formula $H_{true}$
\end_inset


\begin_inset Formula 
\[
H_{true}=\begin{cases}
-\left(H_{meas}-H_{bias}\right) & \text{for baro/GPS}\\
-\left(H_{meas}^{agl}-H_{bias}\right) & \text{for EV/range}
\end{cases}
\]

\end_inset

将其交由24-EKF对
\begin_inset Formula $P_{D}$
\end_inset

进行最优估计。另外，因为气压测量的不稳定，其测量值用一个
\begin_inset Formula $\alpha$
\end_inset

低通过滤器进行平滑处理，其中
\begin_inset Formula $\alpha=0.1$
\end_inset

，代表着在最小
\begin_inset Formula $5~\mathrm{Hz}$
\end_inset

的采样时间内，高度不会有太大的变化。后面两节内容将讨论高度偏差估计器的设计和应用。
\end_layout

\begin_layout Subsection
单状态偏差估计器
\end_layout

\begin_layout Standard
此处的偏差(bias)，指的是高度传感器测量值相对于
\begin_inset Formula $P_{D}$
\end_inset

的偏移(offset)。我们假定机体在短时间内，即在最小
\begin_inset Formula $5~\mathrm{Hz}$
\end_inset

的采样率下，偏差没有大的变化，因此采用固定模型，并且认为偏差由噪声驱动。
\end_layout

\begin_layout Standard
对于单状态偏差
\begin_inset Formula $x$
\end_inset

的演化方程为：
\begin_inset Formula 
\begin{align*}
x_{k+1} & =Fx_{k}+v_{k}\\
y_{k} & =x_{k}+w_{k}
\end{align*}

\end_inset

其中，噪声
\begin_inset Formula $v_{k}\sim\mathcal{N}\left(0,Q_{k}\right),w_{k}\sim\mathcal{N}\left(0,R_{k}\right)$
\end_inset

。因为该状态由噪声驱动，则状态转换矩阵
\begin_inset Formula $F=1$
\end_inset

。
\end_layout

\begin_layout Standard
在时间更新阶段，因为状态为固定模型，因此只预测状态协方差。我们有过程噪声标准差，即过程噪声谱密度(process noise spectral
 density, nsd)，其平方为过程噪声方差，即状态过程平方谱密度(state process power spectral density,
 psd) 
\begin_inset Formula $Q$
\end_inset

，
\begin_inset Formula $m^{2}/s^{2}/\mathrm{Hz}$
\end_inset

，我们需要求当前时刻的状态不确定性方差(state uncertainty variance) 
\begin_inset Formula $P$
\end_inset

，
\begin_inset Formula $m^{2}$
\end_inset

：
\begin_inset Formula 
\begin{align*}
P_{k|k-1} & =P_{k-1|k-1}+G\cdot Q\cdot\mathrm{d}t\\
 & =P_{k-1|k-1}+G\cdot\mathrm{nsd}^{2}\cdot\mathrm{d}t
\end{align*}

\end_inset

其中，
\begin_inset Formula $G$
\end_inset

为激励增益，在正常情况下，
\begin_inset Formula $G=1$
\end_inset

，当新息序列检查时检测到有大的状态偏差，增大过程噪声，
\begin_inset Formula $G=1000$
\end_inset

，直到消除状态偏差。其判断标准是，如果新息的平均值在统计上过大，
\begin_inset Formula $\left|\mathrm{signed\_innov\_test\_ratio}\right|>0.2$
\end_inset

，或者新息的正负符号在一段时间内(
\begin_inset Formula $10\ s$
\end_inset

)始终相同，则估计值存在大的偏差。
\end_layout

\begin_layout Standard
在测量更新阶段，有测量值
\begin_inset Formula $z$
\end_inset

，因为高度是直接观测，所以观测矩阵
\begin_inset Formula $H=1$
\end_inset

。首先计算新息方差
\begin_inset Formula 
\[
S=P+R
\]

\end_inset

计算新息
\begin_inset Formula 
\[
\tilde{y}=z-x
\]

\end_inset

计算卡尔曼增益
\begin_inset Formula 
\[
K=P/S
\]

\end_inset

计算标准化新息平方测试率
\begin_inset Formula 
\[
\mathrm{innov\_test\_ratio}=\tilde{y}^{2}/\left(\mathrm{gate}^{2}\cdot S\right)
\]

\end_inset

其中新息门限
\begin_inset Formula $\mathrm{gate}=3$
\end_inset

。当新息测试率
\begin_inset Formula $\mathrm{innov\_test\_ratio}<1$
\end_inset

时，继续执行卡尔曼滤波的后面两个步骤，否则将该离群的测量值剔除。更新状态值为
\begin_inset Formula 
\[
x=x+K\cdot\tilde{y}
\]

\end_inset

更新状态不确定性方差
\begin_inset Formula 
\[
P=P-K\cdot P
\]

\end_inset

最后检查新息序列以在下一个迭代中检测状态偏差情况。其算法是，我们用低通滤波统计带正负符号的新息测试率
\begin_inset Formula $\mathrm{signed\_innov\_test\_ratio}=\mathrm{sign}\left(\tilde{y}\right)\cdot\mathrm{innov\_test\_ratio}$
\end_inset

的值，正常情况下应该是一段时间内正负符号均匀出现(连续出现同一种符号的时间
\begin_inset Formula $t<10~s$
\end_inset

)，均值趋向零。如果不符合条件，则说明状态出现大的偏差，在下次迭代时，加大过程噪声方差。
\end_layout

\begin_layout Subsection
高度估计器的应用
\end_layout

\begin_layout Standard
高度数据源比较多，有4种：
\end_layout

\begin_layout Enumerate
气压计(baro)提供海拔高度。
\end_layout

\begin_layout Enumerate
GPS提供海拔高度。
\end_layout

\begin_layout Enumerate
外部视觉(EV)提供距地高度。
\end_layout

\begin_layout Enumerate
测距仪(range)提供距地高度。
\end_layout

\begin_layout Standard
同一时刻只能使用其中一种。在ECL系统内部切换数据源的算法有点复杂。
\end_layout

\begin_layout Standard
首先定义有以下高度传感器类型：
\end_layout

\begin_layout Enumerate

\family typewriter
BARO
\end_layout

\begin_layout Enumerate

\family typewriter
GNSS
\end_layout

\begin_layout Enumerate

\family typewriter
RANGE
\end_layout

\begin_layout Enumerate

\family typewriter
EV
\end_layout

\begin_layout Enumerate

\family typewriter
UNKNOWN
\end_layout

\begin_layout Standard
并为前4种实际的传感器创立4个单状态偏差估计器实例，每个实例保存自己的类型ID，并维护一个
\family typewriter
bool active
\family default
状态。并且在ECL内部定义使用高度传感器类型的两个参考变量：
\end_layout

\begin_layout Itemize

\family typewriter
_params.height_sensor_ref : 
\family default
用户指定的第一优先级高度传感器，也代表不同的高度传感器选择优先级。
\end_layout

\begin_layout Itemize

\family typewriter
_height_sensor_ref : 
\family default
如果该变量数值与上面相同，则代表第一优先级的高度传感器当前已被激活。如果该值为
\family typewriter
UNKNOWN
\family default
，则代表第一优先级高度传感器失效，估计器现在正在使用更低优先级的高度传感器。
\end_layout

\begin_layout Standard
选择优先级的列表如下：
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="6">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
BARO 1st
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
GNSS 1st 
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RANGE 1st
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EV 1st
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
UNKNOWN 1st
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
BARO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
GNSS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RANGE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EV
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
GNSS
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
GNSS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
BARO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EV
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RANGE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
BARO
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EV
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EV
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
BARO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
BARO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EV
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RANGE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RANGE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
GNSS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
GNSS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RANGE
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
所谓第一优先级高度传感器(
\family typewriter
sensor_id == _params.height_sensor_ref
\family default
)，因其测量值已经直接进入24-EKF中计算高度新息及其方差，所以需要在其偏差估计器实例中旁路1-KF的计算。而其它实例在被激活后(
\family typewriter
active = true
\family default
)，使用标准卡尔曼滤波器对高度偏差进行最优估计。最后，软件通过高度新息测试率(
\family typewriter
hgt_test_ratio
\family default
)或距地高度新息测试率(
\family typewriter
hagl_test_ratio
\family default
)发现高度数据源的故障，并根据上述优先级选择下一个高度数据源。并且高度数据的标准化新息平方测试率(
\family typewriter
innov_test_ratio
\family default
)与加速计的削波统计数据配合，还可以发现加速计在
\begin_inset Formula $z$
\end_inset

轴上的故障。
\end_layout

\begin_layout Standard
值得注意的是，对于多旋翼无人机，当其降落并使用气压作为高度数据源时，因旋翼与地面相互作用引起的正静态压力瞬变，会引起高度估计出现较大波动，其表现为产生负的垂直位
置新息(地效气压升高，则海拔虚假升高，因为NED坐标系
\begin_inset Formula $z$
\end_inset

轴向下为正，所以出现负的新息)。为补偿这种效应，需要在降落小于一定高度时，激活地面效应补偿，该高度一般设置为
\begin_inset Formula $0.5\ m$
\end_inset

，应用于负的气压新息的地面效应死区为
\begin_inset Formula $5\ m$
\end_inset

。
\end_layout

\begin_layout Section
估计器多实例的管理
\begin_inset CommandInset label
LatexCommand label
name "sec:估计器多实例的管理"

\end_inset


\end_layout

\begin_layout Standard
为了容错，很多飞行器会有两个IMU，甚至会有两个磁力计。在以前的应用里，一个在工作一个在备份，这实际上是一种浪费。如今可以根据IMU和磁力计的数量以及自动驾驶仪
的CPU能力，可以运行多个24-EKF实例，将IMU和磁力计的数据交叉输入以计算估计值。通过每个24-EKF实例使用不同的传感器组合，提供了一系列更广泛的传感器
错误的保护。 通过比较每个24-EKF实例的内部一致性，EKF选择器能够确定具有最佳数据一致性的24-EKF和传感器组合。 这样可以检测和隔离IMU偏差、饱和或
数据卡顿等故障。
\end_layout

\begin_layout Standard
24-EKF实例总数是由 
\family typewriter
EKF2_MULTI_IMU
\family default
 和 
\family typewriter
EKF2_MULTI_MAG
\family default
 所选择的IMU数量和磁力计数量的乘积，由以下公式给出：
\end_layout

\begin_layout Standard

\family typewriter
N_instances = MAX(EKF2_MULTI_IMU , 1) x MAX(EKF2_MULTI_MAG , 1)
\end_layout

\begin_layout Standard
可处理的IMU或磁力计传感器的最大数量为每种传感器有
\begin_inset Formula $4$
\end_inset

个，因此理论上最大有 
\begin_inset Formula $4\times4=16$
\end_inset

 个24-EKF实例。 实际上，这种做法受到现有计算资源的限制。 在开发这一功能的过程中，使用基于STM32F7的硬件的CPU进行测试，结果显示
 
\begin_inset Formula $4$
\end_inset

 个24-EKF实例具有可接受的处理负载和内存利用率裕度。
\end_layout

\begin_layout Standard
判断和选择当前工作的24-EKF实例的方法是为每一个实例维护两个新息测试率：组合测试率(
\family typewriter
combined_test_ratio
\family default
)和相对测试率(
\family typewriter
relative_test_ratio
\family default
)，其中，前者是速度和位置平均测试率和高度测试率的最大值，后者是在多实例EKF中与当前实例的组合测试率有最大差值的测试率。通过前者，我们可以知道各个24-EKF
实例的质量状况，通过后者，我们可以知道最佳候选实例。当最佳候选实例超过
\begin_inset Formula $10\ s$
\end_inset

稳定好于当前工作实例，则将其切换为当前工作实例。这样，外部用户就可以得到连续且稳定的最佳估计值。
\end_layout

\begin_layout Section
GPS的应用
\end_layout

\begin_layout Standard
在ECL估计系统中，GPS有着非常重要且特殊的地位。在这里，GPS有三种应用：一是在主要的24-EKF中校正状态向量；二是计算纬度/经度点之间的距离、方位角(b
earing)；三是配合全球地磁观测网站提供纬度/经度点的磁偏角测量值。第一种用途已经在前面详细讨论，后面简略讨论后两种的算法。
\end_layout

\begin_layout Subsection
计算纬度/经度点之间的距离与方位角
\begin_inset CommandInset label
LatexCommand label
name "subsec:计算纬度/经度点之间的距离与方位角"

\end_inset


\end_layout

\begin_layout Standard
因为人体的高度和视野相对于巨大的地球而言十分渺小，于是我们就误以为我们所处的大地是一个平面，但其实地球是一个近似圆球的橢球体。在一般的短距离的应用中，我们把地球
近似为平均半径
\begin_inset Formula $r=6371\ km$
\end_inset

的理想圆球。在这个假设中，ECL选择方位等距投影(Azimuthal Equidistant Projection)方式计算纬度/经度点之间的距离与方位角。
\end_layout

\begin_layout Standard
方位投影(Azimuthal Projection)是一种地图投影，其上所有点的方位都相对于中心正确显示。与地球两极之一相切的平面是极方位投影的基础。对于方位投
影，“天顶(zenithal)”一词是一个更古老的术语。方位投影最显著的特征是在图上测量的从中心到任意一点的距离是真实的。因而，地图上以投影中心为圆心的圆在真实
地球上与投影中心是等距离的。同时，从中心出发的任意方向也是真实的。该投影常用于展示多个地理位置与指定点的距离图。
\end_layout

\begin_layout Standard
方位等距投影(
\begin_inset CommandInset href
LatexCommand href
name "Azimuthal Equidistant Projection"
target "http://mathworld.wolfram.com/AzimuthalEquidistantProjection.html"
literal "false"

\end_inset

)是一种面积既不相等(equal-area)也不共形(conformal)的方位投影。等距方位投影可以保留距中心点的距离和方向。等距方位投影是假想球面与平面相切
，有极方位投影、赤道投影和斜轴投影三种，分别是：切于极点为正轴，切于赤道为横轴，切于极点和赤道之间的任意点为斜轴。经纬线形式同一般方位投影，只是在中央经线上纬线
间隔相等。其特点是：由切点至任一方向的距离同实地相符；最大角度和面积变形均为以切点为圆心的同心圆。这种投影常用于半球图，交通图等。
\end_layout

\begin_layout Standard
ECL采用的是局部方位等距投影(Local Azimuthal Equidistant Projection)，也就是斜轴投影。其直觉与我们应用李群和李代数的关
系类似，在这里进行的是地理坐标系统(geographic coordinate system)和方位等距平面(azimuthal equidistant
 plane)之间的变换。我们以飞行器当前点为切点/原点建立局部水平面，亦称局部方位等距平面(local azimuthal equidistant
 plane)。在局部水平面中，从原点出发的射线都是等距，射线的方位角保真，我们在此向量空间中进行向量计算，计算出到达下一个航路点(waypoint)的距离与方
位角，然后收回到球面上，就得到下一个航路点的纬度/经度，或者是反过来计算，将下一航路点的纬度/经度展开到当前水平面中，由此计算飞行距离与方位角。到达下一个航路点
后，我们再在这个航路点上建立新的局部水平面，并做下一步的计算。
\end_layout

\begin_layout Standard
\begin_inset CommandInset href
LatexCommand href
name "计算纬度/经度点之间的距离与方位角"
target "http://www.movable-type.co.uk/scripts/latlong.html"
literal "false"

\end_inset

的算法很古老也很成熟，其中还涉及到
\begin_inset CommandInset href
LatexCommand href
name "基于向量的大地测量学"
target "http://www.movable-type.co.uk/scripts/latlong-vectors.html"
literal "false"

\end_inset

知识。感兴趣的读者可以查看相关的书籍和网站。
\end_layout

\begin_layout Subsection
提供纬度/经度点的磁偏角
\begin_inset CommandInset label
LatexCommand label
name "subsec:提供纬度/经度点的磁偏角"

\end_inset


\end_layout

\begin_layout Standard
这里的算法十分简单，就是从开发和分发地球磁场模型的
\begin_inset CommandInset href
LatexCommand href
name "网站"
target "https://www.ngdc.noaa.gov/geomag/"
literal "false"

\end_inset

获取地磁数据档案，建立查询表格。然后根据当前的纬度/经度，查询表格，获取当前点的磁偏角的测量值
\begin_inset Formula $\psi^{DECLINATION}$
\end_inset

，将其提供给24-EKF进行方位校正。参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:综合偏差测量的融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的内容。另外，双天线GPS可以提供航向角的测量值
\begin_inset Formula $\psi_{meas}$
\end_inset

，参见第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:GPS的偏航角融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节的内容。
\end_layout

\begin_layout Standard
完整的地磁数据档案可以取得当前点的磁偏角(magnetic declination)、磁顷角(magnetic inclination)、磁强度(magneti
c strength)，我们由此使用理论磁场向量的知识来计算合成磁场
\begin_inset Formula $z$
\end_inset

轴的分量值。如果传感器测量中存在大量干扰，我们可以用此
\begin_inset Formula $z$
\end_inset

轴理论值替换现场测量的
\begin_inset Formula $z$
\end_inset

轴的数值以合成磁场测量值，这对于在第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:磁力计融合"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“磁力计融合”中的算法抗磁场干扰会非常有用。注意此时需要将
\begin_inset Formula $z$
\end_inset

轴的新息和协方差设置为
\begin_inset Formula $0$
\end_inset

。
\end_layout

\begin_layout Section
惯性航位推算
\begin_inset CommandInset label
LatexCommand label
name "sec:惯性航位推算"

\end_inset


\end_layout

\begin_layout Standard
航位推算(dead reckoning)指的是无天文观测辅助导航，或者是基于很少或没有信息的位置估计。在ECL的估计系统中，当GPS类的全局定位数据不可用的情况
下，24-EKF仅使用惯性数据进行航位推算，并且大多执行的是水平惯性航位推算(horizontal inertial dead reckoning)。这是因为存
在磁力计就可以校正姿态，存在气压计或测距仪就可以校正
\begin_inset Formula $z$
\end_inset

轴高度，但是只有GPS类的全局定位数据，才能校正飞行器水平面的位置。当全局定位数据丢失或误差过大，则ECL估计系统就进入航位推算模式。
\end_layout

\begin_layout Standard
能够提供水平面的位置与速度校正的数据源如下：
\end_layout

\begin_layout Enumerate
GPS提供
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

和
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

。
\end_layout

\begin_layout Enumerate
光流提供水平面的速度
\begin_inset Formula $V_{N}$
\end_inset

和
\begin_inset Formula $V_{E}$
\end_inset

。
\end_layout

\begin_layout Enumerate
外部视觉提供
\begin_inset Formula $\boldsymbol{P}_{NED}$
\end_inset

和
\begin_inset Formula $\boldsymbol{V}_{NED}$
\end_inset

。
\end_layout

\begin_layout Enumerate
风场提供
\begin_inset Formula $V_{wind_{N}}$
\end_inset

和
\begin_inset Formula $V_{wind_{E}}$
\end_inset

，以及相关的合成侧滑
\begin_inset Formula $\mathrm{beta}$
\end_inset

。
\end_layout

\begin_layout Standard
例如，如果存在光流则可以校正北/东方向速度，从而间接校正了水平面的增量位移，因此ECL估计系统不会进入航位推算模式。注意，只有前3种的数据源完全可信，可以校正水
平面位置，而风场速度因为误差太大，只能是部分可信。
\end_layout

\begin_layout Standard
在没有上述前3种数据源的情况下，航位推算模式还分为两种级别。第一种是存在水平风场数据，则进入风场航位推算(wind dead reckoning)模式，此时可以
用水平风场向量校正北/东方向速度，从而间接校正了水平面的增量位移，这是第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:空速融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“空速融合方程”和第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:合成侧滑融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“合成侧滑融合方程”的内容。第二种是连水平风场向量都没有的情况下，则是完全的水平惯性航位推算。
\end_layout

\begin_layout Standard
基于惯性的航位推算，根据经验，水平面位置的估计值，大约最长有
\begin_inset Formula $5\sim10\ s$
\end_inset

的有效期。所以在ECL估计系统中，设置
\begin_inset Formula $5\ s$
\end_inset

的有效期阈值，并且超过
\begin_inset Formula $7\ s$
\end_inset

就将状态向量中的水平位置、高度和速度重置。并且估计系统还将使用第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:虚拟位置融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“虚拟位置融合方程”和第 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:虚拟高度融合方程"
plural "false"
caps "false"
noprefix "false"

\end_inset

 节“虚拟高度融合方程”的算法以约束惯性导航系统的状态漂移。
\end_layout

\begin_layout Section
总结
\end_layout

\begin_layout Standard
ECL EKF 算法最大的特点就是使用传感器组合进行状态估计。这使得系统具有很高的容错性，即对传感器故障的容忍度，但也使得算法具有更大的复杂度。但是在代码里，更
多的代码是对数据和协方差矩阵质量判断，并对上下限进行钳制处理，发现异常后更换数据源的处理。这些方法和经验数据，是多年的经验积累，是在一个个项目中一点点地磨炼出来
的经验总结。这才是 ECL EKF 模块最有价值的地方，因为主要算法可以在短时间内掌握，而这些知识只有靠时间来积淀。
\end_layout

\begin_layout Standard
不过 ECL EKF 算法也有值得探讨的地方。数学上已经清楚，旋转(包括四元数和旋转矩阵)不可以直接用卡尔曼滤波器进行估计，因为旋转是群而不是向量，而卡尔曼滤波
器里面最核心的概念
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

协方差
\begin_inset Formula $\,$
\end_inset

—
\begin_inset Formula $\,$
\end_inset

只能处理向量。因此直接把四元数放入卡尔曼滤波器中计算，估计的是四元数而不是旋转。
\end_layout

\begin_layout Standard
此外，对比误差状态EKF算法，就会发现这里的 Jacobian 矩阵展开后十分复杂，只要涉及旋转(包括四元数和旋转矩阵)的方程的 Jacobian
 矩阵都很复杂，并且难以解释。而在误差状态EKF算法中，误差大多在零点附近抖动，因此有较好的近线性特性，因此 Jacobian 矩阵和标准的KF的矩阵很类似，因
此计算速度会快一些，理论上精度也会高一些，并且容易解释。
\end_layout

\begin_layout Standard
但是，ECL EKF 模块已经在广大的产品和项目里得到验证，不论是在模拟器里还是在实际环境中，它的计算速度和精度都经受了检验。对此只能说卡尔曼滤波器真是一个很神
奇的东西，在工程中实用为上。
\end_layout

\begin_layout Section
参考文献
\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4: Estimation & Control Library for Guidance, Navigation and Control Applications - EKF"
target "https://github.com/PX4/ecl/tree/master/EKF"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 - EKF - documentation"
target "https://github.com/PX4/ecl/tree/master/EKF/documentation"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 - EKF - python code"
target "https://github.com/PX4/PX4-ECL/tree/master/EKF/python"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 - EKF - matlab code"
target "https://github.com/PX4/PX4-ECL/tree/master/EKF/matlab"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Using the ECL EKF"
target "https://docs.px4.io/en/advanced_config/tuning_the_ecl_ekf.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "EKF2 Estimation System"
target "https://ardupilot.org/dev/docs/ekf2-estimation-system.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Extended Kalman Filter Navigation Overview and Tuning"
target "https://ardupilot.org/dev/docs/extended-kalman-filter.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Extended Kalman Filter (EKF)"
target "https://ardupilot.org/copter/docs/common-apm-navigation-extended-kalman-filter-overview.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "NavEKF Change Overview 2020"
target "http://manual.cuav.net/ardupilot2020/EKF%20update.pptx"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 State Estimation 2021 Update"
target "https://px4.io/wp-content/uploads/2020/07/Paul-Riseborough-PX4-state-estimation-update.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Extended Kalman Filter"
target "https://ahrs.readthedocs.io/en/latest/filters/ekf.html"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "Recursive Attitude Estimation in the Presence of Multi-rate and Multi-delay Vector Measurements"
target "http://users.cecs.anu.edu.au/~trumpf/pubs/khosravian_trumpf_mahony_hamel_ACC2015.pdf"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 的 ECL EKF 公式推导及代码解析"
target "https://blog.csdn.net/u010307048/article/details/100553475"
literal "false"

\end_inset


\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "PX4 InertialNAV Filter 与 EKF2概论"
target "https://blog.csdn.net/westlovehehe/article/details/54754943"
literal "false"

\end_inset


\end_layout

\end_body
\end_document
